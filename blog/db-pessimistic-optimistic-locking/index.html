<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Deep Dive into Database Pessimistic &amp; Optimistic Locking | Ashish Rathod</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://arathod02.github.io/docs/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://arathod02.github.io/docs/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://arathod02.github.io/docs/blog/db-pessimistic-optimistic-locking"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Deep Dive into Database Pessimistic &amp; Optimistic Locking | Ashish Rathod"><meta data-rh="true" name="description" content="In distributed systems, managing access to shared resources is one of the most critical challenges we face. When multiple processes or threads attempt to modify the same data simultaneously, we risk race conditions that can corrupt the system&#x27;s state."><meta data-rh="true" property="og:description" content="In distributed systems, managing access to shared resources is one of the most critical challenges we face. When multiple processes or threads attempt to modify the same data simultaneously, we risk race conditions that can corrupt the system&#x27;s state."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-12-27T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://www.linkedin.com/in/ashish-rathod02/"><link data-rh="true" rel="icon" href="/docs/img/favicon.jpg"><link data-rh="true" rel="canonical" href="https://arathod02.github.io/docs/blog/db-pessimistic-optimistic-locking"><link data-rh="true" rel="alternate" href="https://arathod02.github.io/docs/blog/db-pessimistic-optimistic-locking" hreflang="en"><link data-rh="true" rel="alternate" href="https://arathod02.github.io/docs/blog/db-pessimistic-optimistic-locking" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://arathod02.github.io/docs/blog/db-pessimistic-optimistic-locking","mainEntityOfPage":"https://arathod02.github.io/docs/blog/db-pessimistic-optimistic-locking","url":"https://arathod02.github.io/docs/blog/db-pessimistic-optimistic-locking","headline":"Deep Dive into Database Pessimistic & Optimistic Locking","name":"Deep Dive into Database Pessimistic & Optimistic Locking","description":"In distributed systems, managing access to shared resources is one of the most critical challenges we face. When multiple processes or threads attempt to modify the same data simultaneously, we risk race conditions that can corrupt the system's state.","datePublished":"2025-12-27T00:00:00.000Z","author":{"@type":"Person","name":"Ashish Rathod","description":"Ex-Intuit Staff Engineer","url":"https://www.linkedin.com/in/ashish-rathod02/","image":"https://github.com/arathod02.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://arathod02.github.io/docs/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/docs/blog/rss.xml" title="Ashish Rathod RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs/blog/atom.xml" title="Ashish Rathod Atom Feed"><link rel="stylesheet" href="/docs/assets/css/styles.815ca38a.css">
<script src="/docs/assets/js/runtime~main.6ff615b1.js" defer="defer"></script>
<script src="/docs/assets/js/main.9413671d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs/img/favicon.jpg"><link rel="preload" as="image" href="https://github.com/arathod02.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs/"><div class="navbar__logo"><img src="/docs/img/favicon.jpg" alt="Ashish Rathod Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs/img/favicon.jpg" alt="Ashish Rathod Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Ashish Rathod</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/docs/blog/db-pessimistic-optimistic-locking">Deep Dive into Database Pessimistic &amp; Optimistic Locking</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/proxy-server">Database Proxy Servers</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/server-sent-events-explained">Real-Time Communication with Server-Sent Events (SSE)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/application-level-sharding-design">Implementing Shard Aware Application</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/scaling-distributed-systems">Scaling Distributed Systems (Focus on Databases)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/avoid-hard-deletes">The Pains of Hard Delete</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/cache-stampede-thundering-herd">The Thundering Herd - Understanding and Solving the Cache Stampede</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/transformer-architecture">The Transformer Architecture</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/offline-online-indicator">Presence Service</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Deep Dive into Database Pessimistic &amp; Optimistic Locking</h1><div class="container_mt6G margin-vert--md"><time datetime="2025-12-27T00:00:00.000Z">December 27, 2025</time> · <!-- -->14 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/docs/blog/authors/ashish"><img class="avatar__photo authorImage_XqGP" src="https://github.com/arathod02.png" alt="Ashish Rathod"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/docs/blog/authors/ashish"><span class="authorName_yefp" translate="no">Ashish Rathod</span></a></div><small class="authorTitle_nd0D" title="Ex-Intuit Staff Engineer">Ex-Intuit Staff Engineer</small><div class="authorSocials_rSDt"><a href="https://www.linkedin.com/in/ashish-rathod02/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" style="--dark:#0a66c2;--light:#ffffffe6" class="authorSocialIcon_XYv3 linkedinSvg_FCgI"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453"></path></svg></a><a href="https://github.com/arathod02" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>In distributed systems, managing access to shared resources is one of the most critical challenges we face. When multiple processes or threads attempt to modify the same data simultaneously, we risk race conditions that can corrupt the system&#x27;s state.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="pessimistic-locking">Pessimistic Locking<a href="#pessimistic-locking" class="hash-link" aria-label="Direct link to Pessimistic Locking" title="Direct link to Pessimistic Locking" translate="no">​</a></h2>
<p>It is a mechanism where we assume a conflict will occur and lock the data before operating on it. We will dive into MySQL&#x27;s locking mechanisms, deadlock detection, and analyze a Python simulation to see these locks in action.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-what-are-locks-and-why-do-we-need-them">1. What are Locks and Why Do We Need Them?<a href="#1-what-are-locks-and-why-do-we-need-them" class="hash-link" aria-label="Direct link to 1. What are Locks and Why Do We Need Them?" title="Direct link to 1. What are Locks and Why Do We Need Them?" translate="no">​</a></h2>
<p>At its core, a database is the &quot;Source of Truth&quot; for an application. If this source becomes corrupted, the entire integrity of the system collapses.</p>
<p>In a concurrent environment (like a web server handling thousands of requests), multiple transactions often try to access and modify the same database row at the exact same millisecond. Without protection, we encounter the <strong>Lost Update Problem</strong>:</p>
<ol>
<li class="">Transaction A reads a value (e.g., <code>seats_available = 1</code>).</li>
<li class="">Transaction B reads the same value (<code>seats_available = 1</code>).</li>
<li class="">Transaction A updates the value to 0.</li>
<li class="">Transaction B <em>also</em> updates the value to 0.</li>
</ol>
<p>Both transactions believe they successfully reserved the last seat, but the database is now in an inconsistent state.</p>
<p><strong>Pessimistic Locking</strong> solves this by preventing other transactions from modifying (and often reading) the data until the lock holder is finished. It enforces a strict &quot;I was here first&quot; policy, ensuring that the shared resource is mutually exclusive during the critical section of the update.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-the-downside-deadlocks">2. The Downside: Deadlocks<a href="#2-the-downside-deadlocks" class="hash-link" aria-label="Direct link to 2. The Downside: Deadlocks" title="Direct link to 2. The Downside: Deadlocks" translate="no">​</a></h2>
<p>While locks protect data, they introduce a new danger: <strong>Deadlocks</strong>.</p>
<p>A deadlock occurs when two or more transactions are waiting for one another to give up locks, resulting in a cycle where no one can proceed.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="deadlock-detection-in-mysql-innodb">Deadlock Detection in MySQL (InnoDB)<a href="#deadlock-detection-in-mysql-innodb" class="hash-link" aria-label="Direct link to Deadlock Detection in MySQL (InnoDB)" title="Direct link to Deadlock Detection in MySQL (InnoDB)" translate="no">​</a></h3>
<p>Modern storage engines have sophisticated deadlock detection mechanisms. They maintain a <strong>Wait-For Graph</strong> (a directed graph) where nodes are transactions and edges represent one transaction waiting for a lock held by another.</p>
<ul>
<li class="">If the graph contains a <strong>cycle</strong>, a deadlock exists.</li>
<li class="">DB immediately detects this cycle.</li>
<li class="">It resolves the deadlock by kills one of the transactions (usually the one that has done the least amount of work) to allow the other to proceed.</li>
</ul>
<p><strong>The Error:</strong>
When MySQL kills a transaction to break a deadlock, it throws the following error:</p>
<blockquote>
<p><code>ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</code></p>
</blockquote>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="visualizing-the-deadlock-graph">Visualizing the Deadlock Graph<a href="#visualizing-the-deadlock-graph" class="hash-link" aria-label="Direct link to Visualizing the Deadlock Graph" title="Direct link to Visualizing the Deadlock Graph" translate="no">​</a></h3>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-acquiring-locks-in-mysql">3. Acquiring Locks in MySQL<a href="#3-acquiring-locks-in-mysql" class="hash-link" aria-label="Direct link to 3. Acquiring Locks in MySQL" title="Direct link to 3. Acquiring Locks in MySQL" translate="no">​</a></h2>
<p>MySQL provides specific syntax to interact with row-level locking during a <code>SELECT</code> statement.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="for-update"><code>FOR UPDATE</code><a href="#for-update" class="hash-link" aria-label="Direct link to for-update" title="Direct link to for-update" translate="no">​</a></h3>
<p>This is the standard pessimistic lock. It tells the database: <em>&quot;I intend to update these rows. Lock them exclusively. If anyone else has them locked, I will wait until they are released.&quot;</em></p>
<ul>
<li class=""><strong>Behavior:</strong> Blocks if the row is already locked.</li>
<li class=""><strong>Use Case:</strong> Strict consistency where processing order matters or where you must update specific rows.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="nowait"><code>NOWAIT</code><a href="#nowait" class="hash-link" aria-label="Direct link to nowait" title="Direct link to nowait" translate="no">​</a></h3>
<p>This tells the database: <em>&quot;I want to lock these rows. If they are already locked, do not make me wait. Fail immediately.&quot;</em></p>
<ul>
<li class=""><strong>Behavior:</strong> Throws an error immediately if the row is locked.</li>
<li class=""><strong>Use Case:</strong> Real-time systems where failing fast is better than queuing.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="skip-locked"><code>SKIP LOCKED</code><a href="#skip-locked" class="hash-link" aria-label="Direct link to skip-locked" title="Direct link to skip-locked" translate="no">​</a></h3>
<p>This is a powerful feature for high-concurrency queues. It tells the database: <em>&quot;I want to lock rows that match my criteria. If some are already locked by others, just skip them and give me the next available ones.&quot;</em></p>
<ul>
<li class=""><strong>Behavior:</strong> Does not wait; simply ignores locked rows and returns the free ones.</li>
<li class=""><strong>Use Case:</strong> Ticket booking, job queues, task distribution.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="locking-visualization">Locking Visualization<a href="#locking-visualization" class="hash-link" aria-label="Direct link to Locking Visualization" title="Direct link to Locking Visualization" translate="no">​</a></h4>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-code-walkthrough--scenario-analysis">4. Code Walkthrough &amp; Scenario Analysis<a href="#4-code-walkthrough--scenario-analysis" class="hash-link" aria-label="Direct link to 4. Code Walkthrough &amp; Scenario Analysis" title="Direct link to 4. Code Walkthrough &amp; Scenario Analysis" translate="no">​</a></h2>
<p>I created a Python script to simulate a high-concurrency seat reservation system. The script spawns multiple threads, where each thread attempts to:</p>
<ol>
<li class="">Start a transaction.</li>
<li class="">Find an available seat (<code>user_id IS NULL</code>).</li>
<li class="">Book it (<code>UPDATE seats SET user_id...</code>).</li>
<li class="">Commit.</li>
</ol>
<p>Let&#x27;s analyze the behavior under three different locking strategies.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="scenario-1-without-for-update">Scenario 1: WITHOUT &quot;FOR UPDATE&quot;<a href="#scenario-1-without-for-update" class="hash-link" aria-label="Direct link to Scenario 1: WITHOUT &quot;FOR UPDATE&quot;" title="Direct link to Scenario 1: WITHOUT &quot;FOR UPDATE&quot;" translate="no">​</a></h3>
<p><strong>Observation:</strong> The number of reserved seats is <strong>highly non-deterministic</strong> and almost always less than the number of threads.</p>
<p><strong>Why? (The Race Condition)</strong>
This is a classic &quot;Check-Then-Act&quot; race condition.</p>
<ol>
<li class=""><strong>Thread Scheduling:</strong> The OS schedules Thread A and Thread B to run almost simultaneously on different CPU cores.</li>
<li class=""><strong>Snapshot Isolation:</strong> Thread A runs <code>SELECT</code> and sees Seat #1 is empty. Before Thread A can run the <code>UPDATE</code> statement, the OS context switches or simply executes Thread B in parallel.</li>
<li class=""><strong>Duplicate Reads:</strong> Thread B runs the same <code>SELECT</code> and <em>also</em> sees Seat #1 is empty (because A hasn&#x27;t committed yet).</li>
<li class=""><strong>The Overwrite:</strong> Thread A updates Seat #1 and commits. Thread B updates Seat #1 (overwriting A&#x27;s work) and commits.</li>
<li class=""><strong>Result:</strong> Two threads think they booked a seat, but only one record exists in the DB. One reservation is effectively &quot;lost.&quot;</li>
</ol>
<!-- -->
<div class="language-info codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-info codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:38:55,400 - MainThread - INFO - SEAT RESERVATION SYSTEM - COMPLETED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:38:55,400 - MainThread - INFO - ================================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:38:55,400 - MainThread - INFO - Threads requested: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:38:55,400 - MainThread - INFO - Seats created: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:38:55,400 - MainThread - INFO - Seats reserved: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:38:55,400 - MainThread - INFO - Execution time: 7 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:38:55,400 - MainThread - INFO - ================================================================================</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="scenario-2-with-for-update">Scenario 2: WITH &quot;FOR UPDATE&quot;<a href="#scenario-2-with-for-update" class="hash-link" aria-label="Direct link to Scenario 2: WITH &quot;FOR UPDATE&quot;" title="Direct link to Scenario 2: WITH &quot;FOR UPDATE&quot;" translate="no">​</a></h3>
<p><strong>Observation:</strong> The number of reserved seats <strong>always equals</strong> the total number of seats (up to the thread limit). Consistency is maintained.</p>
<p><strong>Why? (Blocking &amp; Re-evaluation)</strong>
When Thread A runs <code>SELECT ... FOR UPDATE</code>, the database locks that specific row (Seat #1).</p>
<ol>
<li class=""><strong>The Block:</strong> If Thread B tries to select Seat #1, the DB forces it to <strong>wait</strong>.</li>
<li class=""><strong>The Re-evaluation:</strong> Once Thread A commits, it releases the lock. Thread B wakes up.</li>
<li class=""><strong>The Loop/Retry:</strong> When Thread B acquires the lock, it sees the <em>latest</em> committed data. It realizes Seat #1 is now taken (user_id is NOT NULL), so it must restart the search or move to the next available row.</li>
</ol>
<p>This serialization ensures that no two threads can ever &quot;win&quot; the same seat.</p>
<!-- -->
<div class="language-info codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-info codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:43:25,625 - MainThread - INFO - SEAT RESERVATION SYSTEM - COMPLETED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:43:25,625 - MainThread - INFO - ================================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:43:25,625 - MainThread - INFO - Threads requested: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:43:25,625 - MainThread - INFO - Seats created: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:43:25,625 - MainThread - INFO - Seats reserved: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:43:25,625 - MainThread - INFO - Execution time: 25 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:43:25,625 - MainThread - INFO - ================================================================================</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="scenario-3-with-for-update-skip-locked">Scenario 3: WITH &quot;FOR UPDATE SKIP LOCKED&quot;<a href="#scenario-3-with-for-update-skip-locked" class="hash-link" aria-label="Direct link to Scenario 3: WITH &quot;FOR UPDATE SKIP LOCKED&quot;" title="Direct link to Scenario 3: WITH &quot;FOR UPDATE SKIP LOCKED&quot;" translate="no">​</a></h3>
<p><strong>Observation:</strong> The number of seats reserved is correct (consistent), but the <strong>total execution time is significantly lower</strong> than Scenario 2.</p>
<p><strong>Why? (Concurrency without Contention)</strong>
This is the gold standard for job queues or booking systems.</p>
<ol>
<li class=""><strong>No Waiting:</strong> Thread A grabs Seat #1. Thread B comes in, sees Seat #1 is locked, and <em>instantly</em> skips it to grab Seat #2.</li>
<li class=""><strong>Parallelism:</strong> Because threads don&#x27;t wait for each other, they can utilize the full connection pool simultaneously.</li>
<li class=""><strong>Result:</strong> If you have 10 threads, you reserve 10 seats in roughly the time it takes to reserve 1 seat, rather than the time it takes to reserve 10 seats sequentially.</li>
</ol>
<div class="language-info codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-info codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:47:55,625 - MainThread - INFO - SEAT RESERVATION SYSTEM - COMPLETED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:47:55,625 - MainThread - INFO - ================================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:47:55,625 - MainThread - INFO - Threads requested: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:47:55,625 - MainThread - INFO - Seats created: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:47:55,625 - MainThread - INFO - Seats reserved: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:47:55,625 - MainThread - INFO - Execution time: 9.71 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:47:55,625 - MainThread - INFO - ================================================================================</span><br></span></code></pre></div></div>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="code-reference">Code Reference<a href="#code-reference" class="hash-link" aria-label="Direct link to Code Reference" title="Direct link to Code Reference" translate="no">​</a></h2>
<p>Here is the Python script used for this simulation:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">reserve_seat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">thread_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Get a connection from the pool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        conn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> connection_pool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_connection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cursor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cursor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> (User </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">user_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">): Starting seat reservation&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Start transaction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">start_transaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">: Transaction started&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Select an unreserved seat (user_id is NULL) with FOR UPDATE to lock the row</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># NOTE: Change &#x27;FOR UPDATE SKIP LOCKED&#x27; to &#x27;FOR UPDATE&#x27; or remove it to test different scenarios</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        select_query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SELECT id, seat_number FROM seats WHERE user_id IS NULL AND trip = %s LIMIT 1 FOR UPDATE SKIP LOCKED&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cursor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">select_query</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;TRIP_001&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        seat </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fetchone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> seat</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            seat_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> seat_number </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> seat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> (User </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">user_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">): Found available seat #</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">seat_number</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Update the seat with user_id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            update_query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;UPDATE seats SET user_id = %s WHERE id = %s&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cursor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">update_query</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> seat_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Commit the transaction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> (User </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">user_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">): Successfully reserved seat #</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">seat_number</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> (User </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">user_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">): No available seats found&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cursor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Error </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> (User </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">user_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">): Error during seat reservation: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> conn </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_connected</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rollback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">: Transaction rolled back&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Error </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> rollback_error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">: Error during rollback: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">rollback_error</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">finally</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> conn </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_connected</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ... (Main execution logic)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="optmimistic-locking-the-non-blocking-alternative">Optmimistic Locking: The Non-Blocking Alternative<a href="#optmimistic-locking-the-non-blocking-alternative" class="hash-link" aria-label="Direct link to Optmimistic Locking: The Non-Blocking Alternative" title="Direct link to Optmimistic Locking: The Non-Blocking Alternative" translate="no">​</a></h2>
<p><strong>Optimistic Locking</strong> offers an alternative strategy. Instead of locking the door before you enter, you assume the door is unlocked, do your work, and check if anyone else locked it only when you are leaving.</p>
<p>Optimistic locking is a strategy where you read a record, take note of a version number, and check that version number again only when you write the changes back.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="optimistic-vs-pessimistic">Optimistic vs. Pessimistic<a href="#optimistic-vs-pessimistic" class="hash-link" aria-label="Direct link to Optimistic vs. Pessimistic" title="Direct link to Optimistic vs. Pessimistic" translate="no">​</a></h3>
<ul>
<li class=""><strong>Pessimistic Locking:</strong> Assumes the worst. &quot;Something bad will happen, so I will lock this row as soon as I select it (<code>SELECT ... FOR UPDATE</code>). No one else can touch it until I&#x27;m done.&quot;</li>
<li class=""><strong>Optimistic Locking:</strong> Assumes the best. &quot;It&#x27;s unlikely anyone else will modify this row while I&#x27;m working on it. I won&#x27;t lock anything during the read. I will only check for conflicts when I attempt to update.&quot;</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-implementation-the-version_number">The Implementation: The <code>version_number</code><a href="#the-implementation-the-version_number" class="hash-link" aria-label="Direct link to the-implementation-the-version_number" title="Direct link to the-implementation-the-version_number" translate="no">​</a></h3>
<p>The standard way to implement optimistic locking is by adding a column to your table, usually named <code>version</code> or <code>revision</code>.</p>
<ol>
<li class=""><strong>Read:</strong> When you read a row, you also read the current <code>version</code> (e.g., 1).</li>
<li class=""><strong>Modify:</strong> You perform your logic in the application layer.</li>
<li class=""><strong>Update:</strong> When you send the update query, you add a <code>WHERE</code> clause checking if the <code>version</code> is still 1. You also increment the version.</li>
</ol>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Step 1: Read the data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> version </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> wiki_pages </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">101</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Result: version = 5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- ... Application logic happens here ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Step 2: Update with guard clause</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> wiki_pages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;New Content&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">101</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Crucial Check!</span><br></span></code></pre></div></div>
<p><strong>The Outcome:</strong></p>
<ul>
<li class="">If the database returns <strong>1 row affected</strong>, the update succeeded.</li>
<li class="">If the database returns <strong>0 rows affected</strong>, it means someone else changed the <code>version</code> to 6 (or higher) while you were working. Your transaction fails, and you must handle the conflict (usually by retrying).</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="when-to-use-the-case-for-non-contention">When to Use: The Case for Non-Contention<a href="#when-to-use-the-case-for-non-contention" class="hash-link" aria-label="Direct link to When to Use: The Case for Non-Contention" title="Direct link to When to Use: The Case for Non-Contention" translate="no">​</a></h2>
<p>Optimistic locking shines in scenarios of <strong>Low Contention</strong>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="high-contention-vs-low-contention">High Contention vs. Low Contention<a href="#high-contention-vs-low-contention" class="hash-link" aria-label="Direct link to High Contention vs. Low Contention" title="Direct link to High Contention vs. Low Contention" translate="no">​</a></h3>
<ul>
<li class=""><strong>High Contention (Use Pessimistic):</strong> Imagine a limited drop of 10 concert tickets with 10,000 users trying to buy them instantly. If you use optimistic locking here, 1 person succeeds, and 9,999 users fail and have to retry. Those retries hammer the database. Pessimistic locking is better here to queue the requests.</li>
<li class=""><strong>Low Contention (Use Optimistic):</strong> Imagine a user updating their profile bio or editing a specific wiki page. The chances of two admins editing the exact same paragraph at the exact same second are very low.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-benefits-zero-locking-overhead">The Benefits: Zero Locking Overhead<a href="#the-benefits-zero-locking-overhead" class="hash-link" aria-label="Direct link to The Benefits: Zero Locking Overhead" title="Direct link to The Benefits: Zero Locking Overhead" translate="no">​</a></h2>
<p>The primary benefit of optimistic locking is that it is <strong>lock-free during the &quot;think time&quot;</strong>.</p>
<p>In a Pessimistic setup, the database holds a lock from the moment you run <code>SELECT ... FOR UPDATE</code> until you <code>COMMIT</code>. If your application server is slow, or if the user is taking time to fill out a form, that database row is frozen. No one can read it.</p>
<p>With Optimistic locking:</p>
<ol>
<li class=""><strong>High Concurrency:</strong> Threads or users are never blocked during the read phase.</li>
<li class=""><strong>Scalability:</strong> Because there are no long-held locks, the database doesn&#x27;t have to maintain a heavy lock graph or check for deadlocks.</li>
<li class=""><strong>No Deadlocks:</strong> Since you aren&#x27;t holding resources while waiting for others, the classic deadlock scenarios (A waits for B, B waits for A) are virtually eliminated in the application logic.</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-downsides-latency-and-retries">The Downsides: Latency and Retries<a href="#the-downsides-latency-and-retries" class="hash-link" aria-label="Direct link to The Downsides: Latency and Retries" title="Direct link to The Downsides: Latency and Retries" translate="no">​</a></h2>
<p>While &quot;lock-free&quot; sounds perfect, Optimistic locking introduces its own penalties, particularly when conflicts <em>do</em> occur.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="a-the-read-modify-write-latency">A) The &quot;Read-Modify-Write&quot; Latency<a href="#a-the-read-modify-write-latency" class="hash-link" aria-label="Direct link to A) The &quot;Read-Modify-Write&quot; Latency" title="Direct link to A) The &quot;Read-Modify-Write&quot; Latency" translate="no">​</a></h3>
<p>Optimistic locking strictly requires a round-trip pattern:</p>
<ol>
<li class="">Network Call 1: Fetch data (Read version).</li>
<li class="">App Logic: Compute.</li>
<li class="">Network Call 2: Update data.</li>
</ol>
<p>You cannot simply fire a &quot;blind write&quot; to the database. You must know the state before you change it. This adds network latency compared to simple &quot;fire and forget&quot; updates.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="b-the-cost-of-retries">B) The Cost of Retries<a href="#b-the-cost-of-retries" class="hash-link" aria-label="Direct link to B) The Cost of Retries" title="Direct link to B) The Cost of Retries" translate="no">​</a></h3>
<p>This is the most significant hidden cost. When an optimistic lock fails (returns 0 rows updated), the application cannot simply crash; it must <strong>Retry</strong>.</p>
<p>A retry loop looks like this:</p>
<ol>
<li class="">Read Data (Latency).</li>
<li class="">Compute (CPU).</li>
<li class="">Update Fails.</li>
<li class=""><strong>Repeat Step 1.</strong></li>
</ol>
<p>If you have a system with moderate contention, you might do this loop 3 or 4 times before succeeding. This wastes:</p>
<ul>
<li class=""><strong>DB IO:</strong> Reading the same row multiple times.</li>
<li class=""><strong>App CPU:</strong> Recalculating the logic multiple times.</li>
<li class=""><strong>Network Bandwidth:</strong> Sending the same data back and forth.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-conclusion-why-non-contention-is-key">5. Conclusion: Why Non-Contention is Key<a href="#5-conclusion-why-non-contention-is-key" class="hash-link" aria-label="Direct link to 5. Conclusion: Why Non-Contention is Key" title="Direct link to 5. Conclusion: Why Non-Contention is Key" translate="no">​</a></h2>
<p>Given the penalties of retrying, <strong>Optimistic Locking should only be used when you expect the update to succeed 95% to 99% of the time.</strong></p>
<p>If your system expects frequent collisions, the cost of retrying (thrashing) will outweigh the cost of simply queuing users with a Pessimistic Lock. However, for the vast majority of web applications (CMS, User Profiles, E-commerce carts, Comments), actual data collisions are rare, making Optimistic Locking the most performant and scalable choice.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/pessimistic-lock.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/docs/blog/proxy-server"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Scaling Databases with Proxy Servers</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#pessimistic-locking" class="table-of-contents__link toc-highlight">Pessimistic Locking</a></li><li><a href="#1-what-are-locks-and-why-do-we-need-them" class="table-of-contents__link toc-highlight">1. What are Locks and Why Do We Need Them?</a></li><li><a href="#2-the-downside-deadlocks" class="table-of-contents__link toc-highlight">2. The Downside: Deadlocks</a><ul><li><a href="#deadlock-detection-in-mysql-innodb" class="table-of-contents__link toc-highlight">Deadlock Detection in MySQL (InnoDB)</a></li><li><a href="#visualizing-the-deadlock-graph" class="table-of-contents__link toc-highlight">Visualizing the Deadlock Graph</a></li></ul></li><li><a href="#3-acquiring-locks-in-mysql" class="table-of-contents__link toc-highlight">3. Acquiring Locks in MySQL</a><ul><li><a href="#for-update" class="table-of-contents__link toc-highlight"><code>FOR UPDATE</code></a></li><li><a href="#nowait" class="table-of-contents__link toc-highlight"><code>NOWAIT</code></a></li><li><a href="#skip-locked" class="table-of-contents__link toc-highlight"><code>SKIP LOCKED</code></a></li></ul></li><li><a href="#4-code-walkthrough--scenario-analysis" class="table-of-contents__link toc-highlight">4. Code Walkthrough &amp; Scenario Analysis</a><ul><li><a href="#scenario-1-without-for-update" class="table-of-contents__link toc-highlight">Scenario 1: WITHOUT &quot;FOR UPDATE&quot;</a></li><li><a href="#scenario-2-with-for-update" class="table-of-contents__link toc-highlight">Scenario 2: WITH &quot;FOR UPDATE&quot;</a></li><li><a href="#scenario-3-with-for-update-skip-locked" class="table-of-contents__link toc-highlight">Scenario 3: WITH &quot;FOR UPDATE SKIP LOCKED&quot;</a></li></ul></li><li><a href="#code-reference" class="table-of-contents__link toc-highlight">Code Reference</a></li><li><a href="#optmimistic-locking-the-non-blocking-alternative" class="table-of-contents__link toc-highlight">Optmimistic Locking: The Non-Blocking Alternative</a><ul><li><a href="#optimistic-vs-pessimistic" class="table-of-contents__link toc-highlight">Optimistic vs. Pessimistic</a></li><li><a href="#the-implementation-the-version_number" class="table-of-contents__link toc-highlight">The Implementation: The <code>version_number</code></a></li></ul></li><li><a href="#when-to-use-the-case-for-non-contention" class="table-of-contents__link toc-highlight">When to Use: The Case for Non-Contention</a><ul><li><a href="#high-contention-vs-low-contention" class="table-of-contents__link toc-highlight">High Contention vs. Low Contention</a></li></ul></li><li><a href="#the-benefits-zero-locking-overhead" class="table-of-contents__link toc-highlight">The Benefits: Zero Locking Overhead</a></li><li><a href="#the-downsides-latency-and-retries" class="table-of-contents__link toc-highlight">The Downsides: Latency and Retries</a><ul><li><a href="#a-the-read-modify-write-latency" class="table-of-contents__link toc-highlight">A) The &quot;Read-Modify-Write&quot; Latency</a></li><li><a href="#b-the-cost-of-retries" class="table-of-contents__link toc-highlight">B) The Cost of Retries</a></li></ul></li><li><a href="#5-conclusion-why-non-contention-is-key" class="table-of-contents__link toc-highlight">5. Conclusion: Why Non-Contention is Key</a></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"></div></footer></div>
</body>
</html>