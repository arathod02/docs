<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Blog | Ashish Rathod</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://arathod02.github.io/docs/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://arathod02.github.io/docs/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://arathod02.github.io/docs/blog"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Blog | Ashish Rathod"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/docs/img/favicon.jpg"><link data-rh="true" rel="canonical" href="https://arathod02.github.io/docs/blog"><link data-rh="true" rel="alternate" href="https://arathod02.github.io/docs/blog" hreflang="en"><link data-rh="true" rel="alternate" href="https://arathod02.github.io/docs/blog" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"Blog","@id":"https://arathod02.github.io/docs/blog","mainEntityOfPage":"https://arathod02.github.io/docs/blog","headline":"Blog","description":"Blog","blogPost":[{"@type":"BlogPosting","@id":"https://arathod02.github.io/docs/blog/load-balancer-design","mainEntityOfPage":"https://arathod02.github.io/docs/blog/load-balancer-design","url":"https://arathod02.github.io/docs/blog/load-balancer-design","headline":"Designing L7 Load Balancer","name":"Designing L7 Load Balancer","description":"In this series, we will evolve the design of a Layer 7 Load Balancer (LB) from scratch. We won't just look at how to build it, but why we make specific architectural choices at every fork in the road.","datePublished":"2025-12-30T00:00:00.000Z","author":{"@type":"Person","name":"Ashish Rathod","description":"Ex-Intuit Staff Engineer","url":"https://www.linkedin.com/in/ashish-rathod02/","image":"https://github.com/arathod02.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://arathod02.github.io/docs/blog/concurrent-replace","mainEntityOfPage":"https://arathod02.github.io/docs/blog/concurrent-replace","url":"https://arathod02.github.io/docs/blog/concurrent-replace","headline":"Avoid \"REPLACE INTO\"","name":"Avoid \"REPLACE INTO\"","description":"In distributed systems, Upsert (Update or Insert) is a fundamental operation. You want to store a record: if it exists, update it; if not, create it.","datePublished":"2025-12-29T00:00:00.000Z","author":{"@type":"Person","name":"Ashish Rathod","description":"Ex-Intuit Staff Engineer","url":"https://www.linkedin.com/in/ashish-rathod02/","image":"https://github.com/arathod02.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://arathod02.github.io/docs/blog/slack-design","mainEntityOfPage":"https://arathod02.github.io/docs/blog/slack-design","url":"https://arathod02.github.io/docs/blog/slack-design","headline":"Designing Slack's Realtime Communication System","name":"Designing Slack's Realtime Communication System","description":"In this post, we will deep dive into the architecture of an enterprise-grade realtime communication system like Slack. We will categorize different communication patterns, design the database schema for performance, and evolve the system architecture from a simple REST service to a scalable, distributed websocket cluster.","datePublished":"2025-12-29T00:00:00.000Z","author":{"@type":"Person","name":"Ashish Rathod","description":"Ex-Intuit Staff Engineer","url":"https://www.linkedin.com/in/ashish-rathod02/","image":"https://github.com/arathod02.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://arathod02.github.io/docs/blog/distributed-key-value-store","mainEntityOfPage":"https://arathod02.github.io/docs/blog/distributed-key-value-store","url":"https://arathod02.github.io/docs/blog/distributed-key-value-store","headline":"Distributed Key-Value Store","name":"Distributed Key-Value Store","description":"In this post, we will walk through the journey of designing and implementing a horizontally scalable Key-Value store. We will start from a basic implementation, iterate through schema designs, optimize for performance, and finally scale it to handle massive loads.","datePublished":"2025-12-28T00:00:00.000Z","author":{"@type":"Person","name":"Ashish Rathod","description":"Ex-Intuit Staff Engineer","url":"https://www.linkedin.com/in/ashish-rathod02/","image":"https://github.com/arathod02.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://arathod02.github.io/docs/blog/db-pessimistic-optimistic-locking","mainEntityOfPage":"https://arathod02.github.io/docs/blog/db-pessimistic-optimistic-locking","url":"https://arathod02.github.io/docs/blog/db-pessimistic-optimistic-locking","headline":"Deep Dive into Database Pessimistic & Optimistic Locking","name":"Deep Dive into Database Pessimistic & Optimistic Locking","description":"In distributed systems, managing access to shared resources is one of the most critical challenges we face. When multiple processes or threads attempt to modify the same data simultaneously, we risk race conditions that can corrupt the system's state.","datePublished":"2025-12-27T00:00:00.000Z","author":{"@type":"Person","name":"Ashish Rathod","description":"Ex-Intuit Staff Engineer","url":"https://www.linkedin.com/in/ashish-rathod02/","image":"https://github.com/arathod02.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://arathod02.github.io/docs/blog/proxy-server","mainEntityOfPage":"https://arathod02.github.io/docs/blog/proxy-server","url":"https://arathod02.github.io/docs/blog/proxy-server","headline":"Scaling Databases with Proxy Servers","name":"Scaling Databases with Proxy Servers","description":"In the complex landscape of distributed systems, direct communication between clients and backend resources is often inefficient or insecure. Enter the Proxy Server—an intermediary that sits between the end-user clients and the resources they intend to browse or access.","datePublished":"2025-12-25T00:00:00.000Z","author":{"@type":"Person","name":"Ashish Rathod","description":"Ex-Intuit Staff Engineer","url":"https://www.linkedin.com/in/ashish-rathod02/","image":"https://github.com/arathod02.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://arathod02.github.io/docs/blog/server-sent-events-explained","mainEntityOfPage":"https://arathod02.github.io/docs/blog/server-sent-events-explained","url":"https://arathod02.github.io/docs/blog/server-sent-events-explained","headline":"Real-Time Communication with Server-Sent Events (SSE)","name":"Real-Time Communication with Server-Sent Events (SSE)","description":"A deep dive into Server-Sent Events, their use cases, protocol details, and a practical Python implementation.","datePublished":"2025-12-25T00:00:00.000Z","author":{"@type":"Person","name":"Ashish Rathod","description":"Ex-Intuit Staff Engineer","url":"https://www.linkedin.com/in/ashish-rathod02/","image":"https://github.com/arathod02.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://arathod02.github.io/docs/blog/application-level-sharding-design","mainEntityOfPage":"https://arathod02.github.io/docs/blog/application-level-sharding-design","url":"https://arathod02.github.io/docs/blog/application-level-sharding-design","headline":"Implementing Shard Aware Application","name":"Implementing Shard Aware Application","description":"In my previous post, we explored the high-level strategies for scaling databases, touching upon vertical scaling, read replicas, and finally, sharding. Today, I want to double-click on Sharding, specifically focusing on the Application-Level Sharding strategy.","datePublished":"2025-12-14T00:00:00.000Z","author":{"@type":"Person","name":"Ashish Rathod","description":"Ex-Intuit Staff Engineer","url":"https://www.linkedin.com/in/ashish-rathod02/","image":"https://github.com/arathod02.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://arathod02.github.io/docs/blog/scaling-distributed-systems","mainEntityOfPage":"https://arathod02.github.io/docs/blog/scaling-distributed-systems","url":"https://arathod02.github.io/docs/blog/scaling-distributed-systems","headline":"Scaling Distributed Systems (Focus on Databases)","name":"Scaling Distributed Systems (Focus on Databases)","description":"In distributed systems, the four possible chokepoints that a system can run into are CPU, Memory, Network, and Disk. Whenever the system hits the thresholds on any of these chokepoints, latency increases, throughput degrades, and we typically need to scale our systems.","datePublished":"2025-12-13T00:00:00.000Z","author":{"@type":"Person","name":"Ashish Rathod","description":"Ex-Intuit Staff Engineer","url":"https://www.linkedin.com/in/ashish-rathod02/","image":"https://github.com/arathod02.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://arathod02.github.io/docs/blog/avoid-hard-deletes","mainEntityOfPage":"https://arathod02.github.io/docs/blog/avoid-hard-deletes","url":"https://arathod02.github.io/docs/blog/avoid-hard-deletes","headline":"A Deep Dive into Database Storage Engines and Soft Deletion Strategies.","name":"A Deep Dive into Database Storage Engines and Soft Deletion Strategies.","description":"A Deep Dive into Database Storage Engines and Soft Deletion Strategies.","datePublished":"2025-12-11T12:26:27.000Z","author":{"@type":"Person","name":"Ashish Rathod","description":"Ex-Intuit Staff Engineer","url":"https://www.linkedin.com/in/ashish-rathod02/","image":"https://github.com/arathod02.png"},"keywords":[]}]}</script><link rel="alternate" type="application/rss+xml" href="/docs/blog/rss.xml" title="Ashish Rathod RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs/blog/atom.xml" title="Ashish Rathod Atom Feed"><link rel="stylesheet" href="/docs/assets/css/styles.aade1aad.css">
<script src="/docs/assets/js/runtime~main.2307e74a.js" defer="defer"></script>
<script src="/docs/assets/js/main.4a3975e2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/docs/img/favicon.jpg"><link rel="preload" as="image" href="https://github.com/arathod02.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs/"><div class="navbar__logo"><img src="/docs/img/favicon.jpg" alt="Ashish Rathod Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/docs/img/favicon.jpg" alt="Ashish Rathod Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Ashish Rathod</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/load-balancer-design">Designing L7 Load Balancer</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/concurrent-replace">Avoid &quot;REPLACE INTO&quot;</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/slack-design">Slack Architecture</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/distributed-key-value-store">Distributed Key-Value Store</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/db-pessimistic-optimistic-locking">Deep Dive into Database Pessimistic &amp; Optimistic Locking</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/proxy-server">Database Proxy Servers</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/server-sent-events-explained">Real-Time Communication with Server-Sent Events (SSE)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/application-level-sharding-design">Implementing Shard Aware Application</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/scaling-distributed-systems">Scaling Distributed Systems (Focus on Databases)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/avoid-hard-deletes">The Pains of Hard Delete</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/cache-stampede-thundering-herd">The Thundering Herd - Understanding and Solving the Cache Stampede</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/transformer-architecture">The Transformer Architecture</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/docs/blog/offline-online-indicator">Presence Service</a></li></ul></div></nav></aside><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/docs/blog/load-balancer-design">Designing L7 Load Balancer</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-12-30T00:00:00.000Z">December 30, 2025</time> · <!-- -->14 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/docs/blog/authors/ashish"><img class="avatar__photo authorImage_XqGP" src="https://github.com/arathod02.png" alt="Ashish Rathod"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/docs/blog/authors/ashish"><span class="authorName_yefp" translate="no">Ashish Rathod</span></a></div><small class="authorTitle_nd0D" title="Ex-Intuit Staff Engineer">Ex-Intuit Staff Engineer</small><div class="authorSocials_rSDt"><a href="https://www.linkedin.com/in/ashish-rathod02/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" style="--dark:#0a66c2;--light:#ffffffe6" class="authorSocialIcon_XYv3 linkedinSvg_FCgI"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453"></path></svg></a><a href="https://github.com/arathod02" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p>In this series, we will evolve the design of a Layer 7 Load Balancer (LB) from scratch. We won&#x27;t just look at <em>how</em> to build it, but <em>why</em> we make specific architectural choices at every fork in the road.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-define-the-requirements">1) Define the Requirements<a href="#1-define-the-requirements" class="hash-link" aria-label="Direct link to 1) Define the Requirements" title="Direct link to 1) Define the Requirements" translate="no">​</a></h2>
<p>Before writing code, we must define the &quot;must-haves&quot; of our system.</p>
<ul>
<li class=""><strong>Load the Balance:</strong> The core responsibility is distributing incoming network traffic across multiple backend servers to ensure no single server becomes a bottleneck. This maximizes throughput and minimizes response time.</li>
<li class=""><strong>Tunable Algorithm:</strong> We cannot rely on a single distribution strategy. Different workloads require different approaches (e.g., Round Robin for uniform services, Weighted Round Robin for heterogenous capacity, or Least Connections for long-lived sessions).</li>
<li class=""><strong>Scaling beyond single Load Balancer:</strong> The LB itself shouldn&#x27;t become the single point of failure (SPOF) or the bottleneck. We must design for horizontal scalability where we can add more LB nodes dynamically as traffic increases.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-need-of-persistence-for-the-lb-configurations">2) Need of Persistence for the LB Configurations<a href="#2-need-of-persistence-for-the-lb-configurations" class="hash-link" aria-label="Direct link to 2) Need of Persistence for the LB Configurations" title="Direct link to 2) Need of Persistence for the LB Configurations" translate="no">​</a></h2>
<p>Why do we need a database for a load balancer? Can&#x27;t we just hardcode the backend IPs in a config file?</p>
<p>In a modern distributed system, the environment is dynamic. Backend servers auto-scale (scale-out/in), health checks fail, and routing rules change. If we hardcode configurations, every change requires a redeployment of the Load Balancer fleet. This is unacceptable.</p>
<p>We need to decouple the <strong>Control Plane</strong> (Configuration Management) from the <strong>Data Plane</strong> (Traffic Forwarding). Administrators should be able to tune parameters (add backends, change algorithms, update health check paths) via a console, and these changes must persist in a reliable store that the LB instances can read from.</p>
<p><strong>Architecture V1:</strong></p>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2a-need-of-cache-for-the-lb-configurations">2.a) Need of cache for the LB configurations<a href="#2a-need-of-cache-for-the-lb-configurations" class="hash-link" aria-label="Direct link to 2.a) Need of cache for the LB configurations" title="Direct link to 2.a) Need of cache for the LB configurations" translate="no">​</a></h3>
<p>While the architecture above works functionally, it fails non-functionally. If the Load Balancer hits the Configuration DB for <strong>every single request</strong>, we introduce massive latency.</p>
<ul>
<li class=""><strong>Load Balancer Overheads:</strong> The time spent by the LB processing the request before forwarding it.</li>
<li class=""><strong>The Latency Cost:</strong> If a network round-trip to the DB takes 5ms, we are adding 5ms to <em>every</em> user request. In high-throughput systems (100k+ RPS), this also creates a &quot;Thundering Herd&quot; problem that will crush the database.</li>
</ul>
<p><strong>Constraint:</strong> LB overhead must be extremely minimal (sub-millisecond).</p>
<p>To solve this, we introduce an <strong>In-Memory Cache</strong> within the Load Balancer. The LB reads from its local RAM, which is nanosecond-latency fast.</p>
<p><strong>The Data Model (Key-Value):</strong>
We need a simple Key-Value store structure where the key is the LB Group Name and the value is the configuration blob.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token property" style="color:#36acaa">&quot;lb-group-1&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;backend_servers&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;10.0.0.1:80&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10.0.0.2:80&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;health_endpoint&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/health&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;health_endpoint_expected_code&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;health_check_frequency_seconds&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;algorithm&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;WEIGHTED_ROUND_ROBIN&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>However, caching introduces a classic distributed system problem: <strong>Cache Staleness</strong>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2b-how-to-keep-the-cache-in-sync-with-the-configurations-db">2.b) How to keep the cache in sync with the Configurations DB<a href="#2b-how-to-keep-the-cache-in-sync-with-the-configurations-db" class="hash-link" aria-label="Direct link to 2.b) How to keep the cache in sync with the Configurations DB" title="Direct link to 2.b) How to keep the cache in sync with the Configurations DB" translate="no">​</a></h3>
<p>If an admin adds a new backend server to the DB, the LB&#x27;s in-memory cache still holds the old list. We need a sync mechanism.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="option-1-the-pull-approach-polling">Option 1: The PULL Approach (Polling)<a href="#option-1-the-pull-approach-polling" class="hash-link" aria-label="Direct link to Option 1: The PULL Approach (Polling)" title="Direct link to Option 1: The PULL Approach (Polling)" translate="no">​</a></h4>
<p>We run a background cron job on the LB every 10 seconds to fetch the latest config from the DB.</p>
<ul>
<li class=""><strong>The Problem:</strong> There is a &quot;Staleness Window&quot; of up to 10 seconds. If a backend server is removed from the DB because it was corrupted, the LB might still send traffic to it for 10 seconds, causing 5xx errors for users.</li>
<li class=""><strong>Verdict:</strong> Acceptable for low-criticality systems, but &quot;bad product experience&quot; for high-availability requirements.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="option-2-the-push-based-approach">Option 2: The PUSH Based Approach<a href="#option-2-the-push-based-approach" class="hash-link" aria-label="Direct link to Option 2: The PUSH Based Approach" title="Direct link to Option 2: The PUSH Based Approach" translate="no">​</a></h4>
<p>In this model, whenever the Configuration DB is updated, it actively &quot;pushes&quot; a notification to all Load Balancers to invalidate or update their cache immediately.</p>
<ul>
<li class=""><strong>The Advantage:</strong> This minimizes the staleness window to mere milliseconds. The system reacts in near real-time.</li>
<li class=""><strong>Verdict:</strong> Preferred for production-grade Load Balancers.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2c-choice-of-configuration-db">2.c) Choice of Configuration DB<a href="#2c-choice-of-configuration-db" class="hash-link" aria-label="Direct link to 2.c) Choice of Configuration DB" title="Direct link to 2.c) Choice of Configuration DB" translate="no">​</a></h3>
<p>We need a technology that offers <strong>Persistence</strong> (durability) + <strong>Key-Value Lookup</strong> + <strong>Push/Watch Capabilities</strong>.</p>
<p>Let&#x27;s evaluate the options:</p>
<ol>
<li class="">
<p><strong>Kafka:</strong></p>
<ul>
<li class=""><em>Analysis:</em> Kafka is an event streaming platform, not a configuration store. It is fundamentally PULL-based (consumers poll for messages). Using it as a source of truth for current state is an anti-pattern (requires log compaction gymnastics).</li>
<li class=""><em>Verdict:</em> <strong>Reject.</strong></li>
</ul>
</li>
<li class="">
<p><strong>DynamoDB + DynamoDB Streams:</strong></p>
<ul>
<li class=""><em>Analysis:</em> Excellent for persistence and HA. However, DynamoDB Streams require a Lambda or consumer to poll the stream and then fan-out updates. It doesn&#x27;t provide a native &quot;direct-to-client&quot; push channel.</li>
<li class=""><em>Verdict:</em> <strong>Reject</strong> (Too much glue code required).</li>
</ul>
</li>
<li class="">
<p><strong>Redis Pub/Sub:</strong></p>
<ul>
<li class=""><em>Analysis:</em> Redis is a fantastic KV store. Pub/Sub allows the &quot;Control Plane&quot; to publish an update to a channel that all LBs subscribe to.</li>
<li class=""><em>The Risk:</em> Redis Pub/Sub operates on &quot;At-Most-Once&quot; delivery. If an LB node restarts or has a network blip during the publish event, it <strong>misses the message forever</strong>. It has no persistence for the channel messages.</li>
<li class=""><em>High Availability:</em> Redis Sentinel can provide HA, but it is historically tricky to configure correctly to avoid split-brain scenarios. Relying on it for the &quot;source of truth&quot; configuration can be risky without a backup polling mechanism.</li>
<li class=""><em>Verdict:</em> <strong>Good</strong>, but requires a &quot;safety net&quot; (occasional polling).</li>
</ul>
</li>
<li class="">
<p><strong>ZooKeeper (The Winner):</strong></p>
<ul>
<li class=""><em>Analysis:</em> ZooKeeper is explicitly designed for distributed coordination and configuration management.</li>
<li class=""><em>ZNodes:</em> It stores data in file-system-like paths (Key-Value style).</li>
<li class=""><em>Watches (The Push Mechanism):</em> Clients can place a &quot;Watch&quot; on a ZNode. When the data changes, ZooKeeper sends a notification to the client. This is a robust Push mechanism.</li>
<li class=""><em>Consistency:</em> It uses the ZAB (ZooKeeper Atomic Broadcast) protocol, guaranteeing strong consistency.</li>
<li class=""><em>High Availability:</em> Running a ZK Ensemble (3 or 5 nodes) tolerates node failures without data loss.</li>
<li class=""><em>Verdict:</em> <strong>Excellent Fit.</strong> It solves Persistence + Push + HA natively.</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="final-architecture-for-persistence-layer">Final Architecture for Persistence Layer<a href="#final-architecture-for-persistence-layer" class="hash-link" aria-label="Direct link to Final Architecture for Persistence Layer" title="Direct link to Final Architecture for Persistence Layer" translate="no">​</a></h3>
<p>We will use <strong>ZooKeeper</strong> as our configuration source of truth.</p>
<ol>
<li class=""><strong>Control Plane</strong> writes config to ZooKeeper ZNode (<code>/lb-configs/lb-1</code>).</li>
<li class=""><strong>Load Balancers</strong> keep a &quot;Watch&quot; on that ZNode.</li>
<li class=""><strong>Event:</strong> When config changes, ZK notifies all LBs.</li>
<li class=""><strong>Action:</strong> LBs fetch the new data, update their local In-Memory Cache, and re-set the Watch.</li>
</ol>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-need-of-orchestrator-layer-to-monitor-the-health-of-backend-servers">3) Need of Orchestrator layer to monitor the health of backend servers<a href="#3-need-of-orchestrator-layer-to-monitor-the-health-of-backend-servers" class="hash-link" aria-label="Direct link to 3) Need of Orchestrator layer to monitor the health of backend servers" title="Direct link to 3) Need of Orchestrator layer to monitor the health of backend servers" translate="no">​</a></h2>
<p>A Load Balancer is only as good as the servers it points to. If a backend server crashes, gets overloaded, or becomes unresponsive, the Load Balancer must stop sending traffic to it immediately. Without this &quot;circuit breaking&quot; capability, a single failing server can cause a cascade of errors for the end users (502 Bad Gateway), turning a partial outage into a total system failure. The LB needs an intelligent subsystem to actively verify that its destinations are actually capable of handling work.</p>
<p><strong>Enter the Orchestrator.</strong></p>
<p>The Orchestrator acts as the &quot;Health Monitor&quot; of our system. It operates in a continuous loop:</p>
<ol>
<li class=""><strong>Fetch Configuration:</strong> It continually watches the Configuration DB (ZooKeeper) to know which backend servers are supposed to be active and what their health check parameters are (e.g., endpoint <code>/health</code>, interval <code>10s</code>).</li>
<li class=""><strong>Probe:</strong> It actively sends HTTP requests (or TCP pings) to these endpoints on the backend servers.</li>
<li class=""><strong>Decide &amp; Update:</strong> If a server fails to respond with a <code>200 OK</code> for a configured threshold (e.g., 3 consecutive failures), the Orchestrator marks it as &quot;Unhealthy.&quot; It then updates the Configuration DB (ZooKeeper), effectively removing that server from the active rotation. Since our LBs are watching ZooKeeper, they immediately stop routing traffic to the dead node.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="3a-making-the-orchestrator-layer-highly-available">3.a) Making the Orchestrator layer Highly Available<a href="#3a-making-the-orchestrator-layer-highly-available" class="hash-link" aria-label="Direct link to 3.a) Making the Orchestrator layer Highly Available" title="Direct link to 3.a) Making the Orchestrator layer Highly Available" translate="no">​</a></h3>
<p>We cannot rely on a single Orchestrator node. If that single node dies, health checks stop. If health checks stop, the Load Balancers are flying blind—they might route traffic to dead servers (false negatives) or fail to route to recovered servers (false positives).</p>
<p>To solve this, we implement a <strong>Master-Worker Architecture with Leader Election</strong>:</p>
<ul>
<li class=""><strong>Master Node:</strong> Responsible for coordination. It divides the list of backend servers into chunks and assigns them to different Worker nodes to balance the health-checking load.</li>
<li class=""><strong>Worker Nodes:</strong> These are the workhorses. They perform the actual HTTP pings to the backend servers and report status back to the Master or directly to the DB.</li>
<li class=""><strong>Self-Healing &amp; Leader Election:</strong> We leverage <strong>ZooKeeper&#x27;s Ephemeral Nodes</strong> for this. All Orchestrator nodes attempt to create a lock file (ZNode) in ZooKeeper.<!-- -->
<ul>
<li class="">The node that succeeds becomes the <strong>Master</strong>.</li>
<li class="">The others become <strong>Workers</strong> (standby).</li>
<li class="">If the Master process dies, its ephemeral node in ZooKeeper disappears. The Worker nodes detect this event immediately and trigger a new election. One of them promotes itself to Master, ensuring zero downtime for the monitoring subsystem.</li>
</ul>
</li>
</ul>
<p><strong>System State Diagram (So Far):</strong></p>
<!-- -->
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-understanding-scalability-of-the-load-balancer-itself">4) Understanding Scalability of the Load Balancer Itself<a href="#4-understanding-scalability-of-the-load-balancer-itself" class="hash-link" aria-label="Direct link to 4) Understanding Scalability of the Load Balancer Itself" title="Direct link to 4) Understanding Scalability of the Load Balancer Itself" translate="no">​</a></h2>
<p>We have scaled the backends, but what happens when the Load Balancer <em>itself</em> is overwhelmed?</p>
<p>A single LB instance has limits—CPU, Memory, and Network Bandwidth (throughput). To detect this, we inject metrics (active connections, request latency, CPU usage) into a Time-Series Database (like Prometheus or InfluxDB). When thresholds are breached, our Auto-Scaling Group triggers the provision of a new Load Balancer instance.</p>
<p><strong>The Discovery Problem:</strong>
If we add a new Load Balancer (IP: <code>10.0.0.50</code>) to help the existing one (IP: <code>10.0.0.10</code>), how do clients know? Clients typically have the domain <code>api.myblog.com</code> cached to point to <code>10.0.0.10</code>. We cannot put another Load Balancer in front of our Load Balancers, or we just move the bottleneck one layer up (turtles all the way down).</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="routing-requests-amongst-different-lb-servers-via-coredns">Routing Requests amongst different LB servers via CoreDNS<a href="#routing-requests-amongst-different-lb-servers-via-coredns" class="hash-link" aria-label="Direct link to Routing Requests amongst different LB servers via CoreDNS" title="Direct link to Routing Requests amongst different LB servers via CoreDNS" translate="no">​</a></h3>
<p>We solve this using <strong>DNS Load Balancing</strong> with <strong>CoreDNS</strong>.</p>
<p>CoreDNS is a flexible, extensible DNS server that can serve as the entry point for our traffic. Instead of a static mapping, CoreDNS can dynamically return different IP addresses for the same domain name.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-round-robin--weighted-load-balancing">1. Round Robin &amp; Weighted Load Balancing<a href="#1-round-robin--weighted-load-balancing" class="hash-link" aria-label="Direct link to 1. Round Robin &amp; Weighted Load Balancing" title="Direct link to 1. Round Robin &amp; Weighted Load Balancing" translate="no">​</a></h4>
<p>CoreDNS can be configured to return multiple A records (IP addresses) for a single domain. Modern clients (browsers, mobile apps) will try these IPs. We can update these records dynamically as we scale our LB fleet.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-geolocation--latency-routing">2. Geolocation &amp; Latency Routing<a href="#2-geolocation--latency-routing" class="hash-link" aria-label="Direct link to 2. Geolocation &amp; Latency Routing" title="Direct link to 2. Geolocation &amp; Latency Routing" translate="no">​</a></h4>
<p>CoreDNS can utilize plugins (like the <code>geoip</code> plugin) to inspect the source IP of the incoming DNS query.</p>
<ul>
<li class=""><strong>User from India</strong> -&gt; CoreDNS resolves <code>blog.com</code> to the VIP (Virtual IP) of the LB cluster in Mumbai.</li>
<li class=""><strong>User from US</strong> -&gt; CoreDNS resolves <code>blog.com</code> to the VIP of the LB cluster in Virginia.</li>
</ul>
<p><strong>Technical Implementation:</strong>
CoreDNS often uses an <code>etcd</code> backend to store records, allowing for real-time updates without restarting the DNS server. Here is how a <strong>JSON</strong> record for an LB service might look inside the store that CoreDNS reads:</p>
<p><strong>The CoreDNS Configuration (Corefile):</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">. {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    etcd myblog.com {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        path /skydns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        endpoint http://etcd-cluster:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loadbalance round_robin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cache 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>The Data (stored in etcd as JSON):</strong>
This is the &quot;Service Discovery&quot; record. The key path represents the domain, and the value is the target LB.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* Key: /skydns/com/myblog/api/lb1 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;host&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10.0.0.10&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;port&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;priority&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;weight&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;text&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Location: US-East&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/* Key: /skydns/com/myblog/api/lb2 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;host&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10.0.0.50&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;port&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;priority&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;weight&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;text&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Location: US-East&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><em>Note: By adjusting the <code>weight</code> or removing the entry, we control traffic flow to the LBs instantly.</em></p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-making-the-discovery-layer-highly-available">5) Making the Discovery Layer Highly Available<a href="#5-making-the-discovery-layer-highly-available" class="hash-link" aria-label="Direct link to 5) Making the Discovery Layer Highly Available" title="Direct link to 5) Making the Discovery Layer Highly Available" translate="no">​</a></h2>
<p>We have introduced CoreDNS to handle the discovery of our Load Balancers. But we have introduced a new problem: <strong>What if the CoreDNS server itself goes down?</strong></p>
<p>If our DNS layer fails, new clients cannot resolve the domain name to an IP address. Even if our Load Balancers and Backend Servers are healthy, the door to our system is effectively locked.</p>
<p>To solve this, we cannot simply spin up two CoreDNS servers with different IP addresses and hope for the best. Clients typically configure a specific IP (or a limited list) for their DNS resolver. We need a way to have multiple DNS servers &quot;share&quot; a single, highly available IP address.</p>
<p><strong>Enter Keepalived and the Virtual IP (VIP).</strong></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-concept-virtual-ip-vip">The Concept: Virtual IP (VIP)<a href="#the-concept-virtual-ip-vip" class="hash-link" aria-label="Direct link to The Concept: Virtual IP (VIP)" title="Direct link to The Concept: Virtual IP (VIP)" translate="no">​</a></h3>
<p>In standard networking, two machines cannot share the same IP address on the same network segment. If they do, it causes an IP conflict, and switches/routers get confused about where to send packets.</p>
<p>A <strong>Virtual IP (VIP)</strong> is a &quot;floating&quot; IP address that is not permanently bound to a specific physical machine&#x27;s network interface. Instead, it is a resource that can be dynamically claimed by a machine.</p>
<ol>
<li class="">We assign a VIP (e.g., <code>192.168.1.100</code>) to our DNS cluster.</li>
<li class="">Clients are configured to send DNS queries to <code>192.168.1.100</code>.</li>
<li class="">Only the <strong>Master</strong> node currently &quot;holds&quot; this IP.</li>
<li class="">If the Master dies, a <strong>Backup</strong> node detects the failure and immediately &quot;claims&quot; the IP, handling traffic seamlessly.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-solution-keepalived">The Solution: Keepalived<a href="#the-solution-keepalived" class="hash-link" aria-label="Direct link to The Solution: Keepalived" title="Direct link to The Solution: Keepalived" translate="no">​</a></h3>
<p>We use <strong>Keepalived</strong>, a routing software that implements the <strong>VRRP (Virtual Router Redundancy Protocol)</strong>.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="how-vrrp-works">How VRRP Works<a href="#how-vrrp-works" class="hash-link" aria-label="Direct link to How VRRP Works" title="Direct link to How VRRP Works" translate="no">​</a></h4>
<p>VRRP is designed to eliminate single points of failure.</p>
<ul>
<li class="">The nodes in the cluster communicate using <strong>Multicast</strong> packets.</li>
<li class="">The <strong>Master</strong> node periodically sends &quot;advertisements&quot; (heartbeats) to the multicast group.</li>
<li class="">The <strong>Backup</strong> nodes listen for these advertisements.</li>
<li class="">If the Backup nodes stop receiving advertisements (meaning the Master is dead or network partitioned), the Backup with the highest priority promotes itself to Master and claims the VIP.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-configuration-keepalivedconf">The Configuration: <code>keepalived.conf</code><a href="#the-configuration-keepalivedconf" class="hash-link" aria-label="Direct link to the-configuration-keepalivedconf" title="Direct link to the-configuration-keepalivedconf" translate="no">​</a></h4>
<p>Let&#x27;s look at the implementation. We install Keepalived on both CoreDNS servers.</p>
<p><strong>Master Node Configuration (<code>/etc/keepalived/keepalived.conf</code>):</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vrrp_instance VI_1 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state MASTER           # 1. Initial State</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interface eth0         # 2. Network Interface to bind to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtual_router_id 51   # 3. Unique ID for this cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    priority 100           # 4. Election Priority (Higher wins)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    advert_int 1           # 5. Advertisement Interval (1 second)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    authentication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auth_type PASS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auth_pass my_secret_password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtual_ipaddress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        192.168.1.100/24   # 6. The Virtual IP (VIP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><strong>Backup Node Configuration:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vrrp_instance VI_1 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state BACKUP           # Starts as backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interface eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtual_router_id 51   # Must match the Master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    priority 90            # Lower priority than Master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    advert_int 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    authentication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auth_type PASS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auth_pass my_secret_password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtual_ipaddress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        192.168.1.100/24   # Must match the Master</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>We have now eliminated the final Single Point of Failure in our control path.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="final-architecture-the-complete-picture">Final Architecture: The Complete Picture<a href="#final-architecture-the-complete-picture" class="hash-link" aria-label="Direct link to Final Architecture: The Complete Picture" title="Direct link to Final Architecture: The Complete Picture" translate="no">​</a></h2>
<p>We have now evolved a robust, scalable, and self-healing L7 Load Balancer system.</p>
<ol>
<li class=""><strong>Clients</strong> query <strong>CoreDNS</strong> to find an available Load Balancer.</li>
<li class=""><strong>CoreDNS</strong> returns the IP of a healthy LB (based on Geo/Load).</li>
<li class=""><strong>L7 Load Balancers</strong> receive traffic. They read their routing rules and backend lists from <strong>ZooKeeper</strong> (cached in memory).</li>
<li class=""><strong>Backend Servers</strong> process the requests.</li>
<li class=""><strong>Orchestrator Cluster</strong> (Master/Worker) continuously probes Backends and updates <strong>ZooKeeper</strong> if health status changes.</li>
<li class=""><strong>ZooKeeper</strong> pushes config updates to LBs in real-time.</li>
</ol>
</div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/system-design">system-design</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/load-balancer">load-balancer</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/distributed-systems">distributed-systems</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/aws">aws</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/zookeeper">zookeeper</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/docs/blog/concurrent-replace">Avoid &quot;REPLACE INTO&quot;</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-12-29T00:00:00.000Z">December 29, 2025</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/docs/blog/authors/ashish"><img class="avatar__photo authorImage_XqGP" src="https://github.com/arathod02.png" alt="Ashish Rathod"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/docs/blog/authors/ashish"><span class="authorName_yefp" translate="no">Ashish Rathod</span></a></div><small class="authorTitle_nd0D" title="Ex-Intuit Staff Engineer">Ex-Intuit Staff Engineer</small><div class="authorSocials_rSDt"><a href="https://www.linkedin.com/in/ashish-rathod02/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" style="--dark:#0a66c2;--light:#ffffffe6" class="authorSocialIcon_XYv3 linkedinSvg_FCgI"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453"></path></svg></a><a href="https://github.com/arathod02" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p>In distributed systems, <strong>Upsert</strong> (Update or Insert) is a fundamental operation. You want to store a record: if it exists, update it; if not, create it.</p>
<p>MySQL offers a deceptively simple command to handle this: <code>REPLACE INTO</code>. It looks like a standard insert, works like a charm in development, and satisfies the requirement of &quot;single statement atomicity.&quot;</p>
<p>However, under high concurrency, <code>REPLACE INTO</code> can become a source of <strong>deadlocks</strong>, <strong>latency spikes</strong>, and <strong>unexpected behavior</strong>.</p>
<p>In this post, we will tear apart the <code>REPLACE</code> statement to understand its internal mechanics, how InnoDB handles locking, and why your client application <strong>must</strong> be prepared to handle concurrency explicitly.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-the-atomic-myth">1. The &quot;Atomic&quot; Myth<a href="#1-the-atomic-myth" class="hash-link" aria-label="Direct link to 1. The &quot;Atomic&quot; Myth" title="Direct link to 1. The &quot;Atomic&quot; Myth" translate="no">​</a></h2>
<p>Developers often assume that because <code>REPLACE INTO</code> is a single SQL statement, it is a single atomic operation that effectively &quot;locks&quot; the row, does the job, and leaves.</p>
<p><strong>The Reality:</strong>
Internally, <code>REPLACE INTO</code> is <strong>not</strong> a simple update. It is a destructive two-step process disguised as one.</p>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>How REPLACE works internally</div><div class="admonitionContent_BuS1"><ol>
<li class=""><strong>Check:</strong> It attempts to insert the new row.</li>
<li class=""><strong>Conflict:</strong> If a Unique Key or Primary Key collision occurs:<!-- -->
<ul>
<li class=""><strong>Step A:</strong> It performs a <strong>DELETE</strong> of the conflicting row.</li>
<li class=""><strong>Step B:</strong> It performs a fresh <strong>INSERT</strong> of the new row.</li>
</ul>
</li>
</ol></div></div>
<p>This &quot;Delete + Insert&quot; behavior has massive implications for locking and referential integrity.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-the-locking-mechanism-why-deadlocks-happen">2. The Locking Mechanism: Why Deadlocks Happen<a href="#2-the-locking-mechanism-why-deadlocks-happen" class="hash-link" aria-label="Direct link to 2. The Locking Mechanism: Why Deadlocks Happen" title="Direct link to 2. The Locking Mechanism: Why Deadlocks Happen" translate="no">​</a></h2>
<p>To understand why concurrent <code>REPLACE</code> operations cause deadlocks, we need to look at <strong>InnoDB Locking</strong>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-gap-lock--next-key-lock">The Gap Lock &amp; Next-Key Lock<a href="#the-gap-lock--next-key-lock" class="hash-link" aria-label="Direct link to The Gap Lock &amp; Next-Key Lock" title="Direct link to The Gap Lock &amp; Next-Key Lock" translate="no">​</a></h3>
<p>When you write to a table with a Unique Index, MySQL must ensure that no other transaction inserts a duplicate value while your transaction is running.</p>
<ol>
<li class=""><strong>Shared Lock (S-Lock):</strong> When <code>REPLACE</code> detects a duplicate, it first acquires a <em>Shared Lock</em> on the existing record to ensure it stays there while it decides what to do.</li>
<li class=""><strong>Exclusive Lock (X-Lock):</strong> To delete the old row and insert the new one, it must upgrade that lock to an <em>Exclusive Lock</em>.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-deadlock-scenario">The Deadlock Scenario<a href="#the-deadlock-scenario" class="hash-link" aria-label="Direct link to The Deadlock Scenario" title="Direct link to The Deadlock Scenario" translate="no">​</a></h3>
<p>Imagine two clients (Transaction A and Transaction B) trying to <code>REPLACE</code> the <strong>same key</strong> at the exact same time.</p>
<!-- -->
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>The Deadlock Trap</div><div class="admonitionContent_BuS1"><ol>
<li class=""><strong>TxA</strong> holds <strong>S-Lock</strong>. Wants <strong>X-Lock</strong>. Waits for <strong>TxB</strong>.</li>
<li class=""><strong>TxB</strong> holds <strong>S-Lock</strong>. Wants <strong>X-Lock</strong>. Waits for <strong>TxA</strong>.</li>
<li class="">InnoDB detects the cycle and kills one transaction (usually the smaller one) to break the deadlock.</li>
</ol></div></div>
<p><strong>Does MySQL inherently handle it?</strong>
Technically, yes—by <strong>killing</strong> one of your requests. MySQL resolves the deadlock by forcing an error on one client. It does <strong>not</strong> queue them up nicely; it breaks the logjam with force.</p>
<p><strong>Does the client need to handle it?</strong>
<strong>YES.</strong> Your code <strong>must</strong> catch Error <code>1213</code> and implement a retry logic.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-replace-vs-insert-on-duplicate-key-update">3. REPLACE vs. INSERT ON DUPLICATE KEY UPDATE<a href="#3-replace-vs-insert-on-duplicate-key-update" class="hash-link" aria-label="Direct link to 3. REPLACE vs. INSERT ON DUPLICATE KEY UPDATE" title="Direct link to 3. REPLACE vs. INSERT ON DUPLICATE KEY UPDATE" translate="no">​</a></h2>
<p>If <code>REPLACE</code> is so dangerous, what should we use?
The industry standard alternative is <code>INSERT ... ON DUPLICATE KEY UPDATE</code> (IODKU).</p>
<p>Let&#x27;s compare the internal semantics.</p>
<table><thead><tr><th style="text-align:left">Feature</th><th style="text-align:left"><code>REPLACE INTO</code></th><th style="text-align:left"><code>INSERT ON DUPLICATE ...</code></th></tr></thead><tbody><tr><td style="text-align:left"><strong>Mechanic</strong></td><td style="text-align:left">Delete + Insert</td><td style="text-align:left">Update</td></tr><tr><td style="text-align:left"><strong>Primary Key</strong></td><td style="text-align:left"><strong>Changes</strong> (New ID generated)</td><td style="text-align:left"><strong>Preserved</strong> (ID stays same)</td></tr><tr><td style="text-align:left"><strong>Foreign Keys</strong></td><td style="text-align:left"><strong>Breaks</strong> (Cascading Deletes triggered)</td><td style="text-align:left"><strong>Safe</strong> (References maintained)</td></tr><tr><td style="text-align:left"><strong>Locking</strong></td><td style="text-align:left">Aggressive (Gap/Next-Key Locks)</td><td style="text-align:left">Moderate (Row Locks)</td></tr><tr><td style="text-align:left"><strong>Deadlocks</strong></td><td style="text-align:left">High Probability</td><td style="text-align:left">Lower Probability (but non-zero)</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="visualizing-the-mechanics">Visualizing the Mechanics<a href="#visualizing-the-mechanics" class="hash-link" aria-label="Direct link to Visualizing the Mechanics" title="Direct link to Visualizing the Mechanics" translate="no">​</a></h3>
<!-- -->
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Pro Tip: Why IODKU is usually better</div><div class="admonitionContent_BuS1"><p><code>INSERT ON DUPLICATE KEY UPDATE</code> is non-destructive.</p><ol>
<li class="">It performs a &quot;logical&quot; update.</li>
<li class="">It does not churn your auto-increment IDs. <code>REPLACE</code> creates &quot;holes&quot; in your ID sequence because every update burns an ID.</li>
<li class="">It avoids <code>DELETE</code> triggers firing unexpectedly.</li>
</ol></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-does-mysql-inherently-handle-concurrent-upserts">4. Does MySQL inherently handle concurrent upserts?<a href="#4-does-mysql-inherently-handle-concurrent-upserts" class="hash-link" aria-label="Direct link to 4. Does MySQL inherently handle concurrent upserts?" title="Direct link to 4. Does MySQL inherently handle concurrent upserts?" translate="no">​</a></h2>
<p>MySQL handles <strong>Data Integrity</strong> (ACID) perfectly. It will never let two transactions corrupt the data. However, it handles concurrency by using <strong>Locks</strong>. When locks conflict cyclically, it handles it via <strong>Deadlock Detection</strong> (rolling back one transaction).</p>
<p>It does <strong>not</strong> inherently &quot;serialize&quot; them without side effects. The side effect is the Deadlock Error.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-are-the-internal-semantics">What are the internal semantics?<a href="#what-are-the-internal-semantics" class="hash-link" aria-label="Direct link to What are the internal semantics?" title="Direct link to What are the internal semantics?" translate="no">​</a></h3>
<ol>
<li class=""><strong>Gap Locks:</strong> Even with <code>READ COMMITTED</code> isolation, unique constraint checks trigger Gap Locks or Next-Key Locks. This locks the &quot;space&quot; before and after the record.</li>
<li class=""><strong>Lock Upgrades:</strong> The transition from Shared (Read) to Exclusive (Write) is the danger zone.</li>
</ol>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-implementation-strategy">5. Implementation Strategy<a href="#5-implementation-strategy" class="hash-link" aria-label="Direct link to 5. Implementation Strategy" title="Direct link to 5. Implementation Strategy" translate="no">​</a></h2>
<p>If you are building a high-scale system, you should prefer <code>INSERT ON DUPLICATE KEY UPDATE</code>. However, regardless of which statement you choose, you must implement a retry loop in your application code.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="python-pseudo-code-for-robust-upsert">Python Pseudo-code for Robust Upsert<a href="#python-pseudo-code-for-robust-upsert" class="hash-link" aria-label="Direct link to Python Pseudo-code for Robust Upsert" title="Direct link to Python Pseudo-code for Robust Upsert" translate="no">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MAX_RETRIES </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">upsert_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retries </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> retries </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> MAX_RETRIES</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Prefer IODKU over REPLACE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cursor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                INSERT INTO store (`key`, `value`, `updated_at`) </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                VALUES (%s, %s, NOW())</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                ON DUPLICATE KEY UPDATE </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                `value` = VALUES(`value`), </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                `updated_at` = NOW()</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            &quot;&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Success!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> MySQLdb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OperationalError </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1213</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Error Code: Deadlock found</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                retries </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> retries</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Exponential Backoff</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">raise</span><span class="token plain"> e </span><span class="token comment" style="color:#999988;font-style:italic"># Real error, re-raise</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Key Takeaway</div><div class="admonitionContent_BuS1"><p>At scale, <strong>Database Deadlocks are not bugs; they are a fact of life.</strong> They are the database&#x27;s way of protecting your data&#x27;s consistency. Your application logic must be resilient enough to retry when they happen.</p></div></div></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/docs/blog/slack-design">Designing Slack&#x27;s Realtime Communication System</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-12-29T00:00:00.000Z">December 29, 2025</time> · <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/docs/blog/authors/ashish"><img class="avatar__photo authorImage_XqGP" src="https://github.com/arathod02.png" alt="Ashish Rathod"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/docs/blog/authors/ashish"><span class="authorName_yefp" translate="no">Ashish Rathod</span></a></div><small class="authorTitle_nd0D" title="Ex-Intuit Staff Engineer">Ex-Intuit Staff Engineer</small><div class="authorSocials_rSDt"><a href="https://www.linkedin.com/in/ashish-rathod02/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" style="--dark:#0a66c2;--light:#ffffffe6" class="authorSocialIcon_XYv3 linkedinSvg_FCgI"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453"></path></svg></a><a href="https://github.com/arathod02" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p>In this post, we will deep dive into the architecture of an enterprise-grade realtime communication system like Slack. We will categorize different communication patterns, design the database schema for performance, and evolve the system architecture from a simple REST service to a scalable, distributed websocket cluster.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-categorization-of-communication-systems">1. Categorization of Communication Systems<a href="#1-categorization-of-communication-systems" class="hash-link" aria-label="Direct link to 1. Categorization of Communication Systems" title="Direct link to 1. Categorization of Communication Systems" translate="no">​</a></h2>
<p>Not all chat applications are built the same. The architectural choices depend heavily on the business requirements regarding <strong>Persistence</strong> (saving the message) versus <strong>Delivery</strong> (getting the message to the recipient).</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-three-scenarios">The Three Scenarios<a href="#the-three-scenarios" class="hash-link" aria-label="Direct link to The Three Scenarios" title="Direct link to The Three Scenarios" translate="no">​</a></h3>
<p>We can visualize the three main architectural patterns in the diagram below:</p>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="deep-dive-persistence-vs-delivery">Deep Dive: Persistence vs. Delivery<a href="#deep-dive-persistence-vs-delivery" class="hash-link" aria-label="Direct link to Deep Dive: Persistence vs. Delivery" title="Direct link to Deep Dive: Persistence vs. Delivery" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-persistence-over-delivery-slackteams">1. Persistence Over Delivery (Slack/Teams)<a href="#1-persistence-over-delivery-slackteams" class="hash-link" aria-label="Direct link to 1. Persistence Over Delivery (Slack/Teams)" title="Direct link to 1. Persistence Over Delivery (Slack/Teams)" translate="no">​</a></h4>
<p>This is the standard for <strong>Enterprise Grade</strong> systems.</p>
<ul>
<li class=""><strong>Why?</strong> In an enterprise setting, the &quot;Source of Truth&quot; is the server. If a user logs in from a new device, they must see the entire history. Regulatory compliance often mandates that data is never lost.</li>
<li class=""><strong>The Mechanic:</strong> We must guarantee the message is saved to the database <em>before</em> we attempt to deliver it. Delivery is a secondary side-effect of persistence. If the DB write fails, the message is not sent.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-delivery-over-persistence-whatsapp">2. Delivery Over Persistence (WhatsApp)<a href="#2-delivery-over-persistence-whatsapp" class="hash-link" aria-label="Direct link to 2. Delivery Over Persistence (WhatsApp)" title="Direct link to 2. Delivery Over Persistence (WhatsApp)" translate="no">​</a></h4>
<p>This leverages <strong>Local Storage</strong>.</p>
<ul>
<li class=""><strong>Why?</strong> Speed and Privacy. By prioritizing delivery, the app feels &quot;snappy.&quot; The server often acts as a router.</li>
<li class=""><strong>The Mechanic:</strong> The delivery to the recipient is the primary goal. Persistence might happen asynchronously or only on the user&#x27;s local device. If the server crashes, the message might still exist on the phones, but not in the cloud.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-realtime-no-persistence-zoom-chat">3. Realtime No Persistence (Zoom Chat)<a href="#3-realtime-no-persistence-zoom-chat" class="hash-link" aria-label="Direct link to 3. Realtime No Persistence (Zoom Chat)" title="Direct link to 3. Realtime No Persistence (Zoom Chat)" translate="no">​</a></h4>
<p>This is <strong>Ephemeral</strong>.</p>
<ul>
<li class=""><strong>Why?</strong> Contextual relevance. The chat is only relevant while the video session is active.</li>
<li class=""><strong>The Mechanic:</strong> Data flows through the WebSocket server and is immediately discarded. If you join a meeting late, the history is gone because it was never saved.</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-designing-the-core-schema">2. Designing the Core Schema<a href="#2-designing-the-core-schema" class="hash-link" aria-label="Direct link to 2. Designing the Core Schema" title="Direct link to 2. Designing the Core Schema" translate="no">​</a></h2>
<p>Data modeling is the foundation of scale. Let&#x27;s look at how a naive approach fails and how to fix it.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-naive-schema">The Naive Schema<a href="#the-naive-schema" class="hash-link" aria-label="Direct link to The Naive Schema" title="Direct link to The Naive Schema" translate="no">​</a></h3>
<ul>
<li class=""><strong>Users:</strong> <code>id</code>, <code>name</code>, <code>email</code></li>
<li class=""><strong>Channels:</strong> <code>id</code>, <code>name</code></li>
<li class=""><strong>Messages:</strong> <code>id</code>, <code>sender_id</code>, <code>message</code>, <code>created_at</code>, <code>receiver_id</code> (Nullable: set if DM)</li>
</ul>
<p><strong>The Problematic Query:</strong>
When User A opens a DM with User B, we need to fetch their history:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> messages </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">receiver_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;B&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> sender_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;A&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">receiver_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;A&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> sender_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;B&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> created_at </span><span class="token keyword" style="color:#00009f">DESC</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>Why this query fails at scale</div><div class="admonitionContent_BuS1"><p><strong>1. Complex Filtering:</strong> The database engine has to evaluate <code>OR</code> conditions involving two different columns (<code>sender_id</code> and <code>receiver_id</code>). This often prevents the effective use of single-column indexes, potentially leading to a <strong>Table Scan</strong>.
<strong>2. Time Complexity:</strong> If you have billions of messages, a scan is <strong>$O(N)$</strong>. Even with separate indexes, merging results for the <code>OR</code> clause is expensive.
<strong>3. Sorting:</strong> Sorting by <code>created_at</code> on a massive dataset without a covering index adds significant overhead.</p></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-optimized-schema">The Optimized Schema<a href="#the-optimized-schema" class="hash-link" aria-label="Direct link to The Optimized Schema" title="Direct link to The Optimized Schema" translate="no">​</a></h3>
<p>To fix this, we need to change how we view Direct Messages (DMs).</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Insight: DM&#x27;s are just Channels</div><div class="admonitionContent_BuS1"><p><strong>We portray a DM as a single channel with exactly two participants.</strong></p></div></div>
<p>By normalizing DMs into the &quot;Channels&quot; concept, we simplify our access patterns significantly.</p>
<p><strong>New Schema:</strong></p>
<ul>
<li class=""><strong>Channels:</strong> <code>id</code>, <code>name</code>, <code>type</code> (ENUM: &#x27;DM&#x27;, &#x27;GROUP_CHANNEL&#x27;)</li>
<li class=""><strong>Messages:</strong> <code>id</code>, <code>sender_id</code>, <code>message</code>, <code>channel_id</code>, <code>created_at</code>
<ul>
<li class=""><em>Index:</em> <code>CREATE INDEX idx_channel_created ON messages (channel_id, created_at);</code></li>
</ul>
</li>
</ul>
<p><strong>The Optimized Query:</strong>
Now, whether it is a Group Channel or a DM, the query is identical:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> messages </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> channel_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> created_at </span><span class="token keyword" style="color:#00009f">DESC</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Why this is faster</div><div class="admonitionContent_BuS1"><p><strong>1. Index Utilization:</strong> We are querying on a single column <code>channel_id</code>. This allows the DB to use a B-Tree index to jump directly to the relevant block of data.
<strong>2. Time Complexity:</strong> The lookup becomes <strong>$O(\log N)$</strong> (to find the channel node in the B-Tree) + <strong>$O(K)$</strong> (to read the K limit messages).
<strong>3. Pre-sorted:</strong> By including <code>created_at</code> in the composite index, the data is already physically stored or indexed in the correct order. The DB doesn&#x27;t need to perform a separate sort operation.</p></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-defining-apis-and-protocols">3. Defining APIs and Protocols<a href="#3-defining-apis-and-protocols" class="hash-link" aria-label="Direct link to 3. Defining APIs and Protocols" title="Direct link to 3. Defining APIs and Protocols" translate="no">​</a></h2>
<p>We will build the system iteratively, starting with the Persistence layer.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-api-to-get-messages-scroll">1. API to Get Messages (Scroll)<a href="#1-api-to-get-messages-scroll" class="hash-link" aria-label="Direct link to 1. API to Get Messages (Scroll)" title="Direct link to 1. API to Get Messages (Scroll)" translate="no">​</a></h3>
<ul>
<li class=""><strong>Endpoint:</strong> <code>GET /scroll?channel_id={id}&amp;offset={id}</code></li>
<li class=""><strong>Usage:</strong> Called when a user clicks a channel or scrolls up.</li>
<li class=""><strong>Architecture:</strong> Simple REST call.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-api-to-send-messages">2. API to Send Messages<a href="#2-api-to-send-messages" class="hash-link" aria-label="Direct link to 2. API to Send Messages" title="Direct link to 2. API to Send Messages" translate="no">​</a></h3>
<ul>
<li class=""><strong>Endpoint:</strong> <code>POST /messages</code></li>
<li class=""><strong>Payload:</strong> <code>{ &quot;channel_id&quot;: &quot;123&quot;, &quot;message&quot;: &quot;Hello World&quot; }</code></li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Design Decision: REST vs WebSocket for Sending</div><div class="admonitionContent_BuS1"><p>We intentionally use <strong>REST</strong> for sending messages to enforce <strong>Persistence Over Delivery</strong>.</p><ol>
<li class="">The client sends a POST request.</li>
<li class="">The server writes to the DB.</li>
<li class="">Only on a successful DB write does the server acknowledge (200 OK) to the sender.
This guarantees that if the sender thinks the message is sent, it is definitely saved.</li>
</ol></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-delivering-the-message-websockets">3. Delivering the Message (WebSockets)<a href="#3-delivering-the-message-websockets" class="hash-link" aria-label="Direct link to 3. Delivering the Message (WebSockets)" title="Direct link to 3. Delivering the Message (WebSockets)" translate="no">​</a></h3>
<p>Once the message is saved via REST, we need to push it to other users in real-time. We introduce a <strong>WebSocket Service (WSS)</strong>.</p>
<ul>
<li class=""><strong>WSS Role:</strong> Maintains long-lived TCP connections with clients.</li>
<li class=""><strong>Membership Service:</strong> The WSS needs to know <em>who</em> to send the message to. It queries the Membership Service to find all users in <code>channel_id</code>.</li>
</ul>
<p><strong>Current Architecture State:</strong></p>
<!-- -->
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-scaling-websockets-redis-pubsub">4. Scaling Websockets (Redis Pub/Sub)<a href="#4-scaling-websockets-redis-pubsub" class="hash-link" aria-label="Direct link to 4. Scaling Websockets (Redis Pub/Sub)" title="Direct link to 4. Scaling Websockets (Redis Pub/Sub)" translate="no">​</a></h2>
<p>A single WebSocket server cannot hold millions of connections. We must scale out horizontally.</p>
<ul>
<li class=""><strong>Problem:</strong> If Client A is connected to <code>WSS-1</code> and Client B is connected to <code>WSS-2</code>, how does <code>WSS-1</code> send a message to Client B?</li>
<li class=""><strong>Solution:</strong> Redis Pub/Sub.</li>
</ul>
<p><strong>The Strategy: Channel per Workspace</strong></p>
<ol>
<li class="">We create a Redis Channel for every generic Workspace (e.g., &quot;Intuit Workspace&quot;).</li>
<li class="">All WSS instances subscribe to the Redis channels for the workspaces they are currently serving users for.</li>
<li class="">The Message Service publishes the message to the specific Redis Workspace Channel.</li>
<li class="">Redis fans the message out to all WSS instances subscribed to that workspace.</li>
<li class="">Each WSS instance checks its local connection list: &quot;Do I have User B?&quot; If yes, it sends the message.</li>
</ol>
<!-- -->
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-naked-servers--connection-balancing">5. Naked Servers &amp; Connection Balancing<a href="#5-naked-servers--connection-balancing" class="hash-link" aria-label="Direct link to 5. Naked Servers &amp; Connection Balancing" title="Direct link to 5. Naked Servers &amp; Connection Balancing" translate="no">​</a></h2>
<p>How does a client know <em>which</em> WSS node to connect to? We cannot expose WSS nodes directly behind a standard Load Balancer because we need sticky, long-lived connections and intelligent routing.</p>
<p><strong>The Solution: Connection Balancer</strong></p>
<ol>
<li class=""><strong>Discovery:</strong> Client calls <code>GET /connect</code>.</li>
<li class=""><strong>Logic:</strong> The Connection Balancer checks the health and load of all WSS nodes (via a Heartbeat mechanism).</li>
<li class=""><strong>Assignment:</strong> It returns the IP/URL of the best available WSS node (e.g., <code>wss://node-5.slack.com</code>). This is known as the &quot;Naked Server&quot; pattern because the client connects directly to the node, bypassing a reverse proxy for the websocket pipe.</li>
<li class=""><strong>Failover:</strong> If <code>node-5</code> stops sending heartbeats, the Connection Balancer marks it as unhealthy. Clients disconnected from <code>node-5</code> will poll the Balancer again and be assigned to a new node.</li>
</ol>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="final-architecture--flow-walkthrough">Final Architecture &amp; Flow Walkthrough<a href="#final-architecture--flow-walkthrough" class="hash-link" aria-label="Direct link to Final Architecture &amp; Flow Walkthrough" title="Direct link to Final Architecture &amp; Flow Walkthrough" translate="no">​</a></h2>
<p>Below is the complete system design. We have organized the architecture into logical layers to illustrate how the <strong>REST (Sending)</strong> path and <strong>WebSocket (Receiving)</strong> path operate in parallel yet converge at the data and Pub/Sub layers.</p>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="detailed-flow-walkthrough">Detailed Flow Walkthrough<a href="#detailed-flow-walkthrough" class="hash-link" aria-label="Direct link to Detailed Flow Walkthrough" title="Direct link to Detailed Flow Walkthrough" translate="no">​</a></h3>
<ol>
<li class="">
<p><strong>Connection Handshake (Blue Dotted Line):</strong></p>
<ul>
<li class=""><strong>User B (Receiver)</strong> opens the app.</li>
<li class="">The client polls the <strong>Connection Balancer</strong> (Step 0) to find a healthy WebSocket server.</li>
<li class="">The Balancer assigns <strong>WSS Node 2</strong>.</li>
<li class="">User B establishes a direct, long-lived &quot;naked&quot; TCP/WebSocket connection with WSS Node 2.</li>
</ul>
</li>
<li class="">
<p><strong>Sending (Black Path):</strong></p>
<ul>
<li class=""><strong>User A (Sender)</strong> sends a message via <strong>REST POST</strong> to the Load Balancer (Step 1).</li>
<li class="">The <strong>Message Service</strong> writes the message to the <strong>Primary DB</strong> (Step 2).</li>
<li class=""><em>Constraint:</em> The server waits for the DB acknowledgment (<code>ACK</code>) before responding <code>200 OK</code> to User A. This ensures <strong>Persistence</strong>.</li>
</ul>
</li>
<li class="">
<p><strong>Internal Routing (Orange Path):</strong></p>
<ul>
<li class="">Once persisted, the Message Service publishes an event to <strong>Redis Pub/Sub</strong> (Step 3).</li>
<li class="">Redis fans this message out to <em>all</em> WebSocket Servers (Step 4) that are subscribed to the user&#x27;s workspace channel.</li>
</ul>
</li>
<li class="">
<p><strong>Delivery (Green Path):</strong></p>
<ul>
<li class=""><strong>WSS Node 1</strong> receives the event, checks its internal map, sees it has no connection for User B, and ignores it.</li>
<li class=""><strong>WSS Node 2</strong> receives the event. It queries the <strong>Membership Service</strong> (Step 5) to resolve channel members.</li>
<li class="">It identifies that it holds the active socket for User B.</li>
<li class="">It pushes the message payload down the open WebSocket connection to <strong>User B</strong> (Step 6).</li>
</ul>
</li>
</ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/system-design">system-design</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/websocket">websocket</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/redis">redis</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/docs/blog/tags/architecture">architecture</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/docs/blog/distributed-key-value-store">Distributed Key-Value Store</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-12-28T00:00:00.000Z">December 28, 2025</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/docs/blog/authors/ashish"><img class="avatar__photo authorImage_XqGP" src="https://github.com/arathod02.png" alt="Ashish Rathod"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/docs/blog/authors/ashish"><span class="authorName_yefp" translate="no">Ashish Rathod</span></a></div><small class="authorTitle_nd0D" title="Ex-Intuit Staff Engineer">Ex-Intuit Staff Engineer</small><div class="authorSocials_rSDt"><a href="https://www.linkedin.com/in/ashish-rathod02/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" style="--dark:#0a66c2;--light:#ffffffe6" class="authorSocialIcon_XYv3 linkedinSvg_FCgI"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453"></path></svg></a><a href="https://github.com/arathod02" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p>In this post, we will walk through the journey of designing and implementing a horizontally scalable Key-Value store. We will start from a basic implementation, iterate through schema designs, optimize for performance, and finally scale it to handle massive loads.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="requirements">Requirements<a href="#requirements" class="hash-link" aria-label="Direct link to Requirements" title="Direct link to Requirements" translate="no">​</a></h3>
<ol>
<li class=""><strong>Horizontally Scalable:</strong> The system must handle growth in data and traffic.</li>
<li class=""><strong>Core Operations:</strong> Support <code>GET</code>, <code>PUT</code>, <code>DEL</code>, and <code>TTL</code> (Time To Live).</li>
</ol>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-the-initial-architecture">1. The Initial Architecture<a href="#1-the-initial-architecture" class="hash-link" aria-label="Direct link to 1. The Initial Architecture" title="Direct link to 1. The Initial Architecture" translate="no">​</a></h2>
<p>To begin, let&#x27;s look at a typical 3-tier application architecture. This serves as our baseline.</p>
<!-- -->
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Concept: Storage and Compute Separation</div><div class="admonitionContent_BuS1"><p>One of the most powerful architectural patterns in modern cloud computing is the <strong>Separation of Storage and Compute</strong>.</p><ul>
<li class=""><strong>Independent Scaling:</strong> You can scale your processing power (API/Compute) independently from your data storage size. If your logic becomes complex but data volume is low, you scale compute. If you store petabytes but access it rarely, you scale storage.</li>
<li class=""><strong>Cost Optimization:</strong> This significantly reduces TCO (Total Cost of Ownership). You don&#x27;t pay for CPU cycles you don&#x27;t use just because you need more disk space.</li>
<li class=""><strong>Cloud Native Examples:</strong>
<ul>
<li class=""><strong>Snowflake:</strong> Pioneered this by allowing data to sit in S3 (cheap object storage) while spinning up &quot;Warehouses&quot; (Compute) only when queries run.</li>
<li class=""><strong>AWS Aurora:</strong> The compute node processes queries, but the storage is a distributed, self-healing volume that grows automatically.</li>
<li class=""><strong>AWS DocumentDB:</strong> This is a classic example. Clients see a MongoDB-compatible API (NoSQL), but it is actually built on top of the Aurora storage engine (Relational/Cloud Native). <strong>Clients care about guarantees and APIs, not the underlying engine.</strong></li>
</ul>
</li>
</ul></div></div>
<p>For this blog, we will use <strong>MySQL</strong> as our persistence layer.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-schema-design-the-performance-trap">2. Schema Design: The Performance Trap<a href="#2-schema-design-the-performance-trap" class="hash-link" aria-label="Direct link to 2. Schema Design: The Performance Trap" title="Direct link to 2. Schema Design: The Performance Trap" translate="no">​</a></h2>
<p>We need to store a Key, a Value, and manage the lifecycle (TTL) of the data. Let&#x27;s evaluate two schema options.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="option-1-calculated-expiry">Option 1: Calculated Expiry<a href="#option-1-calculated-expiry" class="hash-link" aria-label="Direct link to Option 1: Calculated Expiry" title="Direct link to Option 1: Calculated Expiry" translate="no">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> store </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">key</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">VARCHAR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">value</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TEXT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">created_at</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DATETIME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">ttl</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>To delete expired items, the query would be:
<code>DELETE FROM store WHERE created_at + ttl &lt; NOW();</code></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="option-2-pre-calculated-expiry">Option 2: Pre-calculated Expiry<a href="#option-2-pre-calculated-expiry" class="hash-link" aria-label="Direct link to Option 2: Pre-calculated Expiry" title="Direct link to Option 2: Pre-calculated Expiry" translate="no">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> store </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">key</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">VARCHAR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">value</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TEXT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">expired_at</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BIGINT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> idx_expiry </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expired_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-option-1-is-a-disaster-for-scale">Why Option 1 is a disaster for scale<a href="#why-option-1-is-a-disaster-for-scale" class="hash-link" aria-label="Direct link to Why Option 1 is a disaster for scale" title="Direct link to Why Option 1 is a disaster for scale" translate="no">​</a></h3>
<p>In Option 1, the condition <code>WHERE created_at + ttl &lt; NOW()</code> creates a massive performance bottleneck.</p>
<p>When you perform an operation on a column (like addition) on the left side of a comparison, the database <strong>cannot</strong> efficiently use a B-Tree index. The database engine must perform the calculation <code>created_at + ttl</code> for <strong>every single row</strong> in the table to determine if it meets the criteria.</p>
<p>This results in a <strong>Full Table Scan</strong> (or a full index scan), which operates at <code>O(N)</code> complexity. If you have 100 million rows, the DB reads 100 million rows.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-option-2-wins">Why Option 2 wins<a href="#why-option-2-wins" class="hash-link" aria-label="Direct link to Why Option 2 wins" title="Direct link to Why Option 2 wins" translate="no">​</a></h3>
<p>In Option 2, we store <code>expired_at</code>. This is a static value.</p>
<ol>
<li class=""><strong>Sorted Storage:</strong> The Secondary Index on <code>expired_at</code> keeps pointers sorted by time.</li>
<li class=""><strong>Efficient Range Scan:</strong> The query becomes <code>WHERE expired_at &lt; NOW()</code>. The database goes to the index, finds the first entry, and reads sequentially until it hits the timestamp for <code>NOW()</code>. This is an efficient range seek.</li>
</ol>
<p><strong>Decision:</strong> We will proceed with <strong>Option 2</strong>.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-implementing-operations">3. Implementing Operations<a href="#3-implementing-operations" class="hash-link" aria-label="Direct link to 3. Implementing Operations" title="Direct link to 3. Implementing Operations" translate="no">​</a></h2>
<p>Now let&#x27;s implement the core logic, keeping network efficiency and database load in mind.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-insert--put-operation">The INSERT / PUT Operation<a href="#the-insert--put-operation" class="hash-link" aria-label="Direct link to The INSERT / PUT Operation" title="Direct link to The INSERT / PUT Operation" translate="no">​</a></h3>
<p>A naive implementation might look like this:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ttl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start_transaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># 1. Network Call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># 2. Network Call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 3. Network Call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 3. Network Call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># 4. Network Call</span><br></span></code></pre></div></div>
<p><strong>The Problem:</strong> This requires up to 4 distinct network round trips to the database for a single application request. At scale, this latency kills performance.</p>
<p><strong>The Solution:</strong> Use an <strong>UPSERT</strong>. In MySQL, we can use <code>REPLACE INTO</code> or <code>INSERT ON DUPLICATE KEY UPDATE</code>.</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> store </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">key</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">value</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">expired_at</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NOW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DUPLICATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">value</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">value</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">expired_at</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NOW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Avoid &quot;REPLACE INTO&quot;</div><div class="admonitionContent_BuS1"><p>More details can be found <a class="" href="/docs/blog/concurrent-replace">here</a></p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Transaction Autocommit</div><div class="admonitionContent_BuS1"><p>In modern databases (like MySQL with InnoDB), if you fire a single statement like <code>REPLACE INTO</code> or <code>UPDATE</code>, the engine implicitly starts a transaction, executes the statement, and commits it. You do not need to manually handle transaction boundaries for single atomic operations.</p></div></div>
<p>We have optimized 4 operations down to <strong>1</strong>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-get-operation">The GET Operation<a href="#the-get-operation" class="hash-link" aria-label="Direct link to The GET Operation" title="Direct link to The GET Operation" translate="no">​</a></h3>
<p>We must ensure we don&#x27;t return expired data, even if the cleanup job hasn&#x27;t run yet.</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> store </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">key</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;my_key&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> expired_at </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NOW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-del-operation">The DEL Operation<a href="#the-del-operation" class="hash-link" aria-label="Direct link to The DEL Operation" title="Direct link to The DEL Operation" translate="no">​</a></h3>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Concept: Hard vs. Soft Deletes</div><div class="admonitionContent_BuS1"><ul>
<li class=""><strong>Hard Delete:</strong> Physically removes the row from the storage. This causes immediate I/O overhead as the B-Tree must rebalance and pages might need to be merged.</li>
<li class=""><strong>Soft Delete:</strong> Updates a flag (e.g., <code>is_deleted=true</code>) or a timestamp. The data remains but is logically invisible. This minimizes immediate I/O fluctuation.</li>
</ul></div></div>
<p>To implement <code>DEL</code> efficiently, we will perform a <strong>Soft Delete</strong> by expiring the key immediately. We update the <code>expired_at</code> to a past timestamp (or a sentinel value like -1) to indicate it was deleted by the user, not naturally expired.
<em>More details on hard deletes can be found <a class="" href="/docs/blog/avoid-hard-deletes">here</a>.</em></p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> store </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> expired_at </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">key</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;my_key&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> expired_at </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NOW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-the-ttl-cleanup-garbage-collection">4. The TTL Cleanup (Garbage Collection)<a href="#4-the-ttl-cleanup-garbage-collection" class="hash-link" aria-label="Direct link to 4. The TTL Cleanup (Garbage Collection)" title="Direct link to 4. The TTL Cleanup (Garbage Collection)" translate="no">​</a></h2>
<p>We need a background cron job to physically remove expired rows.</p>
<p><strong>Naive Approach:</strong></p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> store </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> expired_at </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NOW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Performance Risk: Unbounded Deletes</div><div class="admonitionContent_BuS1"><p><strong>Never perform unbounded deletes in production.</strong>
If your table has 100 million rows and 10 million are expired:</p><ol>
<li class="">The DB tries to lock all 10 million rows.</li>
<li class="">It fills up the Undo/Redo logs to support rollback.</li>
<li class="">It spikes CPU and IO, potentially blocking live traffic.
<strong>Bounded Deletes are always superior.</strong> Deleting 100 rows in a loop is infinitely better than crashing the DB trying to delete 10k at once.</li>
</ol></div></div>
<p><strong>Optimized Approach (Batching):</strong></p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> store </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> expired_at </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> UNIX_TIMESTAMP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>The cron job should run this query in a loop until the affected row count is 0.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-scaling-the-system">5. Scaling the System<a href="#5-scaling-the-system" class="hash-link" aria-label="Direct link to 5. Scaling the System" title="Direct link to 5. Scaling the System" translate="no">​</a></h2>
<p>We have the logic. Now, let&#x27;s handle the growth.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="scenario-1-high-traffic-readwrite">Scenario 1: High Traffic (Read/Write)<a href="#scenario-1-high-traffic-readwrite" class="hash-link" aria-label="Direct link to Scenario 1: High Traffic (Read/Write)" title="Direct link to Scenario 1: High Traffic (Read/Write)" translate="no">​</a></h3>
<p>If the number of requests spikes, the first bottleneck is usually the CPU/Memory on the API servers.</p>
<p><strong>Solution:</strong> Horizontally scale the API layer.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Recap: Storage/Compute Separation</div><div class="admonitionContent_BuS1"><p>Because our API (Compute) is decoupled from the DB (Storage), we can spin up 50 new API instances without touching the Database configuration.</p></div></div>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="scenario-2-read-heavy-load">Scenario 2: Read Heavy Load<a href="#scenario-2-read-heavy-load" class="hash-link" aria-label="Direct link to Scenario 2: Read Heavy Load" title="Direct link to Scenario 2: Read Heavy Load" translate="no">​</a></h3>
<p>As you grow, the single Master DB will struggle to handle all the <code>SELECT</code> queries.</p>
<p><strong>Solution:</strong> Add Read Replicas.</p>
<!-- -->
<p>We route <code>PUT/DEL</code> to Master, and <code>GET</code> to Replicas.</p>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>The Cost of Scale: Eventual Consistency</div><div class="admonitionContent_BuS1"><p>When you introduce Read Replicas, you introduce <strong>Replication Lag</strong>.</p><ol>
<li class="">Client A writes <code>Key=X</code> to Master.</li>
<li class="">Client B reads <code>Key=X</code> from Replica 1 immediately.</li>
<li class="">If the data hasn&#x27;t copied over yet (lag), Client B gets a <strong>Cache Miss</strong> or stale data.</li>
</ol><p><strong>Real World Solution: DynamoDB</strong>
Amazon DynamoDB solves this by giving the client a choice. You can perform a standard read (eventually consistent, cheaper) or a <strong>Strongly Consistent Read</strong>.
If you request <code>ConsistentRead=True</code>, DynamoDB routes the request to the Leader node to guarantee the latest data, but it consumes 2x capacity units (costs more).</p></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="scenario-3-write-heavy-load">Scenario 3: Write Heavy Load<a href="#scenario-3-write-heavy-load" class="hash-link" aria-label="Direct link to Scenario 3: Write Heavy Load" title="Direct link to Scenario 3: Write Heavy Load" translate="no">​</a></h3>
<p>Eventually, your Master DB won&#x27;t handle the incoming write volume.</p>
<p><strong>Step 1: Vertical Scaling.</strong> Upgrade the Master to a bigger machine (more RAM, better CPU).
<strong>Step 2: Sharding.</strong> When vertical scaling hits the limit (physics or cost), we shard.</p>
<p>More details on sharding can be found in my previous <a class="" href="/docs/blog/scaling-distributed-systems#3-sharding">post on sharding</a>.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="final-architecture">Final Architecture<a href="#final-architecture" class="hash-link" aria-label="Direct link to Final Architecture" title="Direct link to Final Architecture" translate="no">​</a></h2>
<p>Here is the final system diagram, fully scaled vertically and horizontally, featuring sharded masters and read replicas.</p>
</div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/docs/blog/db-pessimistic-optimistic-locking">Deep Dive into Database Pessimistic &amp; Optimistic Locking</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-12-27T00:00:00.000Z">December 27, 2025</time> · <!-- -->14 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/docs/blog/authors/ashish"><img class="avatar__photo authorImage_XqGP" src="https://github.com/arathod02.png" alt="Ashish Rathod"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/docs/blog/authors/ashish"><span class="authorName_yefp" translate="no">Ashish Rathod</span></a></div><small class="authorTitle_nd0D" title="Ex-Intuit Staff Engineer">Ex-Intuit Staff Engineer</small><div class="authorSocials_rSDt"><a href="https://www.linkedin.com/in/ashish-rathod02/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" style="--dark:#0a66c2;--light:#ffffffe6" class="authorSocialIcon_XYv3 linkedinSvg_FCgI"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453"></path></svg></a><a href="https://github.com/arathod02" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p>In distributed systems, managing access to shared resources is one of the most critical challenges we face. When multiple processes or threads attempt to modify the same data simultaneously, we risk race conditions that can corrupt the system&#x27;s state.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="pessimistic-locking">Pessimistic Locking<a href="#pessimistic-locking" class="hash-link" aria-label="Direct link to Pessimistic Locking" title="Direct link to Pessimistic Locking" translate="no">​</a></h2>
<p>It is a mechanism where we assume a conflict will occur and lock the data before operating on it. We will dive into MySQL&#x27;s locking mechanisms, deadlock detection, and analyze a Python simulation to see these locks in action.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-what-are-locks-and-why-do-we-need-them">1. What are Locks and Why Do We Need Them?<a href="#1-what-are-locks-and-why-do-we-need-them" class="hash-link" aria-label="Direct link to 1. What are Locks and Why Do We Need Them?" title="Direct link to 1. What are Locks and Why Do We Need Them?" translate="no">​</a></h2>
<p>At its core, a database is the &quot;Source of Truth&quot; for an application. If this source becomes corrupted, the entire integrity of the system collapses.</p>
<p>In a concurrent environment (like a web server handling thousands of requests), multiple transactions often try to access and modify the same database row at the exact same millisecond. Without protection, we encounter the <strong>Lost Update Problem</strong>:</p>
<ol>
<li class="">Transaction A reads a value (e.g., <code>seats_available = 1</code>).</li>
<li class="">Transaction B reads the same value (<code>seats_available = 1</code>).</li>
<li class="">Transaction A updates the value to 0.</li>
<li class="">Transaction B <em>also</em> updates the value to 0.</li>
</ol>
<p>Both transactions believe they successfully reserved the last seat, but the database is now in an inconsistent state.</p>
<p><strong>Pessimistic Locking</strong> solves this by preventing other transactions from modifying (and often reading) the data until the lock holder is finished. It enforces a strict &quot;I was here first&quot; policy, ensuring that the shared resource is mutually exclusive during the critical section of the update.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-the-downside-deadlocks">2. The Downside: Deadlocks<a href="#2-the-downside-deadlocks" class="hash-link" aria-label="Direct link to 2. The Downside: Deadlocks" title="Direct link to 2. The Downside: Deadlocks" translate="no">​</a></h2>
<p>While locks protect data, they introduce a new danger: <strong>Deadlocks</strong>.</p>
<p>A deadlock occurs when two or more transactions are waiting for one another to give up locks, resulting in a cycle where no one can proceed.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="deadlock-detection-in-mysql-innodb">Deadlock Detection in MySQL (InnoDB)<a href="#deadlock-detection-in-mysql-innodb" class="hash-link" aria-label="Direct link to Deadlock Detection in MySQL (InnoDB)" title="Direct link to Deadlock Detection in MySQL (InnoDB)" translate="no">​</a></h3>
<p>Modern storage engines have sophisticated deadlock detection mechanisms. They maintain a <strong>Wait-For Graph</strong> (a directed graph) where nodes are transactions and edges represent one transaction waiting for a lock held by another.</p>
<ul>
<li class="">If the graph contains a <strong>cycle</strong>, a deadlock exists.</li>
<li class="">DB immediately detects this cycle.</li>
<li class="">It resolves the deadlock by kills one of the transactions (usually the one that has done the least amount of work) to allow the other to proceed.</li>
</ul>
<p><strong>The Error:</strong>
When MySQL kills a transaction to break a deadlock, it throws the following error:</p>
<blockquote>
<p><code>ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</code></p>
</blockquote>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="visualizing-the-deadlock-graph">Visualizing the Deadlock Graph<a href="#visualizing-the-deadlock-graph" class="hash-link" aria-label="Direct link to Visualizing the Deadlock Graph" title="Direct link to Visualizing the Deadlock Graph" translate="no">​</a></h3>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-acquiring-locks-in-mysql">3. Acquiring Locks in MySQL<a href="#3-acquiring-locks-in-mysql" class="hash-link" aria-label="Direct link to 3. Acquiring Locks in MySQL" title="Direct link to 3. Acquiring Locks in MySQL" translate="no">​</a></h2>
<p>MySQL provides specific syntax to interact with row-level locking during a <code>SELECT</code> statement.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="for-update"><code>FOR UPDATE</code><a href="#for-update" class="hash-link" aria-label="Direct link to for-update" title="Direct link to for-update" translate="no">​</a></h3>
<p>This is the standard pessimistic lock. It tells the database: <em>&quot;I intend to update these rows. Lock them exclusively. If anyone else has them locked, I will wait until they are released.&quot;</em></p>
<ul>
<li class=""><strong>Behavior:</strong> Blocks if the row is already locked.</li>
<li class=""><strong>Use Case:</strong> Strict consistency where processing order matters or where you must update specific rows.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="nowait"><code>NOWAIT</code><a href="#nowait" class="hash-link" aria-label="Direct link to nowait" title="Direct link to nowait" translate="no">​</a></h3>
<p>This tells the database: <em>&quot;I want to lock these rows. If they are already locked, do not make me wait. Fail immediately.&quot;</em></p>
<ul>
<li class=""><strong>Behavior:</strong> Throws an error immediately if the row is locked.</li>
<li class=""><strong>Use Case:</strong> Real-time systems where failing fast is better than queuing.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="skip-locked"><code>SKIP LOCKED</code><a href="#skip-locked" class="hash-link" aria-label="Direct link to skip-locked" title="Direct link to skip-locked" translate="no">​</a></h3>
<p>This is a powerful feature for high-concurrency queues. It tells the database: <em>&quot;I want to lock rows that match my criteria. If some are already locked by others, just skip them and give me the next available ones.&quot;</em></p>
<ul>
<li class=""><strong>Behavior:</strong> Does not wait; simply ignores locked rows and returns the free ones.</li>
<li class=""><strong>Use Case:</strong> Ticket booking, job queues, task distribution.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="locking-visualization">Locking Visualization<a href="#locking-visualization" class="hash-link" aria-label="Direct link to Locking Visualization" title="Direct link to Locking Visualization" translate="no">​</a></h4>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-code-walkthrough--scenario-analysis">4. Code Walkthrough &amp; Scenario Analysis<a href="#4-code-walkthrough--scenario-analysis" class="hash-link" aria-label="Direct link to 4. Code Walkthrough &amp; Scenario Analysis" title="Direct link to 4. Code Walkthrough &amp; Scenario Analysis" translate="no">​</a></h2>
<p>I created a Python script to simulate a high-concurrency seat reservation system. The script spawns multiple threads, where each thread attempts to:</p>
<ol>
<li class="">Start a transaction.</li>
<li class="">Find an available seat (<code>user_id IS NULL</code>).</li>
<li class="">Book it (<code>UPDATE seats SET user_id...</code>).</li>
<li class="">Commit.</li>
</ol>
<p>Let&#x27;s analyze the behavior under three different locking strategies.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="scenario-1-without-for-update">Scenario 1: WITHOUT &quot;FOR UPDATE&quot;<a href="#scenario-1-without-for-update" class="hash-link" aria-label="Direct link to Scenario 1: WITHOUT &quot;FOR UPDATE&quot;" title="Direct link to Scenario 1: WITHOUT &quot;FOR UPDATE&quot;" translate="no">​</a></h3>
<p><strong>Observation:</strong> The number of reserved seats is <strong>highly non-deterministic</strong> and almost always less than the number of threads.</p>
<p><strong>Why? (The Race Condition)</strong>
This is a classic &quot;Check-Then-Act&quot; race condition.</p>
<ol>
<li class=""><strong>Thread Scheduling:</strong> The OS schedules Thread A and Thread B to run almost simultaneously on different CPU cores.</li>
<li class=""><strong>Snapshot Isolation:</strong> Thread A runs <code>SELECT</code> and sees Seat #1 is empty. Before Thread A can run the <code>UPDATE</code> statement, the OS context switches or simply executes Thread B in parallel.</li>
<li class=""><strong>Duplicate Reads:</strong> Thread B runs the same <code>SELECT</code> and <em>also</em> sees Seat #1 is empty (because A hasn&#x27;t committed yet).</li>
<li class=""><strong>The Overwrite:</strong> Thread A updates Seat #1 and commits. Thread B updates Seat #1 (overwriting A&#x27;s work) and commits.</li>
<li class=""><strong>Result:</strong> Two threads think they booked a seat, but only one record exists in the DB. One reservation is effectively &quot;lost.&quot;</li>
</ol>
<!-- -->
<div class="language-info codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-info codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:38:55,400 - MainThread - INFO - SEAT RESERVATION SYSTEM - COMPLETED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:38:55,400 - MainThread - INFO - ================================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:38:55,400 - MainThread - INFO - Threads requested: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:38:55,400 - MainThread - INFO - Seats created: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:38:55,400 - MainThread - INFO - Seats reserved: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:38:55,400 - MainThread - INFO - Execution time: 7 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:38:55,400 - MainThread - INFO - ================================================================================</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="scenario-2-with-for-update">Scenario 2: WITH &quot;FOR UPDATE&quot;<a href="#scenario-2-with-for-update" class="hash-link" aria-label="Direct link to Scenario 2: WITH &quot;FOR UPDATE&quot;" title="Direct link to Scenario 2: WITH &quot;FOR UPDATE&quot;" translate="no">​</a></h3>
<p><strong>Observation:</strong> The number of reserved seats <strong>always equals</strong> the total number of seats (up to the thread limit). Consistency is maintained.</p>
<p><strong>Why? (Blocking &amp; Re-evaluation)</strong>
When Thread A runs <code>SELECT ... FOR UPDATE</code>, the database locks that specific row (Seat #1).</p>
<ol>
<li class=""><strong>The Block:</strong> If Thread B tries to select Seat #1, the DB forces it to <strong>wait</strong>.</li>
<li class=""><strong>The Re-evaluation:</strong> Once Thread A commits, it releases the lock. Thread B wakes up.</li>
<li class=""><strong>The Loop/Retry:</strong> When Thread B acquires the lock, it sees the <em>latest</em> committed data. It realizes Seat #1 is now taken (user_id is NOT NULL), so it must restart the search or move to the next available row.</li>
</ol>
<p>This serialization ensures that no two threads can ever &quot;win&quot; the same seat.</p>
<!-- -->
<div class="language-info codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-info codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:43:25,625 - MainThread - INFO - SEAT RESERVATION SYSTEM - COMPLETED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:43:25,625 - MainThread - INFO - ================================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:43:25,625 - MainThread - INFO - Threads requested: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:43:25,625 - MainThread - INFO - Seats created: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:43:25,625 - MainThread - INFO - Seats reserved: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:43:25,625 - MainThread - INFO - Execution time: 25 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:43:25,625 - MainThread - INFO - ================================================================================</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="scenario-3-with-for-update-skip-locked">Scenario 3: WITH &quot;FOR UPDATE SKIP LOCKED&quot;<a href="#scenario-3-with-for-update-skip-locked" class="hash-link" aria-label="Direct link to Scenario 3: WITH &quot;FOR UPDATE SKIP LOCKED&quot;" title="Direct link to Scenario 3: WITH &quot;FOR UPDATE SKIP LOCKED&quot;" translate="no">​</a></h3>
<p><strong>Observation:</strong> The number of seats reserved is correct (consistent), but the <strong>total execution time is significantly lower</strong> than Scenario 2.</p>
<p><strong>Why? (Concurrency without Contention)</strong>
This is the gold standard for job queues or booking systems.</p>
<ol>
<li class=""><strong>No Waiting:</strong> Thread A grabs Seat #1. Thread B comes in, sees Seat #1 is locked, and <em>instantly</em> skips it to grab Seat #2.</li>
<li class=""><strong>Parallelism:</strong> Because threads don&#x27;t wait for each other, they can utilize the full connection pool simultaneously.</li>
<li class=""><strong>Result:</strong> If you have 10 threads, you reserve 10 seats in roughly the time it takes to reserve 1 seat, rather than the time it takes to reserve 10 seats sequentially.</li>
</ol>
<div class="language-info codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-info codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:47:55,625 - MainThread - INFO - SEAT RESERVATION SYSTEM - COMPLETED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:47:55,625 - MainThread - INFO - ================================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:47:55,625 - MainThread - INFO - Threads requested: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:47:55,625 - MainThread - INFO - Seats created: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:47:55,625 - MainThread - INFO - Seats reserved: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:47:55,625 - MainThread - INFO - Execution time: 9.71 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-12-26 17:47:55,625 - MainThread - INFO - ================================================================================</span><br></span></code></pre></div></div>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="code-reference">Code Reference<a href="#code-reference" class="hash-link" aria-label="Direct link to Code Reference" title="Direct link to Code Reference" translate="no">​</a></h2>
<p>Here is the Python script used for this simulation:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">reserve_seat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">thread_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Get a connection from the pool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        conn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> connection_pool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_connection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cursor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cursor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> (User </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">user_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">): Starting seat reservation&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Start transaction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">start_transaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">: Transaction started&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Select an unreserved seat (user_id is NULL) with FOR UPDATE to lock the row</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># NOTE: Change &#x27;FOR UPDATE SKIP LOCKED&#x27; to &#x27;FOR UPDATE&#x27; or remove it to test different scenarios</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        select_query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SELECT id, seat_number FROM seats WHERE user_id IS NULL AND trip = %s LIMIT 1 FOR UPDATE SKIP LOCKED&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cursor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">select_query</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;TRIP_001&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        seat </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fetchone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> seat</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            seat_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> seat_number </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> seat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> (User </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">user_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">): Found available seat #</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">seat_number</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Update the seat with user_id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            update_query </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;UPDATE seats SET user_id = %s WHERE id = %s&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cursor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">update_query</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> seat_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Commit the transaction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> (User </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">user_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">): Successfully reserved seat #</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">seat_number</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">commit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> (User </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">user_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">): No available seats found&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cursor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Error </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> (User </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">user_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">): Error during seat reservation: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> conn </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_connected</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rollback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">: Transaction rolled back&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Error </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> rollback_error</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">thread_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">: Error during rollback: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">rollback_error</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">finally</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> conn </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_connected</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ... (Main execution logic)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="optmimistic-locking-the-non-blocking-alternative">Optmimistic Locking: The Non-Blocking Alternative<a href="#optmimistic-locking-the-non-blocking-alternative" class="hash-link" aria-label="Direct link to Optmimistic Locking: The Non-Blocking Alternative" title="Direct link to Optmimistic Locking: The Non-Blocking Alternative" translate="no">​</a></h2>
<p><strong>Optimistic Locking</strong> offers an alternative strategy. Instead of locking the door before you enter, you assume the door is unlocked, do your work, and check if anyone else locked it only when you are leaving.</p>
<p>Optimistic locking is a strategy where you read a record, take note of a version number, and check that version number again only when you write the changes back.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="optimistic-vs-pessimistic">Optimistic vs. Pessimistic<a href="#optimistic-vs-pessimistic" class="hash-link" aria-label="Direct link to Optimistic vs. Pessimistic" title="Direct link to Optimistic vs. Pessimistic" translate="no">​</a></h3>
<ul>
<li class=""><strong>Pessimistic Locking:</strong> Assumes the worst. &quot;Something bad will happen, so I will lock this row as soon as I select it (<code>SELECT ... FOR UPDATE</code>). No one else can touch it until I&#x27;m done.&quot;</li>
<li class=""><strong>Optimistic Locking:</strong> Assumes the best. &quot;It&#x27;s unlikely anyone else will modify this row while I&#x27;m working on it. I won&#x27;t lock anything during the read. I will only check for conflicts when I attempt to update.&quot;</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-implementation-the-version_number">The Implementation: The <code>version_number</code><a href="#the-implementation-the-version_number" class="hash-link" aria-label="Direct link to the-implementation-the-version_number" title="Direct link to the-implementation-the-version_number" translate="no">​</a></h3>
<p>The standard way to implement optimistic locking is by adding a column to your table, usually named <code>version</code> or <code>revision</code>.</p>
<ol>
<li class=""><strong>Read:</strong> When you read a row, you also read the current <code>version</code> (e.g., 1).</li>
<li class=""><strong>Modify:</strong> You perform your logic in the application layer.</li>
<li class=""><strong>Update:</strong> When you send the update query, you add a <code>WHERE</code> clause checking if the <code>version</code> is still 1. You also increment the version.</li>
</ol>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Step 1: Read the data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> version </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> wiki_pages </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">101</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Result: version = 5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- ... Application logic happens here ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Step 2: Update with guard clause</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> wiki_pages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;New Content&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">101</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Crucial Check!</span><br></span></code></pre></div></div>
<p><strong>The Outcome:</strong></p>
<ul>
<li class="">If the database returns <strong>1 row affected</strong>, the update succeeded.</li>
<li class="">If the database returns <strong>0 rows affected</strong>, it means someone else changed the <code>version</code> to 6 (or higher) while you were working. Your transaction fails, and you must handle the conflict (usually by retrying).</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="when-to-use-the-case-for-non-contention">When to Use: The Case for Non-Contention<a href="#when-to-use-the-case-for-non-contention" class="hash-link" aria-label="Direct link to When to Use: The Case for Non-Contention" title="Direct link to When to Use: The Case for Non-Contention" translate="no">​</a></h2>
<p>Optimistic locking shines in scenarios of <strong>Low Contention</strong>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="high-contention-vs-low-contention">High Contention vs. Low Contention<a href="#high-contention-vs-low-contention" class="hash-link" aria-label="Direct link to High Contention vs. Low Contention" title="Direct link to High Contention vs. Low Contention" translate="no">​</a></h3>
<ul>
<li class=""><strong>High Contention (Use Pessimistic):</strong> Imagine a limited drop of 10 concert tickets with 10,000 users trying to buy them instantly. If you use optimistic locking here, 1 person succeeds, and 9,999 users fail and have to retry. Those retries hammer the database. Pessimistic locking is better here to queue the requests.</li>
<li class=""><strong>Low Contention (Use Optimistic):</strong> Imagine a user updating their profile bio or editing a specific wiki page. The chances of two admins editing the exact same paragraph at the exact same second are very low.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-benefits-zero-locking-overhead">The Benefits: Zero Locking Overhead<a href="#the-benefits-zero-locking-overhead" class="hash-link" aria-label="Direct link to The Benefits: Zero Locking Overhead" title="Direct link to The Benefits: Zero Locking Overhead" translate="no">​</a></h2>
<p>The primary benefit of optimistic locking is that it is <strong>lock-free during the &quot;think time&quot;</strong>.</p>
<p>In a Pessimistic setup, the database holds a lock from the moment you run <code>SELECT ... FOR UPDATE</code> until you <code>COMMIT</code>. If your application server is slow, or if the user is taking time to fill out a form, that database row is frozen. No one can read it.</p>
<p>With Optimistic locking:</p>
<ol>
<li class=""><strong>High Concurrency:</strong> Threads or users are never blocked during the read phase.</li>
<li class=""><strong>Scalability:</strong> Because there are no long-held locks, the database doesn&#x27;t have to maintain a heavy lock graph or check for deadlocks.</li>
<li class=""><strong>No Deadlocks:</strong> Since you aren&#x27;t holding resources while waiting for others, the classic deadlock scenarios (A waits for B, B waits for A) are virtually eliminated in the application logic.</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-downsides-latency-and-retries">The Downsides: Latency and Retries<a href="#the-downsides-latency-and-retries" class="hash-link" aria-label="Direct link to The Downsides: Latency and Retries" title="Direct link to The Downsides: Latency and Retries" translate="no">​</a></h2>
<p>While &quot;lock-free&quot; sounds perfect, Optimistic locking introduces its own penalties, particularly when conflicts <em>do</em> occur.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="a-the-read-modify-write-latency">A) The &quot;Read-Modify-Write&quot; Latency<a href="#a-the-read-modify-write-latency" class="hash-link" aria-label="Direct link to A) The &quot;Read-Modify-Write&quot; Latency" title="Direct link to A) The &quot;Read-Modify-Write&quot; Latency" translate="no">​</a></h3>
<p>Optimistic locking strictly requires a round-trip pattern:</p>
<ol>
<li class="">Network Call 1: Fetch data (Read version).</li>
<li class="">App Logic: Compute.</li>
<li class="">Network Call 2: Update data.</li>
</ol>
<p>You cannot simply fire a &quot;blind write&quot; to the database. You must know the state before you change it. This adds network latency compared to simple &quot;fire and forget&quot; updates.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="b-the-cost-of-retries">B) The Cost of Retries<a href="#b-the-cost-of-retries" class="hash-link" aria-label="Direct link to B) The Cost of Retries" title="Direct link to B) The Cost of Retries" translate="no">​</a></h3>
<p>This is the most significant hidden cost. When an optimistic lock fails (returns 0 rows updated), the application cannot simply crash; it must <strong>Retry</strong>.</p>
<p>A retry loop looks like this:</p>
<ol>
<li class="">Read Data (Latency).</li>
<li class="">Compute (CPU).</li>
<li class="">Update Fails.</li>
<li class=""><strong>Repeat Step 1.</strong></li>
</ol>
<p>If you have a system with moderate contention, you might do this loop 3 or 4 times before succeeding. This wastes:</p>
<ul>
<li class=""><strong>DB IO:</strong> Reading the same row multiple times.</li>
<li class=""><strong>App CPU:</strong> Recalculating the logic multiple times.</li>
<li class=""><strong>Network Bandwidth:</strong> Sending the same data back and forth.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-conclusion-why-non-contention-is-key">5. Conclusion: Why Non-Contention is Key<a href="#5-conclusion-why-non-contention-is-key" class="hash-link" aria-label="Direct link to 5. Conclusion: Why Non-Contention is Key" title="Direct link to 5. Conclusion: Why Non-Contention is Key" translate="no">​</a></h2>
<p>Given the penalties of retrying, <strong>Optimistic Locking should only be used when you expect the update to succeed 95% to 99% of the time.</strong></p>
<p>If your system expects frequent collisions, the cost of retrying (thrashing) will outweigh the cost of simply queuing users with a Pessimistic Lock. However, for the vast majority of web applications (CMS, User Profiles, E-commerce carts, Comments), actual data collisions are rare, making Optimistic Locking the most performant and scalable choice.</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/docs/blog/proxy-server">Scaling Databases with Proxy Servers</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-12-25T00:00:00.000Z">December 25, 2025</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/docs/blog/authors/ashish"><img class="avatar__photo authorImage_XqGP" src="https://github.com/arathod02.png" alt="Ashish Rathod"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/docs/blog/authors/ashish"><span class="authorName_yefp" translate="no">Ashish Rathod</span></a></div><small class="authorTitle_nd0D" title="Ex-Intuit Staff Engineer">Ex-Intuit Staff Engineer</small><div class="authorSocials_rSDt"><a href="https://www.linkedin.com/in/ashish-rathod02/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" style="--dark:#0a66c2;--light:#ffffffe6" class="authorSocialIcon_XYv3 linkedinSvg_FCgI"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453"></path></svg></a><a href="https://github.com/arathod02" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p>In the complex landscape of distributed systems, direct communication between clients and backend resources is often inefficient or insecure. Enter the <strong>Proxy Server</strong>—an intermediary that sits between the end-user clients and the resources they intend to browse or access.</p>
<p>In the context of database architecture, a database proxy abstracts the underlying database topology from the application layer. Instead of applications connecting directly to a specific database instance (like a primary or a replica), they connect to the proxy, which then intelligently routes the query to the appropriate destination.</p>
<p>Popular examples in the relational database world include <strong>PgBouncer</strong> for PostgreSQL, which excels at connection pooling, and <strong>ProxySQL</strong> or <strong>MaxScale</strong> for MySQL, which provide advanced features like query routing, caching, and failover management.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="benefits-of-using-a-proxy-server">Benefits of Using a Proxy Server<a href="#benefits-of-using-a-proxy-server" class="hash-link" aria-label="Direct link to Benefits of Using a Proxy Server" title="Direct link to Benefits of Using a Proxy Server" translate="no">​</a></h2>
<p>Implementing a proxy server in your database architecture offers several robust advantages:</p>
<ul>
<li class="">
<p><strong>Connection Pooling and Multiplexing</strong>
Opening and closing database connections is an expensive operation. Proxies maintain a pool of open connections to the backend databases and reuse them for multiple client requests (multiplexing). This drastically reduces the connection overhead on the database server, allowing it to dedicate more resources to executing queries rather than managing network handshakes.</p>
</li>
<li class="">
<p><strong>Load Balancing and Read/Write Splitting</strong>
Proxies can distribute incoming traffic across multiple database nodes. By identifying the type of query (e.g., specific <code>SELECT</code> statements versus <code>INSERT</code>/<code>UPDATE</code>s), the proxy can automatically route write operations to the primary node and read operations to read replicas. This ensures optimal resource utilization and prevents a single node from becoming a bottleneck.</p>
</li>
<li class="">
<p><strong>High Availability and Failover</strong>
A proxy creates an abstraction layer that insulates the application from database failures. If a database node goes down, the proxy detects the failure and immediately stops sending traffic to that node, rerouting it to healthy instances. This failover happens transparently to the application, which continues to communicate with the proxy without realizing the backend topology has changed.</p>
</li>
<li class="">
<p><strong>Query Caching</strong>
Some advanced proxies can cache the results of frequently executed queries in their own memory. If a client requests data that is already cached, the proxy serves the result instantly without ever hitting the backend database. This significantly reduces latency for the application and lowers the load on the database server.</p>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="deep-dive-proxysql-for-mysql">Deep Dive: ProxySQL for MySQL<a href="#deep-dive-proxysql-for-mysql" class="hash-link" aria-label="Direct link to Deep Dive: ProxySQL for MySQL" title="Direct link to Deep Dive: ProxySQL for MySQL" translate="no">​</a></h2>
<p>ProxySQL is a high-performance, open-source proxy for MySQL (and forks like Percona Server and MariaDB). It is uniquely designed to solve the challenges of high-traffic, highly available database clusters. Unlike simple connection poolers, ProxySQL understands the SQL protocol, allowing it to inspect queries and make intelligent routing decisions based on the actual SQL content, user, or schema.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-scenario-elastic-scaling-for-burst-traffic">The Scenario: Elastic Scaling for Burst Traffic<a href="#the-scenario-elastic-scaling-for-burst-traffic" class="hash-link" aria-label="Direct link to The Scenario: Elastic Scaling for Burst Traffic" title="Direct link to The Scenario: Elastic Scaling for Burst Traffic" translate="no">​</a></h3>
<p>Let&#x27;s weave our exploration around a specific, common business scenario:</p>
<blockquote>
<p><strong>The Use Case:</strong> Imagine an e-commerce platform that experiences a massive surge in traffic only during &quot;Flash Sales&quot; (e.g., 6 PM to 8 PM). During these hours, read traffic spikes by 10x.</p>
<p><strong>The Strategy:</strong> To handle this cost-effectively, we want an <strong>elastic database topology</strong>. We will spin up additional Read Replicas specifically for the flash sale window and tear them down afterward.</p>
<p><strong>The Challenge:</strong> We need to add and remove these database nodes dynamically <em>without</em> changing application code, <em>without</em> redeploying the app, and <em>without</em> any downtime.</p>
</blockquote>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="using-mysql-to-distribute-and-divert-traffic">Using MySQL to Distribute and Divert Traffic<a href="#using-mysql-to-distribute-and-divert-traffic" class="hash-link" aria-label="Direct link to Using MySQL to Distribute and Divert Traffic" title="Direct link to Using MySQL to Distribute and Divert Traffic" translate="no">​</a></h2>
<p>ProxySQL manages backend servers using <strong>Hostgroups</strong>. A hostgroup is simply a logical grouping of database servers (e.g., Hostgroup 10 for Writers, Hostgroup 20 for Readers).</p>
<p>Let&#x27;s walk through the configuration steps to achieve our elastic routing.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="a-configuring-backend-servers">a) Configuring Backend Servers<a href="#a-configuring-backend-servers" class="hash-link" aria-label="Direct link to a) Configuring Backend Servers" title="Direct link to a) Configuring Backend Servers" translate="no">​</a></h3>
<p>First, we define our backend servers in the <code>mysql_servers</code> table.</p>
<ul>
<li class=""><strong>Hostgroup 10:</strong> The Primary Writer (High consistency).</li>
<li class=""><strong>Hostgroup 20:</strong> The Permanent Readers.</li>
<li class=""><strong>Hostgroup 30:</strong> The &quot;Flash Sale&quot; Elastic Readers (only active during surges).</li>
</ul>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Connect to ProxySQL Admin interface (usually port 6032)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Insert the Writer (Primary)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> mysql_servers </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hostgroup_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hostname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;db-primary&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3306</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Insert the Permanent Reader</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> mysql_servers </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hostgroup_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hostname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;db-reader-permanent&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3306</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Insert the Elastic Readers (initially can be offline or added dynamically)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> mysql_servers </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hostgroup_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hostname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;db-reader-elastic-1&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3306</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="b-significance-of-load-mysql-servers">b) Significance of LOAD MYSQL SERVERS<a href="#b-significance-of-load-mysql-servers" class="hash-link" aria-label="Direct link to b) Significance of LOAD MYSQL SERVERS" title="Direct link to b) Significance of LOAD MYSQL SERVERS" translate="no">​</a></h3>
<p>When you run the <code>INSERT</code> commands above, you are modifying the configuration in <strong>Memory</strong> (specifically, the <code>main</code> database in memory). These changes are not yet effective for live traffic.</p>
<p>To apply these changes to the runtime engine (the part of ProxySQL actually handling traffic), you must run:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">LOAD</span><span class="token plain"> MYSQL SERVERS </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> RUNTIME</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>This command acts as a &quot;commit&quot; to the running process. It tells ProxySQL to start using the new server list immediately without restarting the service.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="c-significance-of-save-mysql-servers">c) Significance of SAVE MYSQL SERVERS<a href="#c-significance-of-save-mysql-servers" class="hash-link" aria-label="Direct link to c) Significance of SAVE MYSQL SERVERS" title="Direct link to c) Significance of SAVE MYSQL SERVERS" translate="no">​</a></h3>
<p>While <code>LOAD</code> pushes changes to runtime, it does not persist them to disk. If ProxySQL restarts, all changes in memory are lost. To ensure your configuration survives a reboot, you must save them to the internal SQLite database file on disk:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SAVE</span><span class="token plain"> MYSQL SERVERS </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DISK</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="d-adding-more-replicas-scaling-out">d) Adding More Replicas (Scaling Out)<a href="#d-adding-more-replicas-scaling-out" class="hash-link" aria-label="Direct link to d) Adding More Replicas (Scaling Out)" title="Direct link to d) Adding More Replicas (Scaling Out)" translate="no">​</a></h3>
<p>When the &quot;Flash Sale&quot; begins, your orchestration tool (like Terraform or Kubernetes) provisions new DB replicas. To register them with ProxySQL:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Adding new elastic nodes for the surge</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> mysql_servers </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hostgroup_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hostname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;db-reader-elastic-2&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3306</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> mysql_servers </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hostgroup_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hostname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;db-reader-elastic-3&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3306</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Apply changes instantly</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LOAD</span><span class="token plain"> MYSQL SERVERS </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> RUNTIME</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SAVE</span><span class="token plain"> MYSQL SERVERS </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DISK</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><em>The application knows nothing about these new IPs; it just continues talking to ProxySQL.</em></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="e-significance-of-mysql_query_rules">e) Significance of mysql_query_rules<a href="#e-significance-of-mysql_query_rules" class="hash-link" aria-label="Direct link to e) Significance of mysql_query_rules" title="Direct link to e) Significance of mysql_query_rules" translate="no">​</a></h3>
<p>The real magic happens in the <code>mysql_query_rules</code> table. This acts as a firewall and router combined. You define rules that match specific criteria (regex on the query, username, schema name, etc.) and assign an action, such as assigning a <code>destination_hostgroup</code>.</p>
<p>ProxySQL evaluates rules in order of their <code>rule_id</code>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="f-routing-based-on-query-type-readwrite-split">f) Routing Based on Query Type (Read/Write Split)<a href="#f-routing-based-on-query-type-readwrite-split" class="hash-link" aria-label="Direct link to f) Routing Based on Query Type (Read/Write Split)" title="Direct link to f) Routing Based on Query Type (Read/Write Split)" translate="no">​</a></h3>
<p>A classic rule is to send all <code>SELECT</code> queries to the reader groups (Hostgroup 20 and 30) and everything else to the writer (Hostgroup 10).</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Rule: Direct all SELECT statements to Hostgroup 20 (Readers)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> mysql_query_rules </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rule_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> active</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> match_digest</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> destination_hostgroup</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">apply</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic">-- rule_id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                   </span><span class="token comment" style="color:#999988;font-style:italic">-- active</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;^SELECT.*&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">-- match_digest (Regex for queries starting with SELECT)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                  </span><span class="token comment" style="color:#999988;font-style:italic">-- destination_hostgroup (Permanent Readers)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">-- apply (Stop processing further rules if this matches)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LOAD</span><span class="token plain"> MYSQL QUERY RULES </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> RUNTIME</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SAVE</span><span class="token plain"> MYSQL QUERY RULES </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DISK</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><em>Note: In production, you might set up a &quot;Replication Lag&quot; check so ProxySQL doesn&#x27;t send queries to readers that are too far behind the writer.</em></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="g-routing-based-on-schema-analytics-vs-transactions">g) Routing Based on Schema (Analytics vs. Transactions)<a href="#g-routing-based-on-schema-analytics-vs-transactions" class="hash-link" aria-label="Direct link to g) Routing Based on Schema (Analytics vs. Transactions)" title="Direct link to g) Routing Based on Schema (Analytics vs. Transactions)" translate="no">​</a></h3>
<p>Suppose you have a specific schema <code>analytics_db</code> that runs heavy aggregation queries. You don&#x27;t want these blocking your transactional users. You can route traffic hitting this specific schema to the elastic hostgroup (Hostgroup 30).</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Rule: Direct traffic for schema &#x27;analytics_db&#x27; to Hostgroup 30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> mysql_query_rules </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rule_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> active</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> schemaname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> destination_hostgroup</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">apply</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                  </span><span class="token comment" style="color:#999988;font-style:italic">-- Lower ID = Higher Priority than the generic SELECT rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;analytics_db&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">-- Exact match on schema name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                  </span><span class="token comment" style="color:#999988;font-style:italic">-- Elastic/Analytics Readers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LOAD</span><span class="token plain"> MYSQL QUERY RULES </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> RUNTIME</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SAVE</span><span class="token plain"> MYSQL QUERY RULES </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DISK</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="h-commenthint-based-routing">h) Comment/Hint Based Routing<a href="#h-commenthint-based-routing" class="hash-link" aria-label="Direct link to h) Comment/Hint Based Routing" title="Direct link to h) Comment/Hint Based Routing" translate="no">​</a></h3>
<p>Sometimes regex isn&#x27;t enough. You might have a critical <code>SELECT</code> statement (e.g., checking inventory before checkout) that <em>must</em> go to the Writer (Hostgroup 10) to ensure strong consistency, bypassing the replica entirely.</p>
<p>Developers can inject a SQL comment (hint) into the query, and ProxySQL can route based on that comment.</p>
<p><strong>Example Query from Application:</strong></p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* forceful_write */</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> quantity </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> products </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">101</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><strong>ProxySQL Rule:</strong></p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- Rule: If query contains &quot;forceful_write&quot;, send to Writer (HG 10)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> mysql_query_rules </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rule_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> active</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> match_digest</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> destination_hostgroup</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">apply</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                  </span><span class="token comment" style="color:#999988;font-style:italic">-- Highest Priority</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;forceful_write&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Regex matching the comment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                  </span><span class="token comment" style="color:#999988;font-style:italic">-- Writer Hostgroup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LOAD</span><span class="token plain"> MYSQL QUERY RULES </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> RUNTIME</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SAVE</span><span class="token plain"> MYSQL QUERY RULES </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DISK</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>This gives developers granular control over routing without hardcoding IP addresses in the application.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="deployment-of-proxysql">Deployment of ProxySQL<a href="#deployment-of-proxysql" class="hash-link" aria-label="Direct link to Deployment of ProxySQL" title="Direct link to Deployment of ProxySQL" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-fleet-of-proxysql-fronted-by-a-load-balancer">1. Fleet of ProxySQL Fronted by a Load Balancer<a href="#1-fleet-of-proxysql-fronted-by-a-load-balancer" class="hash-link" aria-label="Direct link to 1. Fleet of ProxySQL Fronted by a Load Balancer" title="Direct link to 1. Fleet of ProxySQL Fronted by a Load Balancer" translate="no">​</a></h3>
<p>In this topology, you run multiple independent ProxySQL instances behind a classic Load Balancer (like AWS NLB or HAProxy).</p>
<!-- -->
<ul>
<li class=""><strong>Advantages:</strong>
<ul>
<li class=""><strong>Simple to understand:</strong> Each ProxySQL node is independent.</li>
<li class=""><strong>High Availability:</strong> If one ProxySQL node dies, the Load Balancer removes it.</li>
</ul>
</li>
<li class=""><strong>Disadvantages:</strong>
<ul>
<li class=""><strong>Configuration Drift:</strong> If you add a new query rule to <code>ProxySQL A</code>, you must manually apply the exact same SQL commands to <code>ProxySQL B</code> and <code>C</code>. Automation tools (Ansible/Chef) are required to keep them in sync.</li>
<li class=""><strong>Split Brain Risks:</strong> If configurations diverge, users might get different results depending on which proxy the Load Balancer hits.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-proxysql-cluster-mode-native-clustering">2. ProxySQL Cluster Mode (Native Clustering)<a href="#2-proxysql-cluster-mode-native-clustering" class="hash-link" aria-label="Direct link to 2. ProxySQL Cluster Mode (Native Clustering)" title="Direct link to 2. ProxySQL Cluster Mode (Native Clustering)" translate="no">​</a></h3>
<p>ProxySQL supports native clustering. You configure the instances to form a cluster, and they automatically synchronize their configuration.</p>
<!-- -->
<ul>
<li class=""><strong>Advantages:</strong>
<ul>
<li class=""><strong>Auto-Synchronization:</strong> You only need to run the <code>INSERT</code> and <code>LOAD</code> commands on <em>one</em> node. The changes are automatically propagated to all other nodes in the cluster.</li>
<li class=""><strong>Management Ease:</strong> Drastically reduces the operational overhead of managing a large fleet.</li>
</ul>
</li>
<li class=""><strong>Disadvantages:</strong>
<ul>
<li class=""><strong>Complexity:</strong> Setting up the internal cluster network requires careful configuration.</li>
<li class=""><strong>Network Overhead:</strong> There is a small amount of traffic between proxies for synchronization.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="elastic-topology-visualization">Elastic Topology Visualization<a href="#elastic-topology-visualization" class="hash-link" aria-label="Direct link to Elastic Topology Visualization" title="Direct link to Elastic Topology Visualization" translate="no">​</a></h2>
<p>Here is how our Elastic/Flash Sale setup looks. The application connects to ProxySQL, which handles the dynamic routing to the elastic fleet.</p>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="aws-aurora-alternative-custom-endpoints">AWS Aurora Alternative: Custom Endpoints<a href="#aws-aurora-alternative-custom-endpoints" class="hash-link" aria-label="Direct link to AWS Aurora Alternative: Custom Endpoints" title="Direct link to AWS Aurora Alternative: Custom Endpoints" translate="no">​</a></h2>
<p>If you are hosted specifically on AWS Aurora, you might not always need an external layer like ProxySQL for basic traffic segregation. Aurora offers a native feature called <strong>Custom Endpoints</strong>.</p>
<p>In the AWS Aurora ecosystem, <strong>Custom Endpoints</strong> offer a native alternative to external proxies for routing traffic to specific groups of database instances. Unlike the standard Cluster Reader Endpoint which cycles through <em>all</em> available replicas, a Custom Endpoint allows you to arbitrarily group specific instances—such as high-performance nodes—into a distinct VIP. When an application connects to this custom DNS name, Aurora performs DNS-based load balancing to distribute connections across only the pre-selected instances in that group. This feature is ideal for isolating workloads; for example, you can direct heavy analytical reports to a specific set of larger instances while keeping fast transactional reads on smaller instances for the web application. Because it operates at the DNS level, it provides instance-level isolation but lacks the granular query-level routing rules (regex parsing) found in tools like ProxySQL. It simplifies infrastructure management by removing the need for an intermediate proxy layer when simple instance grouping satisfies the routing requirements.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="visualizing-aurora-custom-endpoints">Visualizing Aurora Custom Endpoints<a href="#visualizing-aurora-custom-endpoints" class="hash-link" aria-label="Direct link to Visualizing Aurora Custom Endpoints" title="Direct link to Visualizing Aurora Custom Endpoints" translate="no">​</a></h3>
<p>The following diagram illustrates how a Custom Endpoint acts as a specific entry point, load balancing traffic across a dedicated subset of readers, separate from the general traffic.</p>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate="no">​</a></h3>
<p>By leveraging ProxySQL, we effectively decoupled our application from the database infrastructure. We achieved the ability to &quot;burst&quot; our read capacity by adding elastic nodes (Hostgroup 30) and routing heavy traffic to them via <code>mysql_query_rules</code>. All of this happened transparently to the application, ensuring high availability and cost efficiency during peak business hours.</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/docs/blog/server-sent-events-explained">Real-Time Communication with Server-Sent Events (SSE)</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-12-25T00:00:00.000Z">December 25, 2025</time> · <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/docs/blog/authors/ashish"><img class="avatar__photo authorImage_XqGP" src="https://github.com/arathod02.png" alt="Ashish Rathod"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/docs/blog/authors/ashish"><span class="authorName_yefp" translate="no">Ashish Rathod</span></a></div><small class="authorTitle_nd0D" title="Ex-Intuit Staff Engineer">Ex-Intuit Staff Engineer</small><div class="authorSocials_rSDt"><a href="https://www.linkedin.com/in/ashish-rathod02/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" style="--dark:#0a66c2;--light:#ffffffe6" class="authorSocialIcon_XYv3 linkedinSvg_FCgI"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453"></path></svg></a><a href="https://github.com/arathod02" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p>In the world of web development, the classic request-response model serves us well for most interactions. The client asks for data, and the server provides it. But what happens when the server has new data <em>after</em> the initial request? How do we push updates to the client in real-time?</p>
<p>While WebSockets are a popular choice for bi-directional communication, they can be overkill for many scenarios. Enter <strong>Server-Sent Events (SSE)</strong>—a standard that allows servers to push data to web pages over a single HTTP connection.</p>
<p>In this post, we will explore what SSE is, typical use cases, the underlying protocol, and a practical implementation using Python and Flask.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-what-is-server-sent-events-sse">1. What is Server-Sent Events (SSE)?<a href="#1-what-is-server-sent-events-sse" class="hash-link" aria-label="Direct link to 1. What is Server-Sent Events (SSE)?" title="Direct link to 1. What is Server-Sent Events (SSE)?" translate="no">​</a></h2>
<p>Server-Sent Events (SSE) is a technology that enables a client (usually a browser) to receive automatic updates from a server via an HTTP connection. It creates a unidirectional channel: the client opens the connection, and the server keeps it open, pushing text-based messages whenever new data is available.</p>
<p>Think of it like subscribing to a newsletter. You sign up once (the HTTP request), and the publisher sends you updates continuously as they happen, without you needing to ask for them again.</p>
<p><strong>Key Characteristics:</strong></p>
<ul>
<li class=""><strong>Unidirectional:</strong> Server -&gt; Client only.</li>
<li class=""><strong>Standard HTTP:</strong> Works over standard HTTP/HTTPS.</li>
<li class=""><strong>Text-Based:</strong> Sends data as UTF-8 text.</li>
<li class=""><strong>Automatic Reconnection:</strong> Browsers automatically attempt to reconnect if the connection drops.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-typical-use-cases">2. Typical Use Cases<a href="#2-typical-use-cases" class="hash-link" aria-label="Direct link to 2. Typical Use Cases" title="Direct link to 2. Typical Use Cases" translate="no">​</a></h2>
<p>Since SSE is unidirectional, it is perfect for scenarios where the client needs to be updated, but doesn&#x27;t need to send high-frequency data back to the server.</p>
<ul>
<li class=""><strong>Live Log Streaming:</strong> Viewing server logs in real-time (as we will see in our example code).</li>
<li class=""><strong>Stock Tickers &amp; Crypto Prices:</strong> Updating dashboards with the latest financial data.</li>
<li class=""><strong>Progress Indicators:</strong> Showing the progress of long-running tasks (e.g., file uploads, video processing).</li>
<li class=""><strong>Sports Scores:</strong> Live updates during a match.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-the-protocol-of-server-sent-events">3. The Protocol of Server-Sent Events<a href="#3-the-protocol-of-server-sent-events" class="hash-link" aria-label="Direct link to 3. The Protocol of Server-Sent Events" title="Direct link to 3. The Protocol of Server-Sent Events" translate="no">​</a></h2>
<p>SSE is deceptively simple. It sits on top of HTTP. Here is how the handshake and data transfer work:</p>
<ol>
<li class=""><strong>The Request:</strong> The client sends a standard GET request.</li>
<li class=""><strong>The Headers:</strong> The server responds with specific headers to keep the connection open:<!-- -->
<ul>
<li class=""><code>Content-Type: text/event-stream</code> (Crucial: tells the client to expect a stream).</li>
<li class=""><code>Cache-Control: no-cache</code> (Prevents the browser from caching the stream).</li>
<li class=""><code>Connection: keep-alive</code> (Keeps the TCP connection open).</li>
</ul>
</li>
<li class=""><strong>The Payload:</strong> The server sends data blocks separated by a pair of newlines (<code>\n\n</code>).</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-message-format">The Message Format<a href="#the-message-format" class="hash-link" aria-label="Direct link to The Message Format" title="Direct link to The Message Format" translate="no">​</a></h3>
<p>Each message in the stream is a block of text. The most common field is <code>data</code>.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">data: This is a message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data: This is the second message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><em>Note: In the raw protocol, every message must end with two newlines (<code>\n\n</code>) to signal the end of the event.</em></p>
<p>You can also include event types and IDs:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">id: 101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">event: update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data: {&quot;status&quot;: &quot;processing&quot;, &quot;progress&quot;: 50}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="visualizing-the-flow">Visualizing the Flow<a href="#visualizing-the-flow" class="hash-link" aria-label="Direct link to Visualizing the Flow" title="Direct link to Visualizing the Flow" translate="no">​</a></h3>
<p>Here is a sequence diagram showing how the Client establishes the connection and receives a stream of log data.</p>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-implementation-streaming-logs-with-python">4. Implementation: Streaming Logs with Python<a href="#4-implementation-streaming-logs-with-python" class="hash-link" aria-label="Direct link to 4. Implementation: Streaming Logs with Python" title="Direct link to 4. Implementation: Streaming Logs with Python" translate="no">​</a></h2>
<p>Let&#x27;s look at a practical implementation. Below is a Python script using <code>Flask</code>. It simulates a system where logs are being written to a file in the background, and a client listens to these logs in real-time via SSE.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="key-components-explained">Key Components Explained<a href="#key-components-explained" class="hash-link" aria-label="Direct link to Key Components Explained" title="Direct link to Key Components Explained" translate="no">​</a></h3>
<p>There are two critical parts in the code that make SSE work:</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-the-generator-function-read_log_stream">1. The Generator Function (<code>read_log_stream</code>)<a href="#1-the-generator-function-read_log_stream" class="hash-link" aria-label="Direct link to 1-the-generator-function-read_log_stream" title="Direct link to 1-the-generator-function-read_log_stream" translate="no">​</a></h4>
<p>Standard HTTP requests return a block of data and close. To stream, Python uses <strong>generators</strong> (functions that <code>yield</code> instead of <code>return</code>).</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">read_log_stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ... setup code ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Check for new data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> new_lines</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> line </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> new_lines</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic"># Format specifically for SSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token keyword" style="color:#00009f">yield</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;data: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">line</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">rstrip</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">\n\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic"># Wait briefly to prevent 100% CPU usage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>This function keeps running. Every time it finds a new line in the log file, it pushes it out using <code>yield</code>.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-the-flask-response-stream_log">2. The Flask Response (<code>stream_log</code>)<a href="#2-the-flask-response-stream_log" class="hash-link" aria-label="Direct link to 2-the-flask-response-stream_log" title="Direct link to 2-the-flask-response-stream_log" translate="no">​</a></h4>
<p>Flask needs to know this isn&#x27;t a normal response. We pass the generator function to <code>Response</code> and set the headers.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/api/logs/&lt;log_id&gt;/stream&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methods</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;GET&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">stream_log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Response</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        read_log_stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mimetype</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;text/event-stream&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Required for SSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;Cache-Control&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;no-cache&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Prevent buffering</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;Connection&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;keep-alive&quot;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># Keep connection open</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-the-client-index-route">3. The Client (<code>index</code> route)<a href="#3-the-client-index-route" class="hash-link" aria-label="Direct link to 3-the-client-index-route" title="Direct link to 3-the-client-index-route" translate="no">​</a></h4>
<p>On the frontend (embedded in the <code>index</code> function), the <code>EventSource</code> API handles the heavy lifting.</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">eventSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">EventSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">/api/logs/</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">logId</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">/stream</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eventSource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmessage</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// This runs every time the server sends a &quot;data:&quot; packet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;New Log:&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="SSE Log Streaming" src="/docs/assets/images/sse-log-streaming-caefd8e16af0df04da8755099ff10960.png" width="1200" height="655" class="img_ev3q"></p>
<p>SSE is a powerful tool in your system design toolkit. While it doesn&#x27;t replace WebSockets for complex bidirectional needs (like a chat app), it is often the simpler, more efficient choice for one-way updates.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-code">The Code<a href="#the-code" class="hash-link" aria-label="Direct link to The Code" title="Direct link to The Code" translate="no">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> threading</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> uuid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> logging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> datetime </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> datetime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pathlib </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> flask </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Flask</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> faker </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Faker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Configure logging</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logging</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">basicConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    level</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">logging</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DEBUG</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">format</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logger </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__name__</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Flask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__name__</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fake </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Faker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Directory to store log files</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_DIR </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;../logs&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOG_DIR</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mkdir</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exist_ok</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Log directory set to: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">LOG_DIR</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">absolute</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Track active log streams</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">active_streams </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">generate_random_text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Generate random text using Faker&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    choices </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">lambda</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fake</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sentence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">lambda</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fake</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">paragraph</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">lambda</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fake</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">word</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">lambda</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;[</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">datetime</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">now</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">isoformat</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">] </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">fake</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">sentence</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> choices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">choices</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Generated random text: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">text</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">[</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">50]</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">...&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">write_to_log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Write a message to the log file&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LOG_DIR </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">.log&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_file</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;a&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Wrote to log </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">message</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">[</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">50]</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">...&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> IOError </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Failed to write to log </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">simulate_log_writing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> duration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Simulate writing to log file for a given duration&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Starting log writing thread for log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, duration=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">duration</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">s&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end_time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> duration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    write_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> end_time</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> generate_random_text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        write_to_log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        write_count </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Write every 500ms</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Finished log writing for log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">. Total lines written: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">write_count</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">read_log_stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Generator that streams log content&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LOG_DIR </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">.log&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Starting log stream for log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> log_file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exists</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Log file not found for log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">yield</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;data: Log file </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> not found\n\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Start reading from beginning</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    position </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    line_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_file</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;r&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">seek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">position</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                lines </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">readlines</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> lines</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> line </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> lines</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic"># Protocol: Prefix with &quot;data: &quot; and end with double newline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">yield</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;data: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">line</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">rstrip</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">\n\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        line_count </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    position </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Streamed </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">lines</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> lines for log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, position=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">position</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic"># No new data, check if log is still being written</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic"># In a real app, you might have a mechanism to break if the process is dead</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;No new data for log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, waiting...&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> IOError </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Error reading log file for log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">yield</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;data: Error reading log file\n\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Finished streaming log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">. Total lines streamed: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">line_count</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/api/logs&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methods</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;POST&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">create_log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Create a new log file and start streaming random content to it.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Returns the log ID for later reference.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uuid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">uuid4</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LOG_DIR </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">.log&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Creating new log with log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Create empty log file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">touch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Log file created at: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_file</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">absolute</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Write initial message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    write_to_log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;[LOG CREATED] </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">datetime</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">now</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">isoformat</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Start background thread to write random content</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    duration </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;duration&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">type</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Starting background thread for log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> with duration=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">duration</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">s&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    thread </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> threading</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Thread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        target</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">simulate_log_writing</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        args</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> duration</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        daemon</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Thread started for log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;log_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> log_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;message&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Log file created with ID: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;stream_url&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;/api/logs/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/stream&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">201</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/api/logs/&lt;log_id&gt;/stream&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methods</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;GET&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">stream_log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Stream the log file content using Server-Sent Events.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Reads from the beginning and continuously streams new content.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Stream request received for log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LOG_DIR </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">.log&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> log_file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exists</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Stream request for non-existent log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">error_stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">yield</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;data: Log file </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> not found\n\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Response</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error_stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mimetype</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;text/event-stream&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Starting SSE stream for log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Response</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        read_log_stream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mimetype</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;text/event-stream&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;Cache-Control&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;no-cache&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;X-Accel-Buffering&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;no&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;Connection&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;keep-alive&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/api/logs/&lt;log_id&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methods</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;GET&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_log_info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Get information about a specific log file&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Info request received for log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LOG_DIR </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">.log&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> log_file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exists</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Info request for non-existent log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;error&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Log file </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> not found&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">404</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> log_file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">st_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    created_at </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fromtimestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">st_ctime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isoformat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Log info for log_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">: size=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">file_size</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, created=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">created_at</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;log_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> log_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;file_size&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> file_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;created_at&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> created_at</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;stream_url&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;/api/logs/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">log_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/stream&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methods</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;GET&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Serve a simple HTML client for testing&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;title&gt;Log Streaming PoC&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;style&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            body { font-family: monospace; margin: 20px; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            button { padding: 10px 20px; margin: 10px 0; cursor: pointer; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            #log-container { </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                border: 1px solid #ccc; </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                padding: 10px; </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                height: 400px; </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                overflow-y: auto; </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                background: #f5f5f5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                margin: 10px 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            .log-line { margin: 2px 0; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            .status { padding: 10px; border-radius: 5px; margin: 10px 0; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            .status.success { background: #d4edda; color: #155724; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            .status.error { background: #f8d7da; color: #721c24; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;/style&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;/head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;h1&gt;Log Streaming Proof of Concept&lt;/h1&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            &lt;button onclick=&quot;createLog()&quot;&gt;Create New Log&lt;/button&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            &lt;input type=&quot;number&quot; id=&quot;duration&quot; placeholder=&quot;Duration (seconds)&quot; value=&quot;30&quot; min=&quot;5&quot; max=&quot;300&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;div id=&quot;status&quot;&gt;&lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            Log ID: &lt;input type=&quot;text&quot; id=&quot;log-id&quot; placeholder=&quot;Enter log ID or create new&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            &lt;button onclick=&quot;startStream()&quot;&gt;Start Streaming&lt;/button&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            &lt;button onclick=&quot;stopStream()&quot;&gt;Stop Streaming&lt;/button&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;div id=&quot;log-container&quot;&gt;&lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;script&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            let eventSource = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            async function createLog() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                const duration = document.getElementById(&#x27;duration&#x27;).value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                const statusDiv = document.getElementById(&#x27;status&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    const response = await fetch(&#x27;/api/logs?duration=&#x27; + duration, { method: &#x27;POST&#x27; });</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    const data = await response.json();</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    document.getElementById(&#x27;log-id&#x27;).value = data.log_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    statusDiv.innerHTML = `&lt;div class=&quot;status success&quot;&gt;✓ Log created: ${data.log_id}&lt;/div&gt;`;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    // Auto-start streaming</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    setTimeout(() =&gt; startStream(), 500);</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                } catch (error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    statusDiv.innerHTML = `&lt;div class=&quot;status error&quot;&gt;✗ Error: ${error.message}&lt;/div&gt;`;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            function startStream() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                const logId = document.getElementById(&#x27;log-id&#x27;).value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                const statusDiv = document.getElementById(&#x27;status&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                if (!logId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    statusDiv.innerHTML = &#x27;&lt;div class=&quot;status error&quot;&gt;✗ Please create or enter a log ID&lt;/div&gt;&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                if (eventSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    eventSource.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                const logContainer = document.getElementById(&#x27;log-container&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                logContainer.innerHTML = &#x27;&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                eventSource = new EventSource(`/api/logs/${logId}/stream`);</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                statusDiv.innerHTML = `&lt;div class=&quot;status success&quot;&gt;✓ Streaming logs...&lt;/div&gt;`;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                eventSource.onmessage = function(event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    const line = document.createElement(&#x27;div&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    line.className = &#x27;log-line&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    line.textContent = event.data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    logContainer.appendChild(line);</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    logContainer.scrollTop = logContainer.scrollHeight;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                };</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                eventSource.onerror = function(error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    statusDiv.innerHTML = &#x27;&lt;div class=&quot;status error&quot;&gt;✗ Streaming stopped&lt;/div&gt;&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    eventSource.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                };</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            function stopStream() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                if (eventSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    eventSource.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    eventSource = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                document.getElementById(&#x27;status&#x27;).innerHTML = &#x27;&lt;div class=&quot;status&quot;&gt;Streaming stopped&lt;/div&gt;&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;/script&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;/body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;/html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;__main__&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;=&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Starting Log Streaming PoC Service...&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;=&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Starting Log Streaming PoC Service...&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Open http://localhost:5000 in your browser&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Service listening on [http://127.0.0.1:5000](http://127.0.0.1:5000)&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">debug</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5000</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/docs/blog/application-level-sharding-design">Implementing Shard Aware Application</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-12-14T00:00:00.000Z">December 14, 2025</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/docs/blog/authors/ashish"><img class="avatar__photo authorImage_XqGP" src="https://github.com/arathod02.png" alt="Ashish Rathod"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/docs/blog/authors/ashish"><span class="authorName_yefp" translate="no">Ashish Rathod</span></a></div><small class="authorTitle_nd0D" title="Ex-Intuit Staff Engineer">Ex-Intuit Staff Engineer</small><div class="authorSocials_rSDt"><a href="https://www.linkedin.com/in/ashish-rathod02/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" style="--dark:#0a66c2;--light:#ffffffe6" class="authorSocialIcon_XYv3 linkedinSvg_FCgI"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453"></path></svg></a><a href="https://github.com/arathod02" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p>In my previous <a class="" href="/docs/blog/scaling-distributed-systems">post</a>, we explored the high-level strategies for scaling databases, touching upon vertical scaling, read replicas, and finally, sharding. Today, I want to double-click on <strong>Sharding</strong>, specifically focusing on the <strong>Application-Level Sharding</strong> strategy.</p>
<p>We often talk about &quot;making the application shard-aware,&quot; but what does that look like in code? How do we manage thousands of connections without overwhelming the application or the database? How do we handle re-sharding without downtime?</p>
<p>In this post, I will walk you through a battle-tested architecture we implemented at a previous organization, where we managed multi-tenant data at scale using a custom <strong>Data Access Layer (DAL)</strong>.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-metadata-control-plane">The Metadata Control Plane<a href="#the-metadata-control-plane" class="hash-link" aria-label="Direct link to The Metadata Control Plane" title="Direct link to The Metadata Control Plane" translate="no">​</a></h2>
<p>To build a robust shard-aware application, you cannot hardcode connection strings or shard logic. You need a dynamic <strong>Control Plane</strong>. We solved this by externalizing our topology into two DynamoDB tables.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-database-metadata">1. Database Metadata<a href="#1-database-metadata" class="hash-link" aria-label="Direct link to 1. Database Metadata" title="Direct link to 1. Database Metadata" translate="no">​</a></h3>
<p>This table acts as the source of truth for the physical infrastructure. It decouples the <em>logical</em> definition of a database from its <em>physical</em> connection details.</p>
<ul>
<li class=""><strong>Key:</strong> <code>ShardName</code> + <code>DatabaseName</code></li>
<li class=""><strong>Attributes:</strong>
<ul>
<li class=""><code>ConnectionDetails</code> (JSON): Contains endpoints for different use cases (Write, Read, Analytics), credentials, and schema names.</li>
<li class=""><code>CapacityMetrics</code>: Tracks the current load (e.g., number of Small/Medium/Large tenants) to aid in placement decisions for new tenants.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-tenant-metadata">2. Tenant Metadata<a href="#2-tenant-metadata" class="hash-link" aria-label="Direct link to 2. Tenant Metadata" title="Direct link to 2. Tenant Metadata" translate="no">​</a></h3>
<p>This table serves as the routing directory. It maps a specific tenant to a logical shard.</p>
<ul>
<li class=""><strong>Key:</strong> <code>TenantID</code></li>
<li class=""><strong>Attributes:</strong>
<ul>
<li class=""><code>ShardName</code>: The logical shard where this tenant resides.</li>
<li class=""><code>DatabaseName</code>: The specific database instance within that shard.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-logical-relationship">The Logical Relationship<a href="#the-logical-relationship" class="hash-link" aria-label="Direct link to The Logical Relationship" title="Direct link to The Logical Relationship" translate="no">​</a></h3>
<p>By splitting these concerns, we create a normalized view of our topology. The Tenant Metadata points to a logical location, and the Database Metadata resolves that location to physical credentials.</p>
<!-- -->
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-bootup-sequence-initializedb">The Bootup Sequence: <code>initializeDB()</code><a href="#the-bootup-sequence-initializedb" class="hash-link" aria-label="Direct link to the-bootup-sequence-initializedb" title="Direct link to the-bootup-sequence-initializedb" translate="no">​</a></h2>
<p>Efficiency is paramount. We cannot fetch connection details from DynamoDB for every single query. Instead, we cache and initialize heavy resources during application startup.</p>
<p>When the application boots, the <strong>Data Access Layer (DAL)</strong> performs the following <code>initializeDB()</code> routine:</p>
<ol>
<li class=""><strong>Fetch Topology:</strong> It scans the <code>Database Metadata</code> table to understand the entire available fleet.</li>
<li class=""><strong>Pool Creation:</strong> For every unique combination of <code>Shard</code> + <code>Database</code> + <code>UseCase</code> (Read/Write), it initializes a connection pool (e.g., HikariCP).</li>
<li class=""><strong>In-Memory Map:</strong> These pools are stored in a concurrent map, keyed by the logical topology identifier.</li>
</ol>
<p>This ensures that all expensive TCP handshakes are done eagerly, and the app is ready to serve traffic immediately upon becoming healthy.</p>
<!-- -->
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="runtime-request-handling-getconnectiontenantid">Runtime Request Handling: <code>getConnection(tenantId)</code><a href="#runtime-request-handling-getconnectiontenantid" class="hash-link" aria-label="Direct link to runtime-request-handling-getconnectiontenantid" title="Direct link to runtime-request-handling-getconnectiontenantid" translate="no">​</a></h2>
<p>Once the application is running, the focus shifts to low-latency routing. When a request comes in for <code>Tenant-123</code>, the DAL needs to find the correct connection seamlessly.</p>
<p>The API exposed to the upper layers is simple: <code>getConnection(Long tenantId)</code>.</p>
<ol>
<li class=""><strong>Lookup:</strong> The DAL queries the <code>Tenant Metadata</code> (often cached locally with a TTL) to find the <code>ShardName</code> and <code>DatabaseName</code> for the tenant.</li>
<li class=""><strong>Resolution:</strong> It constructs the lookup key for the in-memory map.</li>
<li class=""><strong>Acquisition:</strong> It borrows a connection from the pre-warmed pool and hands it to the request thread.</li>
</ol>
<!-- -->
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-strategic-benefits">The Strategic Benefits<a href="#the-strategic-benefits" class="hash-link" aria-label="Direct link to The Strategic Benefits" title="Direct link to The Strategic Benefits" translate="no">​</a></h2>
<p>Implementing this logic within a library provides two massive architectural advantages that go beyond simple connectivity.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-logical-representation-of-infrastructure">1. Logical Representation of Infrastructure<a href="#1-logical-representation-of-infrastructure" class="hash-link" aria-label="Direct link to 1. Logical Representation of Infrastructure" title="Direct link to 1. Logical Representation of Infrastructure" translate="no">​</a></h3>
<p>The application code never touches a raw JDBC URL.</p>
<ul>
<li class=""><strong>Scenario:</strong> You need to rotate database credentials or migrate a database to a new host URL.</li>
<li class=""><strong>Action:</strong> You simply update the JSON in the <code>Database Metadata</code> table and trigger a refresh event in the application.</li>
<li class=""><strong>Result:</strong> The DAL re-initializes the specific pool. No code deployment is required. The infrastructure is now configuration-driven.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-logical-mapping--zero-downtime-migration">2. Logical Mapping &amp; Zero-Downtime Migration<a href="#2-logical-mapping--zero-downtime-migration" class="hash-link" aria-label="Direct link to 2. Logical Mapping &amp; Zero-Downtime Migration" title="Direct link to 2. Logical Mapping &amp; Zero-Downtime Migration" translate="no">​</a></h3>
<p>The mapping between a tenant and a database is fluid, not static.</p>
<ul>
<li class=""><strong>Scenario:</strong> <code>Tenant-ABC</code> has grown too large for <code>Shard-1</code> and needs to be moved to <code>Shard-2</code>.</li>
<li class=""><strong>Action:</strong> After replicating the data to <code>Shard-2</code>, you simply update the <code>Tenant Metadata</code> table for <code>Tenant-ABC</code>.</li>
<li class=""><strong>Result:</strong> The very next request for <code>Tenant-ABC</code> will resolve to <code>Shard-2</code>. The application layer requires zero changes to support tenant migration, enabling seamless re-balancing of the fleet.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate="no">​</a></h2>
<p>Building a shard-aware application is an exercise in <strong>separation of concerns</strong>. By isolating the <em>topology</em> (Tenant Metadata) from the <em>infrastructure</em> (Database Metadata) and wrapping it all in a smart Data Access Layer, you gain the flexibility to scale, migrate, and manage your data tier without constantly refactoring your application code.</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/docs/blog/scaling-distributed-systems">Scaling Distributed Systems (Focus on Databases)</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-12-13T00:00:00.000Z">December 13, 2025</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/docs/blog/authors/ashish"><img class="avatar__photo authorImage_XqGP" src="https://github.com/arathod02.png" alt="Ashish Rathod"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/docs/blog/authors/ashish"><span class="authorName_yefp" translate="no">Ashish Rathod</span></a></div><small class="authorTitle_nd0D" title="Ex-Intuit Staff Engineer">Ex-Intuit Staff Engineer</small><div class="authorSocials_rSDt"><a href="https://www.linkedin.com/in/ashish-rathod02/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" style="--dark:#0a66c2;--light:#ffffffe6" class="authorSocialIcon_XYv3 linkedinSvg_FCgI"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453"></path></svg></a><a href="https://github.com/arathod02" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><p>In distributed systems, the four possible chokepoints that a system can run into are <strong>CPU, Memory, Network, and Disk</strong>. Whenever the system hits the thresholds on any of these chokepoints, latency increases, throughput degrades, and we typically need to scale our systems.</p>
<p>Scaling isn&#x27;t just about &quot;adding more&quot;; it&#x27;s about <em>how</em> and <em>where</em> you add capacity. Broadly, we have two strategies:</p>
<ol>
<li class=""><strong>Vertical Scaling</strong></li>
<li class=""><strong>Horizontal Scaling</strong></li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-scaling-strategies">The Scaling Strategies<a href="#the-scaling-strategies" class="hash-link" aria-label="Direct link to The Scaling Strategies" title="Direct link to The Scaling Strategies" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="vertical-scaling-scale-up">Vertical Scaling (Scale Up)<a href="#vertical-scaling-scale-up" class="hash-link" aria-label="Direct link to Vertical Scaling (Scale Up)" title="Direct link to Vertical Scaling (Scale Up)" translate="no">​</a></h3>
<p>In Vertical scaling, we aim to solve for bottlenecks by throwing more CPU, memory, disk, and network bandwidth to the application. Basically, we make the infrastructure bulky enough to handle more load and try to remain under the threshold of our resources.</p>
<p><strong>Pros:</strong> Simplifies operations (no network overhead between nodes, no distributed consensus issues).
<strong>Cons:</strong> Has a hard ceiling (hardware limits) and can get exponentially expensive.</p>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="horizontal-scaling-scale-out">Horizontal Scaling (Scale Out)<a href="#horizontal-scaling-scale-out" class="hash-link" aria-label="Direct link to Horizontal Scaling (Scale Out)" title="Direct link to Horizontal Scaling (Scale Out)" translate="no">​</a></h3>
<p>In horizontal scaling, we run multiple instances of the application on multiple machines. Basically, we add more machines to the compute layer. This fleet of compute servers is typically fronted by a load balancer.</p>
<p>As the load increases, the compute layer is linearly scaled to cope with the load. Horizontal scaling also aids in fault tolerance; if one node dies, the others pick up the slack.</p>
<!-- -->
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>The &quot;Unit Tech Economics&quot;</div><div class="admonitionContent_BuS1"><p>Double-clicking a bit on the phrase <em>&quot;As the load typically increases, the compute layer is linearly scaled&quot;</em>: In order for this step to be efficient, it is very important to know the <strong>&quot;Unit Tech Economics&quot;</strong>.</p><p>For a given machine of a certain size (i.e., # of CPUs, RAM, Disk, and N/W bandwidth), what is the throughput that can be successfully and healthily served?</p><p>There isn&#x27;t a magic formula for this. Each application needs to be load tested with <strong>one machine</strong> to arrive at the &quot;Unit Tech Economics.&quot; Once you have these numbers, all you need to do is extrapolate them to the actual load anticipated in production or during peak hours.</p></div></div>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>The &quot;Infinite Scale&quot; Fallacy</div><div class="admonitionContent_BuS1"><p>Does this mean that with horizontal scaling of the API servers you can achieve infinite scale? <strong>Not really.</strong></p><p>What about your downstream systems, caches, and DBs? Will they be able to serve the spiked-up load? <strong>NO.</strong></p><p>When scaling, one should adopt the <strong>bottoms-up approach</strong>. Scaling API servers should ideally be the last component to be scaled up.</p></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="deep-dive-scaling-the-database">Deep Dive: Scaling the Database<a href="#deep-dive-scaling-the-database" class="hash-link" aria-label="Direct link to Deep Dive: Scaling the Database" title="Direct link to Deep Dive: Scaling the Database" translate="no">​</a></h2>
<p>With this context set, let&#x27;s go deep into the scaling aspects of DBs (stateful components).</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-vertical-scaling">1. Vertical Scaling<a href="#1-vertical-scaling" class="hash-link" aria-label="Direct link to 1. Vertical Scaling" title="Direct link to 1. Vertical Scaling" translate="no">​</a></h3>
<p>As explained above, with vertical scaling—without splitting your DB instance—you typically host your DB on a bigger server, i.e., a machine with more capacity in terms of CPU, Memory, Disk, and Network. Basically, you run your DB on a bulkier server.</p>
<!-- -->
<blockquote>
<p><strong>Real World Example: Zerodha</strong>
One of India&#x27;s largest stock brokers, famously scaled their massive volume by avoiding premature distributed complexity. They run their core systems on a <strong>single, massive Postgres Server</strong>.</p>
<p><strong>Summary:</strong> Instead of rushing to sharding, Zerodha focused on optimizing queries and utilizing high-end hardware.</p>
<ul>
<li class=""><strong>How:</strong> They use high-performance hardware (huge RAM to fit working sets in memory) and optimized Postgres configurations.</li>
<li class=""><strong>Pros:</strong> Simplifies architecture (no distributed transactions), ensures strict ACID compliance, and offers low latency.</li>
<li class=""><strong>Cons:</strong> It is a Single Point of Failure (SPOF) if not HA, and restart times can be long due to the sheer size of memory buffers.</li>
</ul>
<p><em>Read more: <a href="https://zerodha.tech/blog/working-with-postgresql/" target="_blank" rel="noopener noreferrer" class="">Zerodha Tech Blog: Working with PostgreSQL</a></em></p>
</blockquote>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-adding-read-replicas">2. Adding Read Replicas<a href="#2-adding-read-replicas" class="hash-link" aria-label="Direct link to 2. Adding Read Replicas" title="Direct link to 2. Adding Read Replicas" translate="no">​</a></h3>
<p>In this approach, you provision for serving read traffic. Basically, you add one or more DB servers that specifically serve read traffic. This approach helps in reserving the primary node of the DB for writes, effectively isolating read and write traffic.</p>
<!-- -->
<p>In terms of reading from the application standpoint, the application need not know about multiple servers. It can leverage a couple of solutions to simplify reader connection management:</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="a-reader-endpoint-aws-aurora--rds">a) Reader Endpoint (AWS Aurora / RDS)<a href="#a-reader-endpoint-aws-aurora--rds" class="hash-link" aria-label="Direct link to a) Reader Endpoint (AWS Aurora / RDS)" title="Direct link to a) Reader Endpoint (AWS Aurora / RDS)" translate="no">​</a></h4>
<p>If you are using AWS Aurora or RDS, you can leverage the <strong>Reader Endpoint</strong>. A reader endpoint is a DNS record exposed by AWS. The application simply connects to this endpoint.</p>
<p>At a high level, one can visualize the reader endpoint as a load balancer sitting in front of the DB readers. It distributes these read requests fairly amongst the available readers.</p>
<!-- -->
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="b-rds-proxy">b) RDS Proxy<a href="#b-rds-proxy" class="hash-link" aria-label="Direct link to b) RDS Proxy" title="Direct link to b) RDS Proxy" translate="no">​</a></h4>
<p><strong>What is RDS Proxy?</strong>
Amazon RDS Proxy is a fully managed, highly available database proxy that sits between your application and your relational database.</p>
<p><strong>Use Cases:</strong></p>
<ol>
<li class=""><strong>Connection Pooling:</strong> It maintains a pool of established connections to your database, sharing them among application requests. This is crucial for serverless applications (like Lambda) that might open thousands of connections quickly.</li>
<li class=""><strong>Resiliency:</strong> It reduces failover times by bypassing DNS cache propagation delays.</li>
</ol>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-sharding">3. Sharding<a href="#3-sharding" class="hash-link" aria-label="Direct link to 3. Sharding" title="Direct link to 3. Sharding" translate="no">​</a></h3>
<p>Sharding is <strong>not</strong> a Day 0 approach. You typically do this when you know the user and data volume will exceed the capacity of a vertically scaled single node.</p>
<p>In Sharding, you split the data across multiple primary shards.</p>
<!-- -->
<p><strong>How do you decide where data resides?</strong></p>
<ol>
<li class=""><strong>Range-Based Mapping:</strong>
<ul>
<li class="">Assume you are a platform serving millions of tenants. You might say: Tenants starting with <code>a-j</code> reside in Shard 1, <code>k-t</code> in Shard 2, and <code>u-z</code> in Shard 3.</li>
</ul>
</li>
<li class=""><strong>Static Mapping:</strong>
<ul>
<li class="">In this approach, you maintain a static mapping (lookup table) between tenants and DB shards. E.g., Tenant 1 maps to Shard 1, Tenant 2 maps to Shard 1, Tenant 3 maps to Shard 2, etc.</li>
</ul>
</li>
</ol>
<p><strong>Where do you host this mapping logic?</strong></p>
<ol>
<li class="">
<p><strong>Application Layer</strong></p>
<ul>
<li class="">We make the application &quot;shard aware.&quot; The application <strong>KNOWS</strong> the DB topology and determines which shard a given tenant resides in.</li>
<li class="">The application then connects to the respective DB shard to perform reads and writes.</li>
</ul>
</li>
<li class="">
<p><strong>External Layer (Smart Proxy)</strong></p>
<ul>
<li class="">Instead of the application knowing the topology, a proxy layer <strong>KNOWS</strong> the DB topology.</li>
<li class="">You configure server rules and query rules in the proxy layer. Based on the incoming query, the proxy routes the request to the correct DB shard.</li>
</ul>
</li>
</ol>
<p><em>I have written separate blogs on <a class="" href="/docs/blog/application-level-sharding-design">Shard Aware Applications</a> and <a class="" href="/docs/blog/proxy-server">Exteral DB Proxy</a> to go really deep into BOTH the above techniques (Application vs. Proxy sharding).</em></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/docs/blog/avoid-hard-deletes">A Deep Dive into Database Storage Engines and Soft Deletion Strategies.</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-12-11T12:26:27.000Z">December 11, 2025</time> · <!-- -->19 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/docs/blog/authors/ashish"><img class="avatar__photo authorImage_XqGP" src="https://github.com/arathod02.png" alt="Ashish Rathod"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/docs/blog/authors/ashish"><span class="authorName_yefp" translate="no">Ashish Rathod</span></a></div><small class="authorTitle_nd0D" title="Ex-Intuit Staff Engineer">Ex-Intuit Staff Engineer</small><div class="authorSocials_rSDt"><a href="https://www.linkedin.com/in/ashish-rathod02/" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" preserveAspectRatio="xMidYMid" viewBox="0 0 256 256" style="--dark:#0a66c2;--light:#ffffffe6" class="authorSocialIcon_XYv3 linkedinSvg_FCgI"><path d="M218.123 218.127h-37.931v-59.403c0-14.165-.253-32.4-19.728-32.4-19.756 0-22.779 15.434-22.779 31.369v60.43h-37.93V95.967h36.413v16.694h.51a39.907 39.907 0 0 1 35.928-19.733c38.445 0 45.533 25.288 45.533 58.186l-.016 67.013ZM56.955 79.27c-12.157.002-22.014-9.852-22.016-22.009-.002-12.157 9.851-22.014 22.008-22.016 12.157-.003 22.014 9.851 22.016 22.008A22.013 22.013 0 0 1 56.955 79.27m18.966 138.858H37.95V95.967h37.97v122.16ZM237.033.018H18.89C8.58-.098.125 8.161-.001 18.471v219.053c.122 10.315 8.576 18.582 18.89 18.474h218.144c10.336.128 18.823-8.139 18.966-18.474V18.454c-.147-10.33-8.635-18.588-18.966-18.453"></path></svg></a><a href="https://github.com/arathod02" target="_blank" rel="noopener noreferrer" class="authorSocialLink_owbf" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 250" preserveAspectRatio="xMidYMid" style="--dark:#000;--light:#fff" class="authorSocialIcon_XYv3 githubSvg_Uu4N"><path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z"></path></svg></a></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary" translate="no">​</a></h2>
<p>In the discipline of database architecture, the mechanism of deletion is frequently underestimated. While the creation and retrieval of data receive significant attention regarding optimization and structure, the removal of data—specifically the &quot;Hard Delete&quot;—is often treated as a trivial housekeeping operation. However, an exhaustive analysis of storage engine internals reveals that hard deletion is one of the most resource-intensive and structurally disruptive operations in a relational database management system (RDBMS).</p>
<p>This report provides a comprehensive technical analysis of the storage engines underpinning major databases, specifically MySQL&#x27;s InnoDB and PostgreSQL&#x27;s Heap architecture. It articulates the high costs associated with physical record removal, including B+ Tree rebalancing, locking contention, input/output (I/O) thrashing, and vacuum-induced bloat. Consequently, this document advocates for a &quot;Soft Delete by Design&quot; methodology, treating deletion as a logical state transition rather than a physical storage event. It concludes with a robust lifecycle management strategy that couples logical soft deletion with asynchronous, batched hard deletion to maintain long-term storage hygiene without compromising system stability.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-storage-engine-internals">1. Storage Engine Internals<a href="#1-storage-engine-internals" class="hash-link" aria-label="Direct link to 1. Storage Engine Internals" title="Direct link to 1. Storage Engine Internals" translate="no">​</a></h2>
<p>To comprehend the catastrophic potential of a hard delete, one must first possess a nuanced understanding of how data resides on the disk. The abstraction of a &quot;table&quot; composed of &quot;rows&quot; and &quot;columns&quot; is a logical convenience; the physical reality is a complex arrangement of binary pages, pointers, and trees.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="11-mysql-innodb-the-index-organized-table"><strong>1.1 MySQL InnoDB: The Index-Organized Table</strong><a href="#11-mysql-innodb-the-index-organized-table" class="hash-link" aria-label="Direct link to 11-mysql-innodb-the-index-organized-table" title="Direct link to 11-mysql-innodb-the-index-organized-table" translate="no">​</a></h3>
<p>In the MySQL ecosystem, the default storage engine is InnoDB. Its defining characteristic is that it does not merely use an index to find data; the table <em>is</em> the index. This architecture is known as a Clustered Index, implemented via a B+ Tree data structure.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="111-the-b-tree-hierarchythe-lifecycle-strategy"><strong>1.1.1 The B+ Tree Hierarchy</strong>The Lifecycle Strategy<a href="#111-the-b-tree-hierarchythe-lifecycle-strategy" class="hash-link" aria-label="Direct link to 111-the-b-tree-hierarchythe-lifecycle-strategy" title="Direct link to 111-the-b-tree-hierarchythe-lifecycle-strategy" translate="no">​</a></h4>
<p>The B+ Tree is a self-balancing tree structure designed to maintain sorted data and allow searches, sequential access, insertions, and deletions in logarithmic time. It is distinct from a binary tree in its high fan-out; a single node can have hundreds of children, allowing the tree to remain incredibly shallow (usually 3 to 4 levels deep) even for tables containing billions of rows.</p>
<ul>
<li class=""><strong>The Root Page:</strong> The entry point of the tree. It resides at a fixed location and contains pointers to internal nodes.</li>
<li class=""><strong>Internal Nodes (Non-Leaf):</strong> These nodes act as the navigational roadmap. They contain only the Primary Key values and pointers to child pages. Because they do not store the full row data, they are lightweight. A single 16KB page can store hundreds of keys, maximizing the &quot;fan-out&quot; capability and ensuring that traversing the tree requires minimal disk I/O.</li>
<li class=""><strong>Leaf Nodes (The Data):</strong> This is where the physical reality of the Clustered Index becomes apparent. The leaf nodes contain the actual row data—every column of every record.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="112-primary-key-ordering-in-leaf-nodes"><strong>1.1.2 Primary Key Ordering in Leaf Nodes</strong><a href="#112-primary-key-ordering-in-leaf-nodes" class="hash-link" aria-label="Direct link to 112-primary-key-ordering-in-leaf-nodes" title="Direct link to 112-primary-key-ordering-in-leaf-nodes" translate="no">​</a></h4>
<p>A critical architectural feature of InnoDB is that the leaf nodes are strictly ordered by the Primary Key. This is not a suggestion; it is a physical enforcement. If a table has a Primary Key of ID, the row with ID=1 is physically stored adjacent to ID=2 within the 16KB page.</p>
<p>Furthermore, these leaf nodes are strictly linked in a doubly linked list. Each leaf page contains a pointer to the previous page and the next page. This structure enables the database to perform extremely fast range scans (e.g., SELECT * FROM orders WHERE id BETWEEN 100 AND 200) by traversing the linked list rather than returning to the root node.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="113-page-filling-and-fragmentation"><strong>1.1.3 Page Filling and Fragmentation</strong><a href="#113-page-filling-and-fragmentation" class="hash-link" aria-label="Direct link to 113-page-filling-and-fragmentation" title="Direct link to 113-page-filling-and-fragmentation" translate="no">​</a></h4>
<p>InnoDB manages storage in units called Pages, typically 16KB in size. When records are inserted sequentially (e.g., using an auto-incrementing integer), InnoDB fills these pages efficiently, leaving only a small fraction (typically 1/16th) free for future modifications. This results in a &quot;Fill Factor&quot; of nearly 100%, ensuring optimal disk usage and cache efficiency.</p>
<p>However, when data is modified or deleted, this order is disturbed. A hard delete creates a physical &quot;hole&quot; in the page. If enough holes are created, the page density drops, leading to fragmentation—a state where the database engine is caching and reading pages that are largely empty air.</p>
<p><strong>Table 1: B+ Tree Node Characteristics</strong></p>
<table><thead><tr><th style="text-align:left">Node Type</th><th style="text-align:left">Content</th><th style="text-align:left">Purpose</th><th style="text-align:left">Density</th></tr></thead><tbody><tr><td style="text-align:left"><strong>Internal Node</strong></td><td style="text-align:left">Primary Keys + Child Pointers</td><td style="text-align:left">Navigation</td><td style="text-align:left">High (Keys only)</td></tr><tr><td style="text-align:left"><strong>Leaf Node</strong></td><td style="text-align:left">Full Row Data</td><td style="text-align:left">Storage</td><td style="text-align:left">Variable (Depends on Row Size)</td></tr><tr><td style="text-align:left"><strong>Leaf Linkage</strong></td><td style="text-align:left">Double Pointers (Prev/Next)</td><td style="text-align:left">Range Scans</td><td style="text-align:left">N/A</td></tr></tbody></table>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="12-postgresql-the-heap-and-tuple-architecture"><strong>1.2 PostgreSQL: The Heap and Tuple Architecture</strong><a href="#12-postgresql-the-heap-and-tuple-architecture" class="hash-link" aria-label="Direct link to 12-postgresql-the-heap-and-tuple-architecture" title="Direct link to 12-postgresql-the-heap-and-tuple-architecture" translate="no">​</a></h3>
<p>PostgreSQL employs a fundamentally different storage paradigm known as the Heap. Unlike InnoDB, where the table is the index, PostgreSQL separates the table storage (the Heap) from the index storage.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="121-heap-pages-and-item-pointers"><strong>1.2.1 Heap Pages and Item Pointers</strong><a href="#121-heap-pages-and-item-pointers" class="hash-link" aria-label="Direct link to 121-heap-pages-and-item-pointers" title="Direct link to 121-heap-pages-and-item-pointers" translate="no">​</a></h4>
<p>In PostgreSQL, data is stored in a file known as the &quot;Heap.&quot; This file is divided into fixed-length blocks, typically 8KB. Within these blocks, records (referred to as &quot;tuples&quot;) are stored in an unordered fashion. A tuple is inserted into the first page that has sufficient free space, regardless of its Primary Key value.</p>
<p>This lack of inherent order necessitates a mechanism to locate data. PostgreSQL uses the Tuple Identifier (TID), often referred to as ctid. The ctid is a coordinate pair: (Block Number, Offset Number). For example, (42, 7) means the 7th item on the 42nd page.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="122-the-array-of-line-pointers"><strong>1.2.2 The Array of Line Pointers</strong><a href="#122-the-array-of-line-pointers" class="hash-link" aria-label="Direct link to 122-the-array-of-line-pointers" title="Direct link to 122-the-array-of-line-pointers" translate="no">​</a></h4>
<p>To manage the internal organization of an 8KB page, PostgreSQL uses an array of &quot;Line Pointers&quot; (ItemIds) at the beginning of the page header.</p>
<ul>
<li class=""><strong>Indirection:</strong> The ctid actually points to a Line Pointer, not the tuple itself. The Line Pointer then points to the byte offset where the tuple begins within the page.</li>
<li class=""><strong>Why Indirection Matters:</strong> This allows the database to defragment the page internally (move tuples around to close gaps) without changing the ctid or updating external indexes. As long as the Line Pointer at index 7 remains, the tuple can be anywhere in the page.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="123-ordered-indexes-vs-unordered-heap"><strong>1.2.3 Ordered Indexes vs. Unordered Heap</strong><a href="#123-ordered-indexes-vs-unordered-heap" class="hash-link" aria-label="Direct link to 123-ordered-indexes-vs-unordered-heap" title="Direct link to 123-ordered-indexes-vs-unordered-heap" translate="no">​</a></h4>
<p>It is a common misconception that PostgreSQL tables are ordered by Primary Key. They are not. The Heap is unordered.8 However, the <strong>Primary Key Index</strong> is a B-Tree structure that <em>is</em> strictly ordered. This index stores the Primary Key value and the corresponding ctid of the heap tuple. When a query requests a row by ID, the engine searches the ordered B-Tree Index, finds the ctid, and then retrieves the unordered tuple from the Heap.</p>
<p><strong>Table 2: Comparison of Storage Architectures</strong></p>
<table><thead><tr><th style="text-align:left">Feature</th><th style="text-align:left">MySQL InnoDB (B+ Tree)</th><th style="text-align:left">PostgreSQL (Heap)</th></tr></thead><tbody><tr><td style="text-align:left"><strong>Organization</strong></td><td style="text-align:left">Clustered (Data is in the Index)</td><td style="text-align:left">Heap (Data is separate from Index)</td></tr><tr><td style="text-align:left"><strong>Ordering</strong></td><td style="text-align:left">Physically ordered by Primary Key</td><td style="text-align:left">Unordered (Insert order / Random)</td></tr><tr><td style="text-align:left"><strong>Row ID</strong></td><td style="text-align:left">Primary Key</td><td style="text-align:left">CTID (Block + Offset)</td></tr><tr><td style="text-align:left"><strong>Secondary Index</strong></td><td style="text-align:left">Points to Primary Key Value</td><td style="text-align:left">Points to CTID</td></tr><tr><td style="text-align:left"><strong>Page Size</strong></td><td style="text-align:left">16KB (Default)</td><td style="text-align:left">8KB (Default)</td></tr></tbody></table>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-the-pain-caused-by-hard-deletion">2. The pain caused by Hard Deletion<a href="#2-the-pain-caused-by-hard-deletion" class="hash-link" aria-label="Direct link to 2. The pain caused by Hard Deletion" title="Direct link to 2. The pain caused by Hard Deletion" translate="no">​</a></h2>
<p>With the storage context established, we can analyze the mechanics of the DELETE command. Far from a simple erasure, a hard delete triggers a complex sequence of internal operations that can destabilize the database.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="21-mysql-innodb-the-rebalancing-storm"><strong>2.1 MySQL InnoDB: The Rebalancing Storm</strong><a href="#21-mysql-innodb-the-rebalancing-storm" class="hash-link" aria-label="Direct link to 21-mysql-innodb-the-rebalancing-storm" title="Direct link to 21-mysql-innodb-the-rebalancing-storm" translate="no">​</a></h3>
<p>In a B+ Tree, structural integrity is paramount. The tree must remain balanced to ensure predictable performance. Deleting a row threatens this balance.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="211-the-search-and-destroy-mission"><strong>2.1.1 The Search and Destroy Mission</strong><a href="#211-the-search-and-destroy-mission" class="hash-link" aria-label="Direct link to 211-the-search-and-destroy-mission" title="Direct link to 211-the-search-and-destroy-mission" translate="no">​</a></h4>
<p>When a DELETE is issued, InnoDB must first traverse the tree to locate the leaf node containing the record. Once found, the record is not immediately wiped; it is &quot;delete-marked.&quot; This is a logical flag in the record header indicating the space is technically free but occupied by a &quot;ghost&quot;.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="212-the-merge-threshold"><strong>2.1.2 The Merge Threshold</strong><a href="#212-the-merge-threshold" class="hash-link" aria-label="Direct link to 212-the-merge-threshold" title="Direct link to 212-the-merge-threshold" translate="no">​</a></h4>
<p>The true cost arises when deletions accumulate. Each page has a MERGE_THRESHOLD, typically defaulting to 50%.</p>
<ol>
<li class=""><strong>Underflow:</strong> If a deletion causes the page&#x27;s data volume to drop below this threshold, InnoDB determines that the page is inefficient.</li>
<li class=""><strong>Locking:</strong> The engine places locks on the page and its neighbors (sibling nodes).</li>
<li class=""><strong>Merge Operation:</strong> It attempts to merge the remaining records into a sibling page (left or right).</li>
<li class=""><strong>Cascading Reparenting:</strong> If a page is emptied and removed, the pointer in the <em>parent</em> node must be deleted. If this deletion causes the <em>parent</em> node to drop below its own threshold, the merge operation propagates upward. This &quot;rebalancing storm&quot; can ripple up to the root, causing massive I/O and locking overhead.</li>
</ol>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="213-secondary-index-maintenance"><strong>2.1.3 Secondary Index Maintenance</strong><a href="#213-secondary-index-maintenance" class="hash-link" aria-label="Direct link to 213-secondary-index-maintenance" title="Direct link to 213-secondary-index-maintenance" translate="no">​</a></h4>
<p>Every secondary index in InnoDB stores the Primary Key as its pointer. If you delete a user with ID=100, Email=<a href="mailto:bob@test.com" target="_blank" rel="noopener noreferrer" class="">bob@test.com</a>, and Status=Active, InnoDB must:</p>
<ol>
<li class="">Delete 100 from the Clustered Index (B+ Tree).</li>
<li class="">Delete <a href="mailto:bob@test.com" target="_blank" rel="noopener noreferrer" class="">bob@test.com</a> from the Email Index (B+ Tree).</li>
<li class="">Delete Active from the Status Index (B+ Tree).<br>
<!-- -->Each of these requires random I/O operations. While the Change Buffer helps mitigate this for non-unique indexes by caching changes, unique indexes require immediate, synchronous disk operations to enforce constraints, amplifying the I/O cost significantly.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="22-postgresql"><strong>2.2 PostgreSQL</strong><a href="#22-postgresql" class="hash-link" aria-label="Direct link to 22-postgresql" title="Direct link to 22-postgresql" translate="no">​</a></h3>
<p>PostgreSQL handles deletion via Multi-Version Concurrency Control (MVCC). It does not remove data immediately; it versions it.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="221-the-invisible-update"><strong>2.2.1 The Invisible Update</strong><a href="#221-the-invisible-update" class="hash-link" aria-label="Direct link to 221-the-invisible-update" title="Direct link to 221-the-invisible-update" translate="no">​</a></h4>
<p>In PostgreSQL, an UPDATE is effectively a DELETE followed by an INSERT. A DELETE is simply an UPDATE that puts nothing back.</p>
<ul>
<li class=""><strong>xmin and xmax:</strong> Every tuple has an xmin (the transaction ID that created it) and an xmax (the transaction ID that deleted it).</li>
<li class=""><strong>Marking as Dead:</strong> When DELETE is run, Postgres finds the tuple and sets its xmax to the current transaction ID. The data remains physically on the disk.</li>
<li class=""><strong>Visibility Rules:</strong> Future transactions check the xmax. If xmax is set and committed, the tuple is invisible. To the storage engine, the page looks exactly the same as before, but the tuple is logically dead.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="222-the-vacuum-necessity"><strong>2.2.2 The Vacuum Necessity</strong><a href="#222-the-vacuum-necessity" class="hash-link" aria-label="Direct link to 222-the-vacuum-necessity" title="Direct link to 222-the-vacuum-necessity" translate="no">​</a></h4>
<p>Since DELETE does not free space, the table size does not decrease. It creates &quot;Dead Tuples.&quot; If these are not cleaned up, the table becomes &quot;bloated&quot;—a mixture of live data and digital corpses.</p>
<ul>
<li class=""><strong>Autovacuum:</strong> The autovacuum daemon runs in the background. It scans tables, looking for dead tuples that are older than any active transaction.</li>
<li class=""><strong>Freeing Space:</strong> It marks the line pointers as &quot;unused,&quot; allowing new inserts to overwrite the dead space. However, this process consumes CPU and I/O bandwidth and can block schema changes.</li>
</ul>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-the-performance-impact-of-hard-deletion">3. The Performance Impact of Hard Deletion<a href="#3-the-performance-impact-of-hard-deletion" class="hash-link" aria-label="Direct link to 3. The Performance Impact of Hard Deletion" title="Direct link to 3. The Performance Impact of Hard Deletion" translate="no">​</a></h2>
<p>The internal mechanics described above manifest as tangible performance degradation in production environments. The impact of hard deletes is rarely linear; it is exponential relative to the volume of data and concurrency of the system.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="31-the-locking-bottleneck"><strong>3.1 The Locking Bottleneck</strong><a href="#31-the-locking-bottleneck" class="hash-link" aria-label="Direct link to 31-the-locking-bottleneck" title="Direct link to 31-the-locking-bottleneck" translate="no">​</a></h3>
<p>Hard deletes are blocking operations.</p>
<ul>
<li class=""><strong>Gap Locks (MySQL):</strong> To preserve transaction isolation (specifically to prevent &quot;Phantom Reads&quot;), InnoDB places &quot;Gap Locks&quot; on the space <em>between</em> records. If you delete ID=10, InnoDB might lock the gap from ID=5 to ID=15. Any other transaction trying to insert ID=12 will be blocked until the delete commits. In high-concurrency systems, this leads to lock contention and &quot;Lock Wait Timeout Exceeded&quot; errors.</li>
<li class=""><strong>Exclusive Locks:</strong> Both engines take exclusive locks on the specific rows being deleted. If a reporting query is reading those rows, the delete will block (or vice versa), causing system stutter.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="32-io-thrashing-and-buffer-pool-pollution"><strong>3.2 I/O Thrashing and Buffer Pool Pollution</strong><a href="#32-io-thrashing-and-buffer-pool-pollution" class="hash-link" aria-label="Direct link to 32-io-thrashing-and-buffer-pool-pollution" title="Direct link to 32-io-thrashing-and-buffer-pool-pollution" translate="no">​</a></h3>
<p>Database performance relies heavily on caching &quot;hot&quot; pages in RAM (Buffer Pool).</p>
<ul>
<li class=""><strong>Random Access:</strong> Hard deletes are often random (e.g., deleting users who cancelled today). This forces the database to load widely scattered pages from the disk into memory just to mark a single bit.</li>
<li class=""><strong>Dirty Pages:</strong> Modifying a page marks it as &quot;dirty.&quot; Dirty pages must be flushed back to disk. A massive delete operation creates a flood of dirty pages, saturating the I/O subsystem and slowing down critical read operations.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="33-index-bloat-and-degradation"><strong>3.3 Index Bloat and Degradation</strong><a href="#33-index-bloat-and-degradation" class="hash-link" aria-label="Direct link to 33-index-bloat-and-degradation" title="Direct link to 33-index-bloat-and-degradation" translate="no">​</a></h3>
<ul>
<li class=""><strong>Postgres Index Bloat:</strong> In PostgreSQL, indexes contain pointers to heap tuples. When a tuple is updated or deleted, the index entry remains until Vacuum runs. If a table is heavily churned (high delete/update rate), the indexes can grow larger than the table itself. Larger indexes equate to slower searches, as they are less likely to fit in RAM.</li>
<li class=""><strong>MySQL Fragmentation:</strong> As described in Section 2.1.2, B+ Tree pages that are 50-60% full are inefficient. This fragmentation means that to read 1GB of actual data, the engine might need to read 2GB of disk pages, effectively halving the I/O throughput.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-the-architectural-solution-soft-deletion">4. The Architectural Solution: Soft Deletion<a href="#4-the-architectural-solution-soft-deletion" class="hash-link" aria-label="Direct link to 4. The Architectural Solution: Soft Deletion" title="Direct link to 4. The Architectural Solution: Soft Deletion" translate="no">​</a></h2>
<p>The &quot;Soft Delete&quot; pattern solves the physical storage problems by decoupling the <strong>business intent</strong> of deletion from the <strong>database mechanism</strong> of deletion. Instead of instructing the storage engine to perform a destructive structural change, the application performs a non-structural state change.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="41-implementation-patterns"><strong>4.1 Implementation Patterns</strong><a href="#41-implementation-patterns" class="hash-link" aria-label="Direct link to 41-implementation-patterns" title="Direct link to 41-implementation-patterns" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="411-the-boolean-flag"><strong>4.1.1 The Boolean Flag</strong><a href="#411-the-boolean-flag" class="hash-link" aria-label="Direct link to 411-the-boolean-flag" title="Direct link to 411-the-boolean-flag" translate="no">​</a></h4>
<p>The simplest implementation is a boolean column.</p>
<ul>
<li class=""><strong>Schema:</strong> is_deleted BOOLEAN DEFAULT FALSE</li>
<li class=""><strong>Logic:</strong> UPDATE table SET is_deleted = TRUE WHERE id = 1</li>
<li class=""><strong>Critique:</strong> While lightweight, this pattern lacks context. It tells you <em>that</em> a record was deleted, but not <em>when</em>.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="412-the-timestamp-recommended"><strong>4.1.2 The Timestamp (Recommended)</strong><a href="#412-the-timestamp-recommended" class="hash-link" aria-label="Direct link to 412-the-timestamp-recommended" title="Direct link to 412-the-timestamp-recommended" translate="no">​</a></h4>
<p>The industry standard pattern involves a nullable timestamp.</p>
<ul>
<li class=""><strong>Schema:</strong> deleted_at TIMESTAMP NULL</li>
<li class=""><strong>Logic:</strong> UPDATE table SET deleted_at = NOW() WHERE id = 1</li>
<li class=""><strong>Query:</strong> SELECT * FROM table WHERE deleted_at IS NULL</li>
<li class=""><strong>Benefit:</strong> This acts as a boolean flag (Null/NotNull) while simultaneously providing an audit trail of the deletion event.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="413-the-status-enum"><strong>4.1.3 The Status Enum</strong><a href="#413-the-status-enum" class="hash-link" aria-label="Direct link to 413-the-status-enum" title="Direct link to 413-the-status-enum" translate="no">​</a></h4>
<p>For complex state machines, deletion is just one of many states.</p>
<ul>
<li class=""><strong>Schema:</strong> status VARCHAR(20) CHECK (status IN (&#x27;active&#x27;, &#x27;pending&#x27;, &#x27;archived&#x27;, &#x27;deleted&#x27;))</li>
<li class=""><strong>Benefit:</strong> Useful when &quot;deletion&quot; is part of a workflow, such as a &quot;Recycle Bin&quot; that transitions to &quot;Permanently Deleted.&quot;</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="42-why-soft-deletes-resolve-storage-issues"><strong>4.2 Why Soft Deletes Resolve Storage Issues</strong><a href="#42-why-soft-deletes-resolve-storage-issues" class="hash-link" aria-label="Direct link to 42-why-soft-deletes-resolve-storage-issues" title="Direct link to 42-why-soft-deletes-resolve-storage-issues" translate="no">​</a></h3>
<ol>
<li class=""><strong>Zero Rebalancing:</strong> Updating a deleted_at timestamp is an in-place update. In MySQL, since the Primary Key is not changing, the row does not move. The B+ Tree structure remains perfectly balanced. No page merges occur.</li>
<li class=""><strong>Preserved Sequentiality:</strong> The data remains physically adjacent. Sequential read performance is preserved.</li>
<li class=""><strong>Reduced Locking:</strong> An update to a non-indexed column (like deleted_at) generally requires only a row lock, avoiding the aggressive Gap Locks associated with structural removal.</li>
</ol>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-business-use-cases-for-soft-deletion">5. Business Use Cases for Soft Deletion<a href="#5-business-use-cases-for-soft-deletion" class="hash-link" aria-label="Direct link to 5. Business Use Cases for Soft Deletion" title="Direct link to 5. Business Use Cases for Soft Deletion" translate="no">​</a></h2>
<p>Beyond performance optimization, Soft Deletion enables critical business capabilities that Hard Deletion inherently destroys.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="51-recoverability-the-undo-button"><strong>5.1 Recoverability: The &quot;Undo&quot; Button</strong><a href="#51-recoverability-the-undo-button" class="hash-link" aria-label="Direct link to 51-recoverability-the-undo-button" title="Direct link to 51-recoverability-the-undo-button" translate="no">​</a></h3>
<p>Human error is an inevitability in software systems.</p>
<ul>
<li class=""><strong>Unintended Deletes:</strong> Users frequently delete content accidentally on mobile devices. Soft deletes allow for an immediate &quot;Undo&quot; feature without complex backup restoration.</li>
<li class=""><strong>Production Safety:</strong> Engineering history is replete with stories of developers accidentally running DELETE without a WHERE clause. With soft deletes, this catastrophe is reversible via a simple SQL UPDATE statement (UPDATE table SET deleted_at = NULL). With hard deletes, this becomes a disaster recovery scenario requiring Point-in-Time Recovery (PITR), potentially costing hours of downtime and data loss.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="52-audit-and-compliance"><strong>5.2 Audit and Compliance</strong><a href="#52-audit-and-compliance" class="hash-link" aria-label="Direct link to 52-audit-and-compliance" title="Direct link to 52-audit-and-compliance" translate="no">​</a></h3>
<p>In regulated industries, data deletion is often a legal construct rather than a physical one.</p>
<ul>
<li class=""><strong>Traceability:</strong> A deleted_at column, often paired with deleted_by_user_id, provides an immutable audit trail. Organizations can answer inquiries such as &quot;Who cancelled this order?&quot; or &quot;When was this account terminated?&quot;.</li>
<li class=""><strong>Legal Obligations:</strong> Depending upon the business, some regulations might mandate data retention for 7-10 years. A user&#x27;s request to &quot;delete my account&quot; must be balanced against the legal requirement to &quot;retain transaction history.&quot; Soft deletion satisfies the user&#x27;s visibility requirement while satisfying the regulator&#x27;s retention requirement.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="53-referential-integrity-and-cascading"><strong>5.3 Referential Integrity and Cascading</strong><a href="#53-referential-integrity-and-cascading" class="hash-link" aria-label="Direct link to 53-referential-integrity-and-cascading" title="Direct link to 53-referential-integrity-and-cascading" translate="no">​</a></h3>
<p>Relational databases enforce integrity via Foreign Keys. You cannot delete a Parent if it has Children.</p>
<ul>
<li class=""><strong>Hard Delete Complexity:</strong> To hard delete a User, you must first delete their Orders, Invoices, Logs, and Comments. This triggers a massive &quot;Cascading Delete&quot; transaction that can touch dozens of tables and lock millions of rows.</li>
<li class=""><strong>Soft Delete Simplicity:</strong> You simply mark the User as deleted. The child records remain untouched (and referentially valid). The application layer is responsible for filtering out &quot;Orders belonging to deleted Users&quot; during display. This avoids the massive transactional overhead of cascading deletes.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="6-disadvantages-and-engineering-trade-offs">6. Disadvantages and Engineering Trade-offs<a href="#6-disadvantages-and-engineering-trade-offs" class="hash-link" aria-label="Direct link to 6. Disadvantages and Engineering Trade-offs" title="Direct link to 6. Disadvantages and Engineering Trade-offs" translate="no">​</a></h2>
<p>Soft deletion is an architectural compromise. It solves storage and recovery issues but introduces application-layer complexity.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="61-the-forgotten-where-clause"><strong>6.1 The &quot;Forgotten WHERE Clause&quot;</strong><a href="#61-the-forgotten-where-clause" class="hash-link" aria-label="Direct link to 61-the-forgotten-where-clause" title="Direct link to 61-the-forgotten-where-clause" translate="no">​</a></h3>
<p>The most pervasive risk is query correctness.</p>
<ul>
<li class=""><strong>The Leak:</strong> Every query in the application must now include AND deleted_at IS NULL. If a developer forgets this clause in a &quot;Total Revenue&quot; report, the report will incorrectly include refunded (deleted) orders.</li>
<li class=""><strong>Mitigation:</strong>
<ul>
<li class=""><strong>ORM Scopes:</strong> Use framework features (e.g., Hibernate @Where, Eloquent SoftDeletes) to automatically inject this clause.</li>
<li class=""><strong>Views:</strong> Create a database view active_users that filters the data, and restrict application access to the view rather than the raw table.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="62-index-bloat"><strong>6.2 Index Bloat</strong><a href="#62-index-bloat" class="hash-link" aria-label="Direct link to 62-index-bloat" title="Direct link to 62-index-bloat" translate="no">​</a></h3>
<p>Soft-deleted rows are still physically present. If a table contains 90% deleted data (e.g., a queue table), the indexes will be 90% &quot;junk.&quot; This reduces the effectiveness of the RAM cache, as valuable memory is wasted storing pointers to deleted data.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="7-the-lifecycle-strategy-batch-hard-deletion">7. The Lifecycle Strategy: Batch Hard Deletion<a href="#7-the-lifecycle-strategy-batch-hard-deletion" class="hash-link" aria-label="Direct link to 7. The Lifecycle Strategy: Batch Hard Deletion" title="Direct link to 7. The Lifecycle Strategy: Batch Hard Deletion" translate="no">​</a></h2>
<p>We have established that Hard Deletes are destructive, but Soft Deletes cause unlimited growth (bloat). The optimal architecture is a hybrid lifecycle: <strong>Soft Delete for Operations, Batch Hard Delete for Maintenance.</strong></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="71-the-nightly-batch-deletion-job"><strong>7.1 The &quot;Nightly&quot; Batch Deletion Job</strong><a href="#71-the-nightly-batch-deletion-job" class="hash-link" aria-label="Direct link to 71-the-nightly-batch-deletion-job" title="Direct link to 71-the-nightly-batch-deletion-job" translate="no">​</a></h3>
<p>The goal is to decouple the high-frequency user action (clicking delete) from the high-cost database operation (physical removal).</p>
<ol>
<li class=""><strong>User Action:</strong> Soft Delete. Instant, safe, recoverable.</li>
<li class=""><strong>Retention Policy:</strong> &quot;We keep deleted data for 30 days.&quot;</li>
<li class=""><strong>Background Process:</strong> A nightly job runs during off-peak hours (e.g., 3:00 AM) to physically purge records older than 30 days.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="72-why-batching-is-superior"><strong>7.2 Why Batching is Superior</strong><a href="#72-why-batching-is-superior" class="hash-link" aria-label="Direct link to 72-why-batching-is-superior" title="Direct link to 72-why-batching-is-superior" translate="no">​</a></h3>
<ul>
<li class=""><strong>Amortized I/O:</strong> Loading a page to delete 100 records is 100x more efficient than loading that page 100 separate times to delete 1 record at a time.</li>
<li class=""><strong>Sequential Access:</strong> Batch jobs can process deletions in Primary Key order, ensuring the disk head moves linearly.</li>
<li class=""><strong>Reduced Locking:</strong> The batch job can lock a small range, perform the delete, and release the lock, minimizing impact on active users.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="73-implementation-chunked-deletion"><strong>7.3 Implementation: Chunked Deletion</strong><a href="#73-implementation-chunked-deletion" class="hash-link" aria-label="Direct link to 73-implementation-chunked-deletion" title="Direct link to 73-implementation-chunked-deletion" translate="no">​</a></h3>
<p>Running DELETE FROM logs WHERE created_at &lt; &#x27;2023-01-01&#x27; is dangerous. It will attempt to lock millions of rows, potentially crashing the database. The correct approach is <strong>Chunking</strong>.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="algorithm"><strong>Algorithm</strong><a href="#algorithm" class="hash-link" aria-label="Direct link to algorithm" title="Direct link to algorithm" translate="no">​</a></h4>
<ol>
<li class="">Identify the target rows.</li>
<li class="">Delete in small batches (e.g., 1000 rows).</li>
<li class="">Sleep/Throttle between batches to allow replication to catch up and CPU to cool down.</li>
</ol>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="mysql-example-stored-procedure"><strong>MySQL Example (Stored Procedure)</strong><a href="#mysql-example-stored-procedure" class="hash-link" aria-label="Direct link to mysql-example-stored-procedure" title="Direct link to mysql-example-stored-procedure" translate="no">​</a></h4>
<p>MySQL allows LIMIT in DELETE statements, enabling simple chunking.</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PROCEDURE</span><span class="token plain"> PurgeOldData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">REPEAT</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Delete 1000 rows, ordered by ID to maintain B-Tree locality  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> deleted\_at \</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DATE</span><span class="token plain">\_SUB</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">NOW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DAY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> id   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Sleep to prevent lock contention  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">DO</span><span class="token plain"> SLEEP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UNTIL </span><span class="token keyword" style="color:#00009f">ROW</span><span class="token plain">\_COUNT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> \</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">REPEAT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">END</span><span class="token plain">  </span><br></span></code></pre></div></div>
<p>Note: The ORDER BY id clause is critical. It ensures the deletion walks the B+ Tree leaves sequentially, preventing random I/O thrashing.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="postgresql-example-cte"><strong>PostgreSQL Example (CTE)</strong><a href="#postgresql-example-cte" class="hash-link" aria-label="Direct link to postgresql-example-cte" title="Direct link to postgresql-example-cte" translate="no">​</a></h4>
<p>PostgreSQL requires a Common Table Expression (CTE) to achieve similar chunking with lock skipping.</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> rows_to_delete </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> ctid  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> deleted_at </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NOW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTERVAL</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;30 days&#x27;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> SKIP LOCKED </span><span class="token comment" style="color:#999988;font-style:italic">-- Critical: Skip rows currently in use  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users u  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">USING</span><span class="token plain"> rows_to_delete d  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ctid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ctid</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>Note: FOR UPDATE SKIP LOCKED allows the maintenance job to run concurrently with user activity without blocking.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="74-partition-pruning"><strong>7.4 Partition Pruning</strong><a href="#74-partition-pruning" class="hash-link" aria-label="Direct link to 74-partition-pruning" title="Direct link to 74-partition-pruning" translate="no">​</a></h3>
<p>For massive datasets (e.g., Audit Logs, Event Streams), even batch deletion is too slow. The architectural solution is <strong>Table Partitioning</strong>.</p>
<ul>
<li class=""><strong>Strategy:</strong> Partition the table by date (e.g., audit_2023_01, audit_2023_02).</li>
<li class=""><strong>Deletion:</strong> When January&#x27;s data expires, you do not run DELETE. You run DROP TABLE audit_2023_01.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="8-conclusion">8. Conclusion<a href="#8-conclusion" class="hash-link" aria-label="Direct link to 8. Conclusion" title="Direct link to 8. Conclusion" translate="no">​</a></h2>
<p>The decision to adopt Soft Deletes is not merely a preference for data retention; it is a fundamental alignment with the physics of database storage engines.</p>
<ul>
<li class=""><strong>Hard Deletes</strong> operate <em>against</em> the grain of the storage engine, forcing expensive rebalancing, causing fragmentation, and introducing dangerous locking contention in OLTP systems.</li>
<li class=""><strong>Soft Deletes</strong> operate <em>with</em> the grain, converting destructive structural changes into efficient state updates. They provide the safety net required for modern applications, enabling undo capabilities, audit trails, and simplified synchronization.</li>
</ul>
<p>By implementing Soft Deletes by design, combined with a disciplined Batch Hard Delete lifecycle, architects can build systems that remain performant, recoverable, and stable under scale.</p></div><footer class="row docusaurus-mt-lg"></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/docs/blog/page/2"><div class="pagination-nav__label">Older entries</div></a></nav></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"></div></footer></div>
</body>
</html>