"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[7362],{6611:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>o});var i=s(7510),t=s(4848),r=s(8453);const l={id:"slack-realtime-architecture",title:"Designing Slack's Realtime Communication System",sidebar_label:"Slack Architecture",tags:["system-design","websocket","redis","architecture"],authors:"ashish",date:new Date("2025-12-29T00:00:00.000Z")},c=void 0,a={authorsImageUrls:[void 0]},o=[{value:"1. Categorization of Communication Systems",id:"1-categorization-of-communication-systems",level:2},{value:"The Three Scenarios",id:"the-three-scenarios",level:3},{value:"Deep Dive: Persistence vs. Delivery",id:"deep-dive-persistence-vs-delivery",level:3},{value:"1. Persistence Over Delivery (Slack/Teams)",id:"1-persistence-over-delivery-slackteams",level:4},{value:"2. Delivery Over Persistence (WhatsApp)",id:"2-delivery-over-persistence-whatsapp",level:4},{value:"3. Realtime No Persistence (Zoom Chat)",id:"3-realtime-no-persistence-zoom-chat",level:4},{value:"2. Designing the Core Schema",id:"2-designing-the-core-schema",level:2},{value:"The Naive Schema",id:"the-naive-schema",level:3},{value:"The Optimized Schema",id:"the-optimized-schema",level:3},{value:"3. Defining APIs and Protocols",id:"3-defining-apis-and-protocols",level:2},{value:"1. API to Get Messages (Scroll)",id:"1-api-to-get-messages-scroll",level:3},{value:"2. API to Send Messages",id:"2-api-to-send-messages",level:3},{value:"3. Delivering the Message (WebSockets)",id:"3-delivering-the-message-websockets",level:3},{value:"4. Scaling Websockets (Redis Pub/Sub)",id:"4-scaling-websockets-redis-pubsub",level:2},{value:"5. Naked Servers &amp; Connection Balancing",id:"5-naked-servers--connection-balancing",level:2},{value:"Final Architecture &amp; Flow Walkthrough",id:"final-architecture--flow-walkthrough",level:2},{value:"Detailed Flow Walkthrough",id:"detailed-flow-walkthrough",level:3}];function d(e){const n={admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"In this post, we will deep dive into the architecture of an enterprise-grade realtime communication system like Slack. We will categorize different communication patterns, design the database schema for performance, and evolve the system architecture from a simple REST service to a scalable, distributed websocket cluster."}),"\n",(0,t.jsx)(n.h2,{id:"1-categorization-of-communication-systems",children:"1. Categorization of Communication Systems"}),"\n",(0,t.jsxs)(n.p,{children:["Not all chat applications are built the same. The architectural choices depend heavily on the business requirements regarding ",(0,t.jsx)(n.strong,{children:"Persistence"})," (saving the message) versus ",(0,t.jsx)(n.strong,{children:"Delivery"})," (getting the message to the recipient)."]}),"\n",(0,t.jsx)(n.h3,{id:"the-three-scenarios",children:"The Three Scenarios"}),"\n",(0,t.jsx)(n.p,{children:"We can visualize the three main architectural patterns in the diagram below:"}),"\n",(0,t.jsx)(n.mermaid,{value:'flowchart TD\n    subgraph Slack ["Persistence Over Delivery (Slack)"]\n        direction TB\n        A1[Client A] --\x3e|1. REST POST| LB1[Load Balancer]\n        LB1 --\x3e Svc[Message Service]\n        Svc --\x3e|2. Write Blocking| DB[(Database)]\n        Svc -.->|3. Async Fanout| WSS1[WSS]\n    end\n\n    subgraph WhatsApp ["Delivery Over Persistence (WhatsApp)"]\n        direction TB\n        A2[Client A] <--\x3e|WebSocket| WSS2[WSS Cluster]\n        WSS2 <--\x3e|WebSocket| B2[Client B]\n        WSS2 -.->|Async Backup| Broker[Message Broker]\n        Broker -.-> DB2[(Archival DB)]\n    end\n\n    subgraph Zoom ["No Persistence (Zoom)"]\n        direction TB\n        A3[Client A] <--\x3e|WebSocket| WSS3[WSS Cluster]\n        WSS3 <--\x3e|WebSocket| B3[Client B]\n        WSS3 -.->|No Storage| Void((Void))\n    end'}),"\n",(0,t.jsx)(n.h3,{id:"deep-dive-persistence-vs-delivery",children:"Deep Dive: Persistence vs. Delivery"}),"\n",(0,t.jsx)(n.h4,{id:"1-persistence-over-delivery-slackteams",children:"1. Persistence Over Delivery (Slack/Teams)"}),"\n",(0,t.jsxs)(n.p,{children:["This is the standard for ",(0,t.jsx)(n.strong,{children:"Enterprise Grade"})," systems."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Why?"}),' In an enterprise setting, the "Source of Truth" is the server. If a user logs in from a new device, they must see the entire history. Regulatory compliance often mandates that data is never lost.']}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"The Mechanic:"})," We must guarantee the message is saved to the database ",(0,t.jsx)(n.em,{children:"before"})," we attempt to deliver it. Delivery is a secondary side-effect of persistence. If the DB write fails, the message is not sent."]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"2-delivery-over-persistence-whatsapp",children:"2. Delivery Over Persistence (WhatsApp)"}),"\n",(0,t.jsxs)(n.p,{children:["This leverages ",(0,t.jsx)(n.strong,{children:"Local Storage"}),"."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Why?"}),' Speed and Privacy. By prioritizing delivery, the app feels "snappy." The server often acts as a router.']}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"The Mechanic:"})," The delivery to the recipient is the primary goal. Persistence might happen asynchronously or only on the user's local device. If the server crashes, the message might still exist on the phones, but not in the cloud."]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"3-realtime-no-persistence-zoom-chat",children:"3. Realtime No Persistence (Zoom Chat)"}),"\n",(0,t.jsxs)(n.p,{children:["This is ",(0,t.jsx)(n.strong,{children:"Ephemeral"}),"."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Why?"})," Contextual relevance. The chat is only relevant while the video session is active."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"The Mechanic:"})," Data flows through the WebSocket server and is immediately discarded. If you join a meeting late, the history is gone because it was never saved."]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"2-designing-the-core-schema",children:"2. Designing the Core Schema"}),"\n",(0,t.jsx)(n.p,{children:"Data modeling is the foundation of scale. Let's look at how a naive approach fails and how to fix it."}),"\n",(0,t.jsx)(n.h3,{id:"the-naive-schema",children:"The Naive Schema"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Users:"})," ",(0,t.jsx)(n.code,{children:"id"}),", ",(0,t.jsx)(n.code,{children:"name"}),", ",(0,t.jsx)(n.code,{children:"email"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Channels:"})," ",(0,t.jsx)(n.code,{children:"id"}),", ",(0,t.jsx)(n.code,{children:"name"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Messages:"})," ",(0,t.jsx)(n.code,{children:"id"}),", ",(0,t.jsx)(n.code,{children:"sender_id"}),", ",(0,t.jsx)(n.code,{children:"message"}),", ",(0,t.jsx)(n.code,{children:"created_at"}),", ",(0,t.jsx)(n.code,{children:"receiver_id"})," (Nullable: set if DM)"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"The Problematic Query:"}),"\nWhen User A opens a DM with User B, we need to fetch their history:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM messages \nWHERE (receiver_id = 'B' AND sender_id = 'A') \n   OR (receiver_id = 'A' AND sender_id = 'B') \nORDER BY created_at DESC;\n"})}),"\n",(0,t.jsx)(n.admonition,{title:"Why this query fails at scale",type:"danger",children:(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"1. Complex Filtering:"})," The database engine has to evaluate ",(0,t.jsx)(n.code,{children:"OR"})," conditions involving two different columns (",(0,t.jsx)(n.code,{children:"sender_id"})," and ",(0,t.jsx)(n.code,{children:"receiver_id"}),"). This often prevents the effective use of single-column indexes, potentially leading to a ",(0,t.jsx)(n.strong,{children:"Table Scan"}),".\n",(0,t.jsx)(n.strong,{children:"2. Time Complexity:"})," If you have billions of messages, a scan is ",(0,t.jsx)(n.strong,{children:"$O(N)$"}),". Even with separate indexes, merging results for the ",(0,t.jsx)(n.code,{children:"OR"})," clause is expensive.\n",(0,t.jsx)(n.strong,{children:"3. Sorting:"})," Sorting by ",(0,t.jsx)(n.code,{children:"created_at"})," on a massive dataset without a covering index adds significant overhead."]})}),"\n",(0,t.jsx)(n.h3,{id:"the-optimized-schema",children:"The Optimized Schema"}),"\n",(0,t.jsx)(n.p,{children:"To fix this, we need to change how we view Direct Messages (DMs)."}),"\n",(0,t.jsx)(n.admonition,{title:"Insight: DM's are just Channels",type:"tip",children:(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"We portray a DM as a single channel with exactly two participants."})})}),"\n",(0,t.jsx)(n.p,{children:'By normalizing DMs into the "Channels" concept, we simplify our access patterns significantly.'}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"New Schema:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Channels:"})," ",(0,t.jsx)(n.code,{children:"id"}),", ",(0,t.jsx)(n.code,{children:"name"}),", ",(0,t.jsx)(n.code,{children:"type"})," (ENUM: 'DM', 'GROUP_CHANNEL')"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Messages:"})," ",(0,t.jsx)(n.code,{children:"id"}),", ",(0,t.jsx)(n.code,{children:"sender_id"}),", ",(0,t.jsx)(n.code,{children:"message"}),", ",(0,t.jsx)(n.code,{children:"channel_id"}),", ",(0,t.jsx)(n.code,{children:"created_at"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.em,{children:"Index:"})," ",(0,t.jsx)(n.code,{children:"CREATE INDEX idx_channel_created ON messages (channel_id, created_at);"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"The Optimized Query:"}),"\nNow, whether it is a Group Channel or a DM, the query is identical:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM messages \nWHERE channel_id = ? \nORDER BY created_at DESC \nLIMIT 20;\n"})}),"\n",(0,t.jsx)(n.admonition,{title:"Why this is faster",type:"success",children:(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"1. Index Utilization:"})," We are querying on a single column ",(0,t.jsx)(n.code,{children:"channel_id"}),". This allows the DB to use a B-Tree index to jump directly to the relevant block of data.\n",(0,t.jsx)(n.strong,{children:"2. Time Complexity:"})," The lookup becomes ",(0,t.jsx)(n.strong,{children:"$O(\\log N)$"})," (to find the channel node in the B-Tree) + ",(0,t.jsx)(n.strong,{children:"$O(K)$"})," (to read the K limit messages).\n",(0,t.jsx)(n.strong,{children:"3. Pre-sorted:"})," By including ",(0,t.jsx)(n.code,{children:"created_at"})," in the composite index, the data is already physically stored or indexed in the correct order. The DB doesn't need to perform a separate sort operation."]})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"3-defining-apis-and-protocols",children:"3. Defining APIs and Protocols"}),"\n",(0,t.jsx)(n.p,{children:"We will build the system iteratively, starting with the Persistence layer."}),"\n",(0,t.jsx)(n.h3,{id:"1-api-to-get-messages-scroll",children:"1. API to Get Messages (Scroll)"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Endpoint:"})," ",(0,t.jsx)(n.code,{children:"GET /scroll?channel_id={id}&offset={id}"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Usage:"})," Called when a user clicks a channel or scrolls up."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Architecture:"})," Simple REST call."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"2-api-to-send-messages",children:"2. API to Send Messages"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Endpoint:"})," ",(0,t.jsx)(n.code,{children:"POST /messages"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Payload:"})," ",(0,t.jsx)(n.code,{children:'{ "channel_id": "123", "message": "Hello World" }'})]}),"\n"]}),"\n",(0,t.jsxs)(n.admonition,{title:"Design Decision: REST vs WebSocket for Sending",type:"info",children:[(0,t.jsxs)(n.p,{children:["We intentionally use ",(0,t.jsx)(n.strong,{children:"REST"})," for sending messages to enforce ",(0,t.jsx)(n.strong,{children:"Persistence Over Delivery"}),"."]}),(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"The client sends a POST request."}),"\n",(0,t.jsx)(n.li,{children:"The server writes to the DB."}),"\n",(0,t.jsx)(n.li,{children:"Only on a successful DB write does the server acknowledge (200 OK) to the sender.\nThis guarantees that if the sender thinks the message is sent, it is definitely saved."}),"\n"]})]}),"\n",(0,t.jsx)(n.h3,{id:"3-delivering-the-message-websockets",children:"3. Delivering the Message (WebSockets)"}),"\n",(0,t.jsxs)(n.p,{children:["Once the message is saved via REST, we need to push it to other users in real-time. We introduce a ",(0,t.jsx)(n.strong,{children:"WebSocket Service (WSS)"}),"."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"WSS Role:"})," Maintains long-lived TCP connections with clients."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Membership Service:"})," The WSS needs to know ",(0,t.jsx)(n.em,{children:"who"})," to send the message to. It queries the Membership Service to find all users in ",(0,t.jsx)(n.code,{children:"channel_id"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Current Architecture State:"})}),"\n",(0,t.jsx)(n.mermaid,{value:"flowchart TD\n    ClientA[Client A] --\x3e|REST POST| API[Message Service]\n    API --\x3e|1. Persist| DB[(Database)]\n    API -.->|2. Push Payload| WSS[WebSocket Service]\n    WSS -.->|3. Query Members| Member[Membership Service]\n    WSS --\x3e|4. Push| ClientB[Client B]\n    WSS --\x3e|4. Push| ClientC[Client C]"}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"4-scaling-websockets-redis-pubsub",children:"4. Scaling Websockets (Redis Pub/Sub)"}),"\n",(0,t.jsx)(n.p,{children:"A single WebSocket server cannot hold millions of connections. We must scale out horizontally."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Problem:"})," If Client A is connected to ",(0,t.jsx)(n.code,{children:"WSS-1"})," and Client B is connected to ",(0,t.jsx)(n.code,{children:"WSS-2"}),", how does ",(0,t.jsx)(n.code,{children:"WSS-1"})," send a message to Client B?"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Solution:"})," Redis Pub/Sub."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"The Strategy: Channel per Workspace"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:'We create a Redis Channel for every generic Workspace (e.g., "Intuit Workspace").'}),"\n",(0,t.jsx)(n.li,{children:"All WSS instances subscribe to the Redis channels for the workspaces they are currently serving users for."}),"\n",(0,t.jsx)(n.li,{children:"The Message Service publishes the message to the specific Redis Workspace Channel."}),"\n",(0,t.jsx)(n.li,{children:"Redis fans the message out to all WSS instances subscribed to that workspace."}),"\n",(0,t.jsx)(n.li,{children:'Each WSS instance checks its local connection list: "Do I have User B?" If yes, it sends the message.'}),"\n"]}),"\n",(0,t.jsx)(n.mermaid,{value:"flowchart TD\n    subgraph Services\n    API[Message Service]\n    Redis((Redis Pub/Sub))\n    end\n\n    subgraph WSS_Layer [WebSocket Layer]\n    WSS1[WSS Node 1]\n    WSS2[WSS Node 2]\n    WSS3[WSS Node 3]\n    end\n\n    API --\x3e|1. Publish WorkspaceID| Redis\n    Redis --\x3e|2. Fanout| WSS1\n    Redis --\x3e|2. Fanout| WSS2\n    Redis --\x3e|2. Fanout| WSS3\n    \n    WSS1 --x|3. User B not here| Void1[Ignore]\n    WSS2 --\x3e|3. Found User B!| ClientB[Client B]"}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"5-naked-servers--connection-balancing",children:"5. Naked Servers & Connection Balancing"}),"\n",(0,t.jsxs)(n.p,{children:["How does a client know ",(0,t.jsx)(n.em,{children:"which"})," WSS node to connect to? We cannot expose WSS nodes directly behind a standard Load Balancer because we need sticky, long-lived connections and intelligent routing."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"The Solution: Connection Balancer"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Discovery:"})," Client calls ",(0,t.jsx)(n.code,{children:"GET /connect"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Logic:"})," The Connection Balancer checks the health and load of all WSS nodes (via a Heartbeat mechanism)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Assignment:"})," It returns the IP/URL of the best available WSS node (e.g., ",(0,t.jsx)(n.code,{children:"wss://node-5.slack.com"}),'). This is known as the "Naked Server" pattern because the client connects directly to the node, bypassing a reverse proxy for the websocket pipe.']}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Failover:"})," If ",(0,t.jsx)(n.code,{children:"node-5"})," stops sending heartbeats, the Connection Balancer marks it as unhealthy. Clients disconnected from ",(0,t.jsx)(n.code,{children:"node-5"})," will poll the Balancer again and be assigned to a new node."]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"final-architecture--flow-walkthrough",children:"Final Architecture & Flow Walkthrough"}),"\n",(0,t.jsxs)(n.p,{children:["Below is the complete system design. We have organized the architecture into logical layers to illustrate how the ",(0,t.jsx)(n.strong,{children:"REST (Sending)"})," path and ",(0,t.jsx)(n.strong,{children:"WebSocket (Receiving)"})," path operate in parallel yet converge at the data and Pub/Sub layers."]}),"\n",(0,t.jsx)(n.mermaid,{value:"flowchart TD\n    %% Styles for visual distinction\n    classDef client fill:#e1f5fe,stroke:#01579b,stroke-width:2px;\n    classDef service fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;\n    classDef infra fill:#fff3e0,stroke:#ef6c00,stroke-width:2px;\n    classDef storage fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px;\n\n    %% 1. CLIENT LAYER\n    subgraph Clients [Client Layer]\n        direction LR\n        Sender(User A: Sender):::client\n        Receiver(User B: Receiver):::client\n    end\n\n    %% 2. ENTRY LAYER\n    subgraph Entry [Entry Points]\n        LB[Load Balancer]:::service\n        CB[Connection Balancer]:::service\n    end\n\n    %% 3. SERVICE LAYER\n    subgraph Services [Service Layer]\n        direction TB\n        MsgSvc[Message Service]:::service\n        MemberSvc[Membership Service]:::service\n    end\n\n    %% 4. REALTIME LAYER\n    subgraph Realtime [Realtime Infrastructure]\n        Redis((Redis Pub/Sub)):::infra\n        \n        subgraph WSS_Cluster [Naked WebSocket Servers]\n            direction LR\n            WSS1[WSS Node 1]:::service\n            WSS2[WSS Node 2]:::service\n        end\n    end\n\n    %% 5. STORAGE LAYER\n    subgraph Data [Storage Layer]\n        DB[(Primary DB)]:::storage\n    end\n\n    %% --- CONNECTIONS & FLOWS ---\n\n    %% Flow A: Initial Connection (Blue Dotted)\n    Receiver -.->|0. Request Node IP| CB\n    CB -.->|Assign WSS-2| Receiver\n    Receiver ===|Long-lived WS Connection| WSS2\n\n    %% Flow B: Sending Message (Solid Black)\n    Sender --\x3e|1. POST /messages| LB\n    LB --\x3e MsgSvc\n    MsgSvc --\x3e|2. Write Blocking| DB\n\n    %% Flow C: Internal Fanout (Red)\n    MsgSvc --\x3e|3. Publish Event| Redis\n    Redis --\x3e|4. Fanout| WSS1\n    Redis --\x3e|4. Fanout| WSS2\n\n    %% Flow D: Delivery (Green)\n    WSS2 -.->|5. Get Members| MemberSvc\n    WSS2 --\x3e|6. Push Message| Receiver\n    \n    %% Formatting Hints\n    linkStyle 0,1 stroke:#29b6f6,stroke-width:2px,stroke-dasharray: 5 5;\n    linkStyle 2 stroke:#01579b,stroke-width:3px;\n    linkStyle 3,4,5 stroke:#333,stroke-width:2px;\n    linkStyle 6,7,8 stroke:#ef6c00,stroke-width:2px;\n    linkStyle 9 stroke:#2e7d32,stroke-width:2px,stroke-dasharray: 5 5;\n    linkStyle 10 stroke:#2e7d32,stroke-width:3px;"}),"\n",(0,t.jsx)(n.h3,{id:"detailed-flow-walkthrough",children:"Detailed Flow Walkthrough"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Connection Handshake (Blue Dotted Line):"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"User B (Receiver)"})," opens the app."]}),"\n",(0,t.jsxs)(n.li,{children:["The client polls the ",(0,t.jsx)(n.strong,{children:"Connection Balancer"})," (Step 0) to find a healthy WebSocket server."]}),"\n",(0,t.jsxs)(n.li,{children:["The Balancer assigns ",(0,t.jsx)(n.strong,{children:"WSS Node 2"}),"."]}),"\n",(0,t.jsx)(n.li,{children:'User B establishes a direct, long-lived "naked" TCP/WebSocket connection with WSS Node 2.'}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Sending (Black Path):"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"User A (Sender)"})," sends a message via ",(0,t.jsx)(n.strong,{children:"REST POST"})," to the Load Balancer (Step 1)."]}),"\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.strong,{children:"Message Service"})," writes the message to the ",(0,t.jsx)(n.strong,{children:"Primary DB"})," (Step 2)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.em,{children:"Constraint:"})," The server waits for the DB acknowledgment (",(0,t.jsx)(n.code,{children:"ACK"}),") before responding ",(0,t.jsx)(n.code,{children:"200 OK"})," to User A. This ensures ",(0,t.jsx)(n.strong,{children:"Persistence"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Internal Routing (Orange Path):"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Once persisted, the Message Service publishes an event to ",(0,t.jsx)(n.strong,{children:"Redis Pub/Sub"})," (Step 3)."]}),"\n",(0,t.jsxs)(n.li,{children:["Redis fans this message out to ",(0,t.jsx)(n.em,{children:"all"})," WebSocket Servers (Step 4) that are subscribed to the user's workspace channel."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Delivery (Green Path):"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"WSS Node 1"})," receives the event, checks its internal map, sees it has no connection for User B, and ignores it."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"WSS Node 2"})," receives the event. It queries the ",(0,t.jsx)(n.strong,{children:"Membership Service"})," (Step 5) to resolve channel members."]}),"\n",(0,t.jsx)(n.li,{children:"It identifies that it holds the active socket for User B."}),"\n",(0,t.jsxs)(n.li,{children:["It pushes the message payload down the open WebSocket connection to ",(0,t.jsx)(n.strong,{children:"User B"})," (Step 6)."]}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},7510:e=>{e.exports=JSON.parse('{"permalink":"/docs/blog/slack-design","editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/slack-design.md","source":"@site/blog/slack-design.md","title":"Designing Slack\'s Realtime Communication System","description":"In this post, we will deep dive into the architecture of an enterprise-grade realtime communication system like Slack. We will categorize different communication patterns, design the database schema for performance, and evolve the system architecture from a simple REST service to a scalable, distributed websocket cluster.","date":"2025-12-29T00:00:00.000Z","tags":[{"inline":true,"label":"system-design","permalink":"/docs/blog/tags/system-design"},{"inline":true,"label":"websocket","permalink":"/docs/blog/tags/websocket"},{"inline":true,"label":"redis","permalink":"/docs/blog/tags/redis"},{"inline":true,"label":"architecture","permalink":"/docs/blog/tags/architecture"}],"readingTime":9.18,"hasTruncateMarker":false,"authors":[{"name":"Ashish Rathod","title":"Ex-Intuit Staff Engineer","url":"https://www.linkedin.com/in/ashish-rathod02/","page":{"permalink":"/docs/blog/authors/ashish"},"socials":{"linkedin":"https://www.linkedin.com/in/ashish-rathod02/","github":"https://github.com/arathod02"},"imageURL":"https://github.com/arathod02.png","key":"ashish"}],"frontMatter":{"id":"slack-realtime-architecture","title":"Designing Slack\'s Realtime Communication System","sidebar_label":"Slack Architecture","tags":["system-design","websocket","redis","architecture"],"authors":"ashish","date":"2025-12-29T00:00:00.000Z"},"unlisted":false,"prevItem":{"title":"Avoid \\"REPLACE INTO\\"","permalink":"/docs/blog/concurrent-replace"},"nextItem":{"title":"Distributed Key-Value Store","permalink":"/docs/blog/distributed-key-value-store"}}')},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>c});var i=s(6540);const t={},r=i.createContext(t);function l(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);